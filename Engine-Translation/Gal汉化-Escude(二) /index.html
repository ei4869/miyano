<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/miyano/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/miyano/assets/apple-touch-icon.png"><link rel="alternate" href="/miyano/rss.xml" title="自分の為に楽しめ世界" type="application/rss+xml"><link rel="alternate" href="/miyano/atom.xml" title="自分の為に楽しめ世界" type="application/atom+xml"><link rel="alternate" type="application/json" title="自分の為に楽しめ世界" href="https://ei4869.github.io/miyano/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="preconnect" href="https://cloudflare-imgbed-9os.pages.dev"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext" media="none" onload="this.media='all'"><link rel="stylesheet" href="/miyano/css/app.css?v=0.4.17"><link rel="modulepreload" href="/miyano/js/chunk-424DDEWW.js"><link rel="modulepreload" href="/miyano/js/chunk-GL47M7BI.js"><link rel="modulepreload" href="/miyano/js/chunk-LOCL5DEO.js"><link rel="modulepreload" href="/miyano/js/chunk-MTLQDVVJ.js"><link rel="modulepreload" href="/miyano/js/chunk-MWLQAVNJ.js"><link rel="modulepreload" href="/miyano/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/miyano/js/comments-QIVDG7X3.js"><link rel="modulepreload" href="/miyano/js/copy-tex-W2MNAMYO.js"><link rel="modulepreload" href="/miyano/js/index.esm-3GUGPDKE.js"><link rel="modulepreload" href="/miyano/js/post-WAGXKCY2.js"><link rel="modulepreload" href="/miyano/js/quicklink-DDPSWSOQ.js"><link rel="modulepreload" href="/miyano/js/search-5ACYIQUA.js"><link rel="modulepreload" href="/miyano/js/siteInit.js"><link rel="modulepreload" href="/miyano/js/waline-NVSVNCZW.js"><link rel="stylesheet" href="/miyano/css/comments-LAB2J3GR.css" media="none" onload="this.media='all'"><link rel="stylesheet" href="/miyano/css/siteInit.css" media="none" onload="this.media='all'"><link rel="stylesheet" href="/miyano/css/waline-7JVHAYE3.css" media="none" onload="this.media='all'"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_3.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_11.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_8.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_14.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_13.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_2.webp" as="image" fetchpriority="high"><meta name="keywords" content="工具"><meta name="description" content="使用jis替换，把翻译后的简体中文汉字中无法jis显示的汉字替换为可显示的，再使用dll在游戏运行时替换回原本汉字。"><link rel="canonical" href="https://ei4869.github.io/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%BA%8C)%20/"><script>window.sakuraConfig = {
  sakura: 30,
  xSpeed: 0.5,
  ySpeed: 0.5,
  rSpeed: 0.03,
  direction: "TopRight",
  zIndex: -1
};</script><script src="https://cdn.jsdelivr.net/gh/minz71/sakura-rain/sakura-rain.js" defer="defer"></script><title>Escu:de汉化(二)——jis替换</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope="" itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Escu:de汉化(二)——jis替换</h1><div class="meta"><span class="item" title="创建时间：2025-02-17 15:34:00"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-02-17T15:34:00+08:00">2025-02-17</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>44k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>40min</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/miyano/" rel="start">Rei の 手帳</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_3.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_11.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_8.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_14.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_13.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_2.webp&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement="" itemscope="" itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/miyano/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/miyano/categories/Engine-Translation/" itemprop="item" rel="index" title="分类于引擎汉化"><span itemprop="name">引擎汉化<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://ei4869.github.io/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%BA%8C)%20/"><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/miyano/assets/ai-icon.webp"><meta itemprop="name" content="Rei"><meta itemprop="description" content=", "></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="自分の為に楽しめ世界"></span><div class="body md" itemprop="articleBody"><div class="tabs" id="summary"><div class="show-btn"></div><div class="nav"><ul class="special"></ul></div><div class="tab active" data-id="summary" data-title="自我介绍"><p>我是基于Kimi moonshot-v1-8k实现的AI助手，在此博客上负责整理和概括文章</p></div><div class="tab" data-id="summary" data-title="文章概括"><p>本文是关于如何汉化Escu:de游戏的教程。首先，使用EsucudeTools工具解包.bin和data.bin文件，生成script.db和data.db。接着，将db文件内容导出为json格式，进行翻译，并将翻译后的json写回db。然后，使用hanzi2kanji_table.txt进行汉字替换，生成translation_log.txt。之后，封包db文件回到.001和.bin文件，并替换游戏目录下的文件。最后，使用UniversalInjectorFramework工具和uif_config.json配置文件进行Jis替换，完成汉化。该方法能较好地完成大部分日文文本的汉化，运行良好。作者还提供了一个全自动汉化工具，实现一键运行。</p></div></div><details class="info"><summary>编辑记录</summary><div>
<div class="note info">
<p>2025-02-17 15:34:00 第一次编辑</p>
</div>
<ul>
<li>正文</li>
</ul>
</div></details>
<h2 id="简介"><a class="anchor" href="#简介">#</a> 简介</h2>
<p>  本文章为使 <strong>Escu:de</strong> 游戏实现汉化的教程，该方案最终会生成使 <strong>Escu:de</strong> 游戏汉化的文件。</p>
<h2 id="使用的工具"><a class="anchor" href="#使用的工具">#</a> 使用的工具</h2>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Chenx221/EscudeTools">EsucudeTools</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/xd2333/GalTransl">GalTransl</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/AtomCrafty/UniversalInjectorFramework">UniversalInjectorFramework</a></li>
</ul>
<h2 id="解包"><a class="anchor" href="#解包">#</a> 解包</h2>
<p>使用工具：<a target="_blank" rel="noopener" href="https://github.com/Chenx221/EscudeTools">EsucudeTools</a>。</p>
<ol>
<li>取出.bin 的文件</li>
</ol>
<ul>
<li>使用 <strong>EscudeTools</strong> 工具，运行命令:</li>
</ul>
<div class="tab" data-id="id1" data-title="处理script.bin">
<figure class="highlight bash"><figcaption data-lang="bash"><span>解包script.bin</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>D:<span class="token punctuation">\</span>Tool<span class="token punctuation">\</span>汉化工具<span class="token punctuation">\</span>net8.0<span class="token punctuation">\</span>EscudeTools.exe <span class="token parameter variable">-u</span> D:<span class="token punctuation">\</span>Data<span class="token punctuation">\</span>python_prj<span class="token punctuation">\</span>Escude_Translate<span class="token punctuation">\</span>script_source</pre></td></tr></tbody></table></figure><p>其中 script_source 含有 script.bin 文件。运行命令后文件解包在 script_source/output/script 中。</p>
</div>
<div class="tab" data-id="id1" data-title="处理data.bin">
<figure class="highlight bash"><figcaption data-lang="bash"><span>解包data.bin</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>D:<span class="token punctuation">\</span>Tool<span class="token punctuation">\</span>汉化工具<span class="token punctuation">\</span>net8.0<span class="token punctuation">\</span>EscudeTools.exe <span class="token parameter variable">-u</span> D:<span class="token punctuation">\</span>Data<span class="token punctuation">\</span>python_prj<span class="token punctuation">\</span>Escude_Translate<span class="token punctuation">\</span>data_source</pre></td></tr></tbody></table></figure><p>其中 data_source 含有 data.bin 文件。运行命令后文件解包在 data_source/output/data 中。</p>
</div>
<p>使用<strong> EscudeTools</strong> 工具进行解包，方便后续封包，该方式解包会生成附加的包信息文件，能封回原包。</p>
<ol start="2">
<li>处理解包的文件<br>
控制台运行命令：</li>
</ol>
<div class="tab" data-id="id2" data-title="处理script.bin">
<figure class="highlight bash"><figcaption data-lang="bash"><span>把.001文件解包为数据库db文件</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>D:<span class="token punctuation">\</span>Tool<span class="token punctuation">\</span>汉化工具<span class="token punctuation">\</span>net8.0<span class="token punctuation">\</span>EscudeTools.exe <span class="token parameter variable">-v</span> D:<span class="token punctuation">\</span>Data<span class="token punctuation">\</span>python_prj<span class="token punctuation">\</span>Escude_Translate<span class="token punctuation">\</span>script_source<span class="token punctuation">\</span>output<span class="token punctuation">\</span>script <span class="token parameter variable">-t</span> <span class="token number">1</span></pre></td></tr></tbody></table></figure><p><code>-t</code>  后的参数：</p>
<ul>
<li>类型 0: 完整，这会创建包含所有 .bin 和 .001 信息的 script.db。</li>
<li>类型 1: 只导出 001 中的文本，这会创建 script_sm.db，包含所有 .001 信息。</li>
<li>类型 2: 只导出 bin 中的文本，这会创建 script_text.db 以及大量 .dat 文件（非文本的其他数据）。</li>
</ul>
</div>
<div class="tab" data-id="id2" data-title="处理data.bin">
<figure class="highlight bash"><figcaption data-lang="bash"><span>把.bin文件解包为数据库db文件</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>D:<span class="token punctuation">\</span>Tool<span class="token punctuation">\</span>汉化工具<span class="token punctuation">\</span>net8.0<span class="token punctuation">\</span>EscudeTools.exe <span class="token parameter variable">-d</span> D:<span class="token punctuation">\</span>Data<span class="token punctuation">\</span>python_prj<span class="token punctuation">\</span>Escude_Translate<span class="token punctuation">\</span>data_source<span class="token punctuation">\</span>output<span class="token punctuation">\</span>data</pre></td></tr></tbody></table></figure></div>
<h2 id="处理db文件用于翻译"><a class="anchor" href="#处理db文件用于翻译">#</a> 处理 db 文件用于翻译</h2>
<p>方案为：读取 db 的内容写入到所需格式的 json 文件 -&gt; 翻译 json 文件的文本 -&gt; 把翻译后的 json 写回 db -&gt; 读取 db 内容，进行汉字替换 -&gt; 替换后的 db 作为最终打包文件，依次打包回到.bin</p>
<ol>
<li>读取 db 的内容写入到所需格式的 json 文件<br>
需要的 json 格式为：</li>
</ol>
<figure class="highlight json"><figcaption data-lang="JSON"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"既然是梦的話ーー那我継続齣浸其中也无妨槇。"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"「那就這樣槇」"</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">]</span></pre></td></tr></tbody></table></figure><p>导出代码为：</p>
<figure class="highlight python"><figcaption data-lang="python"><span>db导出为json</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">export_db_to_json</span><span class="token punctuation">(</span>db_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> json_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""导出 SQLite 数据库所有表的数据为 JSON（按列存储）"""</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"\n&gt;&gt;&gt; 正在从数据库导出数据到 JSON ..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    extracted_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于写入 JSON 的列表，只包含 {"message": 文本}</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT name FROM sqlite_master WHERE type='table';"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        tables <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">for</span> table_name <span class="token keyword">in</span> tables<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                table <span class="token operator">=</span> table_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT DataString FROM </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">;"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                    rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                    <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                        <span class="token keyword">if</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                            data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">except</span> sqlite3<span class="token punctuation">.</span>OperationalError <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    print_warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"跳过表 </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">global</span> mapping_json_path</pre></td></tr><tr><td data-num="24"></td><td><pre>            mapping_json_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"mapping.json"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            mapping <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>             <span class="token comment"># 内部映射列表，记录每条文本所在的表、列、rowid</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">for</span> table_tuple <span class="token keyword">in</span> tables<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                table_name <span class="token operator">=</span> table_tuple<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"处理表：</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>                <span class="token comment"># 获取表中各列名称</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"PRAGMA table_info('</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">');"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                columns_info <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># (cid, name, type, notnull, dflt_value, pk)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                column_names <span class="token operator">=</span> <span class="token punctuation">[</span>col<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> col <span class="token keyword">in</span> columns_info<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token comment"># 查询所有数据，同时获取内建 rowid</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT rowid, * FROM '</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">';"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                    current_rowid <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># rowid</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token comment"># row [1:] 与 column_names 一一对应</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                    <span class="token keyword">for</span> i<span class="token punctuation">,</span> cell <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                        <span class="token keyword">if</span> cell <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cell<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">and</span> contains_japanese<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                            extracted_messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span> cell<span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                            mapping<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                                <span class="token string">"table"</span><span class="token punctuation">:</span> table_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                                <span class="token string">"column"</span><span class="token punctuation">:</span> column_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                                <span class="token string">"rowid"</span><span class="token punctuation">:</span> current_rowid</pre></td></tr><tr><td data-num="49"></td><td><pre>                    <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"导出数据库 </span><span class="token interpolation"><span class="token punctuation">{</span>db_path<span class="token punctuation">}</span></span><span class="token string"> 时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> data_list <span class="token keyword">and</span> <span class="token keyword">not</span> extracted_messages<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string">"错误：未导出任何数据。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token keyword">if</span> data_list<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> json_file<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data_list<span class="token punctuation">,</span> json_file<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 提取完成，JSON 文件已保存到 </span><span class="token interpolation"><span class="token punctuation">{</span>json_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">if</span> extracted_messages<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token comment"># 写入仅含 "message" 的 JSON 文件，供翻译人员使用</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>extracted_messages<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token comment"># 写入映射信息到单独文件（翻译人员无需查看）</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>mapping_json_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"映射信息已保存到 </span><span class="token interpolation"><span class="token punctuation">{</span>mapping_json_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 提取完成，JSON 文件已保存到 </span><span class="token interpolation"><span class="token punctuation">{</span>json_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><div class="tab" data-id="id3" data-title="script">
<p>对于 script 的 db 文件，由于其中每个表只有一列，存储的是脚本的文本，因此只需要提取该列存到 json 即可。</p>
</div>
<div class="tab" data-id="id3" data-title="data">
<p>对于 data 的 db 文件，选择通过识别日语的文本的方式（函数 contains_japanese (text)），把含有日语的文本内容的表及对应的列提取到 json 中。并用 mapping.json 记录位置，用于后续写回原位置。</p>
</div>
<h2 id="进行翻译"><a class="anchor" href="#进行翻译">#</a> 进行翻译</h2>
<p>使用工具<a target="_blank" rel="noopener" href="https://github.com/xd2333/GalTransl"><strong> GalTransl</strong></a>，按照要求，编写字典，配置文件，完成翻译。</p>
<h2 id="把翻译后的json写回db"><a class="anchor" href="#把翻译后的json写回db">#</a> 把翻译后的 json 写回 db</h2>
<p>先复制原数据库：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">clone_db_structure</span><span class="token punctuation">(</span>src_db<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> dest_db<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""克隆原数据库结构到新数据库"""</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>dest_db<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>dest_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            shutil<span class="token punctuation">.</span>copy2<span class="token punctuation">(</span>src_db<span class="token punctuation">,</span> dest_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 数据库复制完成：</span><span class="token interpolation"><span class="token punctuation">{</span>dest_db<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            shutil<span class="token punctuation">.</span>copyfile<span class="token punctuation">(</span>src_db<span class="token punctuation">,</span> dest_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 数据库复制完成：</span><span class="token interpolation"><span class="token punctuation">{</span>dest_db<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"复制数据库结构时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><div class="note info no-icon">
<p><code>shutil.copyfile(src, dst)</code> :</p>
<ul>
<li>仅复制文件内容。</li>
<li>不复制文件的元数据（如权限、最后访问时间、最后修改时间等）。</li>
<li>适用于只需要复制文件内容的场景。</li>
</ul>
<p><code>shutil.copy2(src, dst)</code> :</p>
<ul>
<li>复制文件内容和文件的元数据。</li>
<li>适用于需要保留文件元数据的场景。</li>
</ul>
</div>
<p>把 json 写回数据库：</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">import_json_to_db</span><span class="token punctuation">(</span>db_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> json_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""将 JSON 文件中的数据写入 SQLite 数据库"""</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">global</span> mapping_json_path</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ 未找到 JSON 文件: </span><span class="token interpolation"><span class="token punctuation">{</span>json_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"读取 JSON 文件时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            messages <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> data <span class="token keyword">if</span> <span class="token string">"message"</span> <span class="token keyword">in</span> item<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT name FROM sqlite_master WHERE type='table';"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            tables <span class="token operator">=</span> <span class="token punctuation">[</span>table<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> table <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            index <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">for</span> table <span class="token keyword">in</span> tables<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT rowid FROM </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">;"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                    rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                    <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                        <span class="token keyword">if</span> index <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                            print_warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"⚠️ 翻译 JSON 数据不足，</span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string"> 表剩余行未填充"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                        translated_text <span class="token operator">=</span> messages<span class="token punctuation">[</span>index<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"UPDATE </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string"> SET DataString = ? WHERE rowid = ?"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>translated_text<span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                        index <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token keyword">except</span> sqlite3<span class="token punctuation">.</span>OperationalError <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    print_warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"⚠️ 跳过 </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>mapping_json_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                mapping <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"错误：翻译后的条目数与映射信息条目数不一致！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token keyword">return</span></pre></td></tr><tr><td data-num="41"></td><td><pre></pre></td></tr><tr><td data-num="42"></td><td><pre>            conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token comment"># 根据映射信息逐条更新对应的单元格</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">for</span> loc<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                table <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token string">"table"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                column <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token string">"column"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                rowid <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token string">"rowid"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                new_text <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>                <span class="token comment"># 使用 rowid 定位行，更新对应列</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'UPDATE "</span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">" SET "</span><span class="token interpolation"><span class="token punctuation">{</span>column<span class="token punctuation">}</span></span><span class="token string">" = ? WHERE rowid = ?;'</span></span></pre></td></tr><tr><td data-num="54"></td><td><pre>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span>new_text<span class="token punctuation">,</span> rowid<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 翻译内容已成功写入 </span><span class="token interpolation"><span class="token punctuation">{</span>db_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"导入 JSON 数据时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><h2 id="读取db内容进行汉字替换"><a class="anchor" href="#读取db内容进行汉字替换">#</a> 读取 db 内容，进行汉字替换</h2>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">load_hanzi_conversion_table</span><span class="token punctuation">(</span>txt_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""读取汉字转换表（假设以 Tab 分隔，格式：简体[TAB]繁体）"""</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    conversion_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            parts <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                conversion_dict<span class="token punctuation">[</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> conversion_dict</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">def</span> <span class="token function">load_existing_log</span><span class="token punctuation">(</span>log_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token triple-quoted-string string">"""读取已有转换日志（JSON格式）"""</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>log_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token keyword">return</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"source_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"target_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"source_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"target_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">def</span> <span class="token function">replace_hanzi</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> conversion_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> detected_changes<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token triple-quoted-string string">"""对文本进行汉字替换，并记录替换情况"""</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> text</pre></td></tr><tr><td data-num="24"></td><td><pre>    new_text <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">for</span> char <span class="token keyword">in</span> text<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">if</span> char <span class="token keyword">in</span> conversion_dict<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">if</span> char <span class="token keyword">not</span> <span class="token keyword">in</span> detected_changes<span class="token punctuation">[</span><span class="token string">"source_characters"</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                detected_changes<span class="token punctuation">[</span><span class="token string">"source_characters"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> conversion_dict<span class="token punctuation">[</span>char<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                detected_changes<span class="token punctuation">[</span><span class="token string">"target_characters"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> char</pre></td></tr><tr><td data-num="30"></td><td><pre>            new_text<span class="token punctuation">.</span>append<span class="token punctuation">(</span>conversion_dict<span class="token punctuation">[</span>char<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            new_text<span class="token punctuation">.</span>append<span class="token punctuation">(</span>char<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>new_text<span class="token punctuation">)</span> </pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token keyword">def</span> <span class="token function">process_database_text</span><span class="token punctuation">(</span>db_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> conversion_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> log_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token triple-quoted-string string">"""对数据库中所有文本字段进行汉字替换，并更新转换日志（合并新旧记录）"""</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"\n&gt;&gt;&gt; 正在进行文字替换..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT name FROM sqlite_master WHERE type='table';"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    tables <span class="token operator">=</span> <span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    detected_changes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"source_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"target_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">for</span> table <span class="token keyword">in</span> tables<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"PRAGMA table_info(</span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">);"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        columns <span class="token operator">=</span> <span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">for</span> column <span class="token keyword">in</span> columns<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT rowid, </span><span class="token interpolation"><span class="token punctuation">{</span>column<span class="token punctuation">}</span></span><span class="token string"> FROM </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">;"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token keyword">for</span> rowid<span class="token punctuation">,</span> text <span class="token keyword">in</span> rows<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    new_text <span class="token operator">=</span> replace_hanzi<span class="token punctuation">(</span>text<span class="token punctuation">,</span> conversion_dict<span class="token punctuation">,</span> detected_changes<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                    <span class="token keyword">if</span> new_text <span class="token operator">!=</span> text<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"UPDATE </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string"> SET </span><span class="token interpolation"><span class="token punctuation">{</span>column<span class="token punctuation">}</span></span><span class="token string"> = ? WHERE rowid = ?"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>new_text<span class="token punctuation">,</span> rowid<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                print_warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"跳过 </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>column<span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    existing_log <span class="token operator">=</span> load_existing_log<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    existing_source <span class="token operator">=</span> existing_log<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"source_characters"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    existing_target <span class="token operator">=</span> existing_log<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"target_characters"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    new_source <span class="token operator">=</span> detected_changes<span class="token punctuation">[</span><span class="token string">"source_characters"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    new_target <span class="token operator">=</span> detected_changes<span class="token punctuation">[</span><span class="token string">"target_characters"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> char <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>new_source<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">if</span> char <span class="token keyword">not</span> <span class="token keyword">in</span> existing_source<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            existing_source <span class="token operator">+=</span> char</pre></td></tr><tr><td data-num="66"></td><td><pre>            existing_target <span class="token operator">+=</span> new_target<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    final_log <span class="token operator">=</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token string">"source_characters"</span><span class="token punctuation">:</span> existing_source<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token string">"target_characters"</span><span class="token punctuation">:</span> existing_target</pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>log_file<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>final_log<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    print_success<span class="token punctuation">(</span><span class="token string">"✅ 文字替换完成，日志已保存到 "</span> <span class="token operator">+</span> log_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>log_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"translation_log.txt"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="76"></td><td><pre>conversion_dict <span class="token operator">=</span> load_hanzi_conversion_table<span class="token punctuation">(</span>hanzi_table_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="77"></td><td><pre>process_database_text<span class="token punctuation">(</span>new_db_path<span class="token punctuation">,</span> conversion_dict<span class="token punctuation">,</span> log_file<span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><p>读取 <code>hanzi2kanji_table.txt</code>  文件，这是一个汉字替换表。最终生成的 <code>translation_log.txt</code>  用于 <code>jis</code>  替换。</p>
<h2 id="封包"><a class="anchor" href="#封包">#</a> 封包</h2>
<ol>
<li>封包第一步</li>
</ol>
<div class="tab" data-id="id4" data-title="script">
<p>把 db 文件封包回.001 文件。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>D:<span class="token punctuation">\</span>Tool<span class="token punctuation">\</span>汉化工具<span class="token punctuation">\</span>net8.0<span class="token punctuation">\</span>EscudeTools.exe <span class="token parameter variable">-e</span> D:<span class="token punctuation">\</span>Data<span class="token punctuation">\</span>python_prj<span class="token punctuation">\</span>Escude_Translate<span class="token punctuation">\</span>script_source<span class="token punctuation">\</span>output<span class="token punctuation">\</span>cn_script_sm.db <span class="token parameter variable">-t</span> <span class="token number">1</span></pre></td></tr></tbody></table></figure><p>(这里的参数 - t 要和前面解包的 - t 对应)</p>
<ul>
<li>类型 0: 完整，这会生成 .bin 和 .001 文件。</li>
<li>类型 1: 这会生成 .001 文件。</li>
<li>类型 2: 这会生成 .bin 文件。<br>
该命令会在 Escude_Translate\script_source\output 下生成 repack 文件夹，里面有.001 文件，接下来需要把这些文件替换掉 \output\script 中对应的.001 文件。</li>
</ul>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">def</span> <span class="token function">pack_db_to_script</span><span class="token punctuation">(</span>db_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> script_db_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pack_flag<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> file_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> repack_type<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token triple-quoted-string string">"""调用 EscudeTools 打包数据库文件回脚本文件（会在 repack 文件夹内生成文件，并复制覆盖到 script 文件夹）"""</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"_staff.db"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        script_db_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_db_dir<span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        script_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_db_dir<span class="token punctuation">,</span> <span class="token string">"staff"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        script_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_db_dir<span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    command <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>pack_flag<span class="token punctuation">}</span></span><span class="token string"> "</span><span class="token interpolation"><span class="token punctuation">{</span>db_path<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>file_type<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>repack_type<span class="token punctuation">}</span></span><span class="token string">'</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    run_command<span class="token punctuation">(</span>command<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    repack_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_db_dir<span class="token punctuation">,</span> <span class="token string">"repack"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>repack_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"错误：未找到 repack 文件夹：</span><span class="token interpolation"><span class="token punctuation">{</span>repack_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>repack_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            source_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            dest_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_dir<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            shutil<span class="token punctuation">.</span>copy2<span class="token punctuation">(</span>source_file<span class="token punctuation">,</span> dest_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            print_info<span class="token punctuation">(</span><span class="token string">"替换文件："</span> <span class="token operator">+</span> dest_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 数据库文件已打包回脚本，路径在：</span><span class="token interpolation"><span class="token punctuation">{</span>script_dir<span class="token punctuation">}</span></span><span class="token string">。"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>repack_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"已移除 repack 文件夹。"</span><span class="token punctuation">)</span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id4" data-title="data">
<p>把 db 文件封包回.bin 文件。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>D:<span class="token punctuation">\</span>Tool<span class="token punctuation">\</span>汉化工具<span class="token punctuation">\</span>net8.0<span class="token punctuation">\</span>EscudeTools.exe <span class="token parameter variable">-f</span> D:<span class="token punctuation">\</span>Data<span class="token punctuation">\</span>python_prj<span class="token punctuation">\</span>Escude_Translate<span class="token punctuation">\</span>data_source<span class="token punctuation">\</span>process_db</pre></td></tr></tbody></table></figure><p>先把翻译后的 db 文件移动到 <code>data_source\process_db</code> ，该命令会在 Escude_Translate\data_source\process_db 下生成.bin 文件，接下来需要把这些文件替换掉 \output\data 中对应的.001 文件。</p>
<figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"data"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>        process_db_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>bin_folder<span class="token punctuation">,</span> <span class="token string">"process_db"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".db"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> f<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"cn_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                src <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                dst <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                print_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"移动文件 </span><span class="token interpolation"><span class="token punctuation">{</span>f<span class="token punctuation">}</span></span><span class="token string"> 到 </span><span class="token interpolation"><span class="token punctuation">{</span>process_db_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        cmd_pack_db <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'"</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>pack_flag<span class="token punctuation">}</span></span><span class="token string"> "</span><span class="token interpolation"><span class="token punctuation">{</span>process_db_dir<span class="token punctuation">}</span></span><span class="token string">"'</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>        run_command<span class="token punctuation">(</span>cmd_pack_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        target_subfolder <span class="token operator">=</span> task_dir</pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".bin"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> f<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"cn_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                old_bin_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                new_bin_name <span class="token operator">=</span> f<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                new_bin_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">,</span> new_bin_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>old_bin_path<span class="token punctuation">,</span> new_bin_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>new_bin_path<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>target_subfolder<span class="token punctuation">,</span> new_bin_name<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                print_info<span class="token punctuation">(</span><span class="token string">"处理并移动文件："</span> <span class="token operator">+</span> new_bin_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string">"✅ DB 文件打包并替换原文件完成。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span></pre></td></tr></tbody></table></figure></div>
<ol start="2">
<li>封包第二步<br>
打包为最终的.bin 文件。</li>
</ol>
<div class="tab" data-id="id5" data-title="script">
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>D:<span class="token punctuation">\</span>Tool<span class="token punctuation">\</span>汉化工具<span class="token punctuation">\</span>net8.0<span class="token punctuation">\</span>EscudeTools.exe <span class="token parameter variable">-r</span> D:<span class="token punctuation">\</span>Data<span class="token punctuation">\</span>python_prj<span class="token punctuation">\</span>Escude_Translate<span class="token punctuation">\</span>script_source<span class="token punctuation">\</span>output</pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id5" data-title="data">
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>D:<span class="token punctuation">\</span>Tool<span class="token punctuation">\</span>汉化工具<span class="token punctuation">\</span>net8.0<span class="token punctuation">\</span>EscudeTools.exe <span class="token parameter variable">-r</span> D:<span class="token punctuation">\</span>Data<span class="token punctuation">\</span>python_prj<span class="token punctuation">\</span>Escude_Translate<span class="token punctuation">\</span>data_source<span class="token punctuation">\</span>output</pre></td></tr></tbody></table></figure></div>
<p>最终得到的  <code>script.bin</code>  ,  <code>data.bin</code>  ,  <code>translation_log.txt</code>  即为汉化游戏所需的最终的文件。</p>
<h2 id="最终汉化"><a class="anchor" href="#最终汉化">#</a> 最终汉化</h2>
<ol>
<li>替换游戏目录下对应的文件</li>
<li>使用  <code>UniversalInjectorFramework</code>  工具进行 <code>Jis</code>  替换
<ul>
<li>配置  <code>uif_config.json</code>  文件，按照 <code>translation_log.txt</code>  配置 <code>"source_characters"</code>  和 <code>"target_characters"</code> 。</li>
<li>把该工具目录下的 dll 放到游戏目录，测试是否运行成功，一般先试用 <code>winmm.dll</code> ，运行成功则完成汉化。</li>
</ul>
</li>
</ol>
<h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2>
<p>通过该方式汉化，能较好地完成 <code>Escu:de</code>  引擎游戏内大部分日文文本的汉化，运行良好。</p>
<h2 id="全自动汉化工具"><a class="anchor" href="#全自动汉化工具">#</a> 全自动汉化工具</h2>
<p>整合以上流程，写了一个工具实现自动化，一键运行。<br>
 <code>color_trans2.py</code> :</p>
<figure class="highlight python"><figcaption data-lang="python"><span>ESCU:DE引擎全自动化汉化任务</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment">#!/usr/bin/env python</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># -*- coding: utf-8 -*-</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> subprocess</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> shutil</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> sqlite3</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> json</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> time</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">from</span> glob <span class="token keyword">import</span> glob</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> re</pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">from</span> pick <span class="token keyword">import</span> pick</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">except</span> ImportError<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"请安装 pick 模块：pip install pick"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">from</span> colorama <span class="token keyword">import</span> init<span class="token punctuation">,</span> Fore<span class="token punctuation">,</span> Style</pre></td></tr><tr><td data-num="22"></td><td><pre>    init<span class="token punctuation">(</span>autoreset<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">except</span> ImportError<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"请安装 colorama 模块：pip install colorama"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># Console 输出辅助函数</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">def</span> <span class="token function">print_info</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> message <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token keyword">def</span> <span class="token function">print_success</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>GREEN <span class="token operator">+</span> message <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token keyword">def</span> <span class="token function">print_error</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>RED <span class="token operator">+</span> message <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">def</span> <span class="token function">print_warning</span><span class="token punctuation">(</span>message<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>YELLOW <span class="token operator">+</span> message <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token comment"># 公共辅助函数（共用部分）</span></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">def</span> <span class="token function">run_command</span><span class="token punctuation">(</span>command<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> subprocess<span class="token punctuation">.</span>CompletedProcess<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token triple-quoted-string string">"""执行命令并打印输出，失败则退出"""</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n&gt;&gt;&gt; 执行命令: </span><span class="token interpolation"><span class="token punctuation">{</span>command<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>command<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">if</span> result<span class="token punctuation">.</span>returncode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"错误：命令执行失败！\n命令: </span><span class="token interpolation"><span class="token punctuation">{</span>command<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">return</span> result</pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">def</span> <span class="token function">clear_directory</span><span class="token punctuation">(</span>dir_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token triple-quoted-string string">"""清空目录下所有文件，目录不存在则创建"""</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        print_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"目录不存在，已创建：</span><span class="token interpolation"><span class="token punctuation">{</span>dir_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">return</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token keyword">for</span> filename <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> filename<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="64"></td><td><pre>        <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token keyword">or</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>islink<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                os<span class="token punctuation">.</span>unlink<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token keyword">elif</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="70"></td><td><pre>            print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"删除 </span><span class="token interpolation"><span class="token punctuation">{</span>file_path<span class="token punctuation">}</span></span><span class="token string"> 时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"目录 </span><span class="token interpolation"><span class="token punctuation">{</span>dir_path<span class="token punctuation">}</span></span><span class="token string"> 已清空。"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token keyword">def</span> <span class="token function">contains_japanese</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token triple-quoted-string string">"""</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    判断文本中是否包含日语字符（平假名、片假名或常用汉字）。</pre></td></tr><tr><td data-num="76"></td><td><pre>    """</pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    pattern <span class="token operator">=</span> re<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span><span class="token string">r'[\u3040-\u30FF\u4E00-\u9FFF]'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">return</span> pattern<span class="token punctuation">.</span>search<span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre><span class="token keyword">def</span> <span class="token function">export_db_to_json</span><span class="token punctuation">(</span>db_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> json_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token triple-quoted-string string">"""导出 SQLite 数据库所有表的数据为 JSON（按列存储）"""</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"\n&gt;&gt;&gt; 正在从数据库导出数据到 JSON ..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    extracted_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 用于写入 JSON 的列表，只包含 {"message": 文本}</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    data_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT name FROM sqlite_master WHERE type='table';"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="91"></td><td><pre>        tables <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token keyword">for</span> table_name <span class="token keyword">in</span> tables<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="94"></td><td><pre>                table <span class="token operator">=</span> table_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="95"></td><td><pre>                <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="96"></td><td><pre>                    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT DataString FROM </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">;"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                    rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                    <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                        <span class="token keyword">if</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                            data_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="101"></td><td><pre>                <span class="token keyword">except</span> sqlite3<span class="token punctuation">.</span>OperationalError <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                    print_warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"跳过表 </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="103"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="104"></td><td><pre>            <span class="token keyword">global</span> mapping_json_path</pre></td></tr><tr><td data-num="105"></td><td><pre>            mapping_json_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"mapping.json"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="106"></td><td><pre>            mapping <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>             <span class="token comment"># 内部映射列表，记录每条文本所在的表、列、rowid</span></pre></td></tr><tr><td data-num="107"></td><td><pre>            <span class="token keyword">for</span> table_tuple <span class="token keyword">in</span> tables<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                table_name <span class="token operator">=</span> table_tuple<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="109"></td><td><pre>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"处理表：</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre>                <span class="token comment"># 获取表中各列名称</span></pre></td></tr><tr><td data-num="112"></td><td><pre>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"PRAGMA table_info('</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">');"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="113"></td><td><pre>                columns_info <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># (cid, name, type, notnull, dflt_value, pk)</span></pre></td></tr><tr><td data-num="114"></td><td><pre>                column_names <span class="token operator">=</span> <span class="token punctuation">[</span>col<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> col <span class="token keyword">in</span> columns_info<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="115"></td><td><pre></pre></td></tr><tr><td data-num="116"></td><td><pre>                <span class="token comment"># 查询所有数据，同时获取内建 rowid</span></pre></td></tr><tr><td data-num="117"></td><td><pre>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT rowid, * FROM '</span><span class="token interpolation"><span class="token punctuation">{</span>table_name<span class="token punctuation">}</span></span><span class="token string">';"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="118"></td><td><pre>                rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre>                <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="121"></td><td><pre>                    current_rowid <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># rowid</span></pre></td></tr><tr><td data-num="122"></td><td><pre>                    <span class="token comment"># row [1:] 与 column_names 一一对应</span></pre></td></tr><tr><td data-num="123"></td><td><pre>                    <span class="token keyword">for</span> i<span class="token punctuation">,</span> cell <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="124"></td><td><pre>                        <span class="token keyword">if</span> cell <span class="token keyword">and</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cell<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token keyword">and</span> contains_japanese<span class="token punctuation">(</span>cell<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="125"></td><td><pre>                            extracted_messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"message"</span><span class="token punctuation">:</span> cell<span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="126"></td><td><pre>                            mapping<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="127"></td><td><pre>                                <span class="token string">"table"</span><span class="token punctuation">:</span> table_name<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                                <span class="token string">"column"</span><span class="token punctuation">:</span> column_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="129"></td><td><pre>                                <span class="token string">"rowid"</span><span class="token punctuation">:</span> current_rowid</pre></td></tr><tr><td data-num="130"></td><td><pre>                    <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="131"></td><td><pre>        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="132"></td><td><pre>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="133"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"导出数据库 </span><span class="token interpolation"><span class="token punctuation">{</span>db_path<span class="token punctuation">}</span></span><span class="token string"> 时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="134"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> data_list <span class="token keyword">and</span> <span class="token keyword">not</span> extracted_messages<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="136"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string">"错误：未导出任何数据。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="137"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="138"></td><td><pre>    <span class="token keyword">if</span> data_list<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> json_file<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="140"></td><td><pre>            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>data_list<span class="token punctuation">,</span> json_file<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 提取完成，JSON 文件已保存到 </span><span class="token interpolation"><span class="token punctuation">{</span>json_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="142"></td><td><pre>    <span class="token keyword">if</span> extracted_messages<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token comment"># 写入仅含 "message" 的 JSON 文件，供翻译人员使用</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="145"></td><td><pre>            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>extracted_messages<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="146"></td><td><pre></pre></td></tr><tr><td data-num="147"></td><td><pre>        <span class="token comment"># 写入映射信息到单独文件（翻译人员无需查看）</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>mapping_json_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="149"></td><td><pre>            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"映射信息已保存到 </span><span class="token interpolation"><span class="token punctuation">{</span>mapping_json_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 提取完成，JSON 文件已保存到 </span><span class="token interpolation"><span class="token punctuation">{</span>json_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token keyword">def</span> <span class="token function">clone_db_structure</span><span class="token punctuation">(</span>src_db<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> dest_db<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    <span class="token triple-quoted-string string">"""克隆原数据库结构到新数据库"""</span></pre></td></tr><tr><td data-num="155"></td><td><pre>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>dest_db<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="156"></td><td><pre>        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>dest_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="157"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="158"></td><td><pre>        <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="159"></td><td><pre>            shutil<span class="token punctuation">.</span>copy2<span class="token punctuation">(</span>src_db<span class="token punctuation">,</span> dest_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="160"></td><td><pre>            print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 数据库复制完成：</span><span class="token interpolation"><span class="token punctuation">{</span>dest_db<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="161"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="162"></td><td><pre>            shutil<span class="token punctuation">.</span>copyfile<span class="token punctuation">(</span>src_db<span class="token punctuation">,</span> dest_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="163"></td><td><pre>            print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 数据库复制完成：</span><span class="token interpolation"><span class="token punctuation">{</span>dest_db<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="165"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"复制数据库结构时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="166"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token keyword">def</span> <span class="token function">import_json_to_db</span><span class="token punctuation">(</span>db_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> json_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> task_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token triple-quoted-string string">"""将 JSON 文件中的数据写入 SQLite 数据库"""</span></pre></td></tr><tr><td data-num="170"></td><td><pre>    <span class="token keyword">global</span> mapping_json_path</pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="172"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ 未找到 JSON 文件: </span><span class="token interpolation"><span class="token punctuation">{</span>json_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="173"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="174"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="175"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="176"></td><td><pre>            data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="177"></td><td><pre>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="178"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"读取 JSON 文件时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="179"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="180"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="181"></td><td><pre>        conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="182"></td><td><pre>        cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="183"></td><td><pre>        <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="184"></td><td><pre>            messages <span class="token operator">=</span> <span class="token punctuation">[</span>item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"message"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> data <span class="token keyword">if</span> <span class="token string">"message"</span> <span class="token keyword">in</span> item<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="185"></td><td><pre>            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT name FROM sqlite_master WHERE type='table';"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="186"></td><td><pre>            tables <span class="token operator">=</span> <span class="token punctuation">[</span>table<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> table <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="187"></td><td><pre>            index <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="188"></td><td><pre>            <span class="token keyword">for</span> table <span class="token keyword">in</span> tables<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="189"></td><td><pre>                <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="190"></td><td><pre>                    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT rowid FROM </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">;"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="191"></td><td><pre>                    rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="192"></td><td><pre>                    <span class="token keyword">for</span> row <span class="token keyword">in</span> rows<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="193"></td><td><pre>                        <span class="token keyword">if</span> index <span class="token operator">&gt;=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="194"></td><td><pre>                            print_warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"⚠️ 翻译 JSON 数据不足，</span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string"> 表剩余行未填充"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="195"></td><td><pre>                            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="196"></td><td><pre>                        translated_text <span class="token operator">=</span> messages<span class="token punctuation">[</span>index<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="197"></td><td><pre>                        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"UPDATE </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string"> SET DataString = ? WHERE rowid = ?"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>translated_text<span class="token punctuation">,</span> row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="198"></td><td><pre>                        index <span class="token operator">+=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="199"></td><td><pre>                <span class="token keyword">except</span> sqlite3<span class="token punctuation">.</span>OperationalError <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="200"></td><td><pre>                    print_warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"⚠️ 跳过 </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="201"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="202"></td><td><pre>            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>mapping_json_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="203"></td><td><pre>                mapping <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="204"></td><td><pre></pre></td></tr><tr><td data-num="205"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>mapping<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="206"></td><td><pre>                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"错误：翻译后的条目数与映射信息条目数不一致！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="207"></td><td><pre>                <span class="token keyword">return</span></pre></td></tr><tr><td data-num="208"></td><td><pre></pre></td></tr><tr><td data-num="209"></td><td><pre>            conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="210"></td><td><pre>            cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="211"></td><td><pre></pre></td></tr><tr><td data-num="212"></td><td><pre>            <span class="token comment"># 根据映射信息逐条更新对应的单元格</span></pre></td></tr><tr><td data-num="213"></td><td><pre>            <span class="token keyword">for</span> loc<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>mapping<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="214"></td><td><pre>                table <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token string">"table"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="215"></td><td><pre>                column <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token string">"column"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="216"></td><td><pre>                rowid <span class="token operator">=</span> loc<span class="token punctuation">[</span><span class="token string">"rowid"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="217"></td><td><pre>                new_text <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token string">"message"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="218"></td><td><pre></pre></td></tr><tr><td data-num="219"></td><td><pre>                <span class="token comment"># 使用 rowid 定位行，更新对应列</span></pre></td></tr><tr><td data-num="220"></td><td><pre>                sql <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'UPDATE "</span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">" SET "</span><span class="token interpolation"><span class="token punctuation">{</span>column<span class="token punctuation">}</span></span><span class="token string">" = ? WHERE rowid = ?;'</span></span></pre></td></tr><tr><td data-num="221"></td><td><pre>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token punctuation">(</span>new_text<span class="token punctuation">,</span> rowid<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="222"></td><td><pre>        conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="223"></td><td><pre>        conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="224"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 翻译内容已成功写入 </span><span class="token interpolation"><span class="token punctuation">{</span>db_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="225"></td><td><pre>    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="226"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"导入 JSON 数据时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="227"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="228"></td><td><pre></pre></td></tr><tr><td data-num="229"></td><td><pre><span class="token keyword">def</span> <span class="token function">cleanup_intermediate_files</span><span class="token punctuation">(</span>folder_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> final_files<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="230"></td><td><pre>    <span class="token triple-quoted-string string">"""清理指定目录下除 final_files 外的所有中间文件"""</span></pre></td></tr><tr><td data-num="231"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"\n&gt;&gt;&gt; 正在清理中间文件..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="232"></td><td><pre>    abs_final_files <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> final_files<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token keyword">for</span> item <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>folder_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="234"></td><td><pre>        item_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>folder_path<span class="token punctuation">,</span> item<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="235"></td><td><pre>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>item_path<span class="token punctuation">)</span> <span class="token keyword">in</span> abs_final_files<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="236"></td><td><pre>            <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="237"></td><td><pre>        <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="238"></td><td><pre>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>item_path<span class="token punctuation">)</span> <span class="token keyword">or</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>islink<span class="token punctuation">(</span>item_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="239"></td><td><pre>                os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>item_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="240"></td><td><pre>            <span class="token keyword">elif</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>item_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="241"></td><td><pre>                shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>item_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="242"></td><td><pre>        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="243"></td><td><pre>            print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"删除 </span><span class="token interpolation"><span class="token punctuation">{</span>item_path<span class="token punctuation">}</span></span><span class="token string"> 时出错: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="244"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"中间文件已清理。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="245"></td><td><pre></pre></td></tr><tr><td data-num="246"></td><td><pre><span class="token keyword">def</span> <span class="token function">load_hanzi_conversion_table</span><span class="token punctuation">(</span>txt_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="247"></td><td><pre>    <span class="token triple-quoted-string string">"""读取汉字转换表（假设以 Tab 分隔，格式：简体[TAB]繁体）"""</span></pre></td></tr><tr><td data-num="248"></td><td><pre>    conversion_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="249"></td><td><pre>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>txt_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="250"></td><td><pre>        <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="251"></td><td><pre>            parts <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\t"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="252"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="253"></td><td><pre>                conversion_dict<span class="token punctuation">[</span>parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="254"></td><td><pre>    <span class="token keyword">return</span> conversion_dict</pre></td></tr><tr><td data-num="255"></td><td><pre></pre></td></tr><tr><td data-num="256"></td><td><pre><span class="token keyword">def</span> <span class="token function">load_existing_log</span><span class="token punctuation">(</span>log_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="257"></td><td><pre>    <span class="token triple-quoted-string string">"""读取已有转换日志（JSON格式）"""</span></pre></td></tr><tr><td data-num="258"></td><td><pre>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="259"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>log_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="260"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="261"></td><td><pre>                <span class="token keyword">return</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="262"></td><td><pre>            <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="263"></td><td><pre>                <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"source_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"target_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="264"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"source_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"target_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="265"></td><td><pre></pre></td></tr><tr><td data-num="266"></td><td><pre><span class="token keyword">def</span> <span class="token function">replace_hanzi</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> conversion_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> detected_changes<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="267"></td><td><pre>    <span class="token triple-quoted-string string">"""对文本进行汉字替换，并记录替换情况"""</span></pre></td></tr><tr><td data-num="268"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="269"></td><td><pre>        <span class="token keyword">return</span> text</pre></td></tr><tr><td data-num="270"></td><td><pre>    new_text <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="271"></td><td><pre>    <span class="token keyword">for</span> char <span class="token keyword">in</span> text<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="272"></td><td><pre>        <span class="token keyword">if</span> char <span class="token keyword">in</span> conversion_dict<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="273"></td><td><pre>            <span class="token keyword">if</span> char <span class="token keyword">not</span> <span class="token keyword">in</span> detected_changes<span class="token punctuation">[</span><span class="token string">"source_characters"</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="274"></td><td><pre>                detected_changes<span class="token punctuation">[</span><span class="token string">"source_characters"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> conversion_dict<span class="token punctuation">[</span>char<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="275"></td><td><pre>                detected_changes<span class="token punctuation">[</span><span class="token string">"target_characters"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> char</pre></td></tr><tr><td data-num="276"></td><td><pre>            new_text<span class="token punctuation">.</span>append<span class="token punctuation">(</span>conversion_dict<span class="token punctuation">[</span>char<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="277"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="278"></td><td><pre>            new_text<span class="token punctuation">.</span>append<span class="token punctuation">(</span>char<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="279"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>new_text<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="280"></td><td><pre></pre></td></tr><tr><td data-num="281"></td><td><pre><span class="token keyword">def</span> <span class="token function">process_database_text</span><span class="token punctuation">(</span>db_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> conversion_dict<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> log_file<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="282"></td><td><pre>    <span class="token triple-quoted-string string">"""对数据库中所有文本字段进行汉字替换，并更新转换日志（合并新旧记录）"""</span></pre></td></tr><tr><td data-num="283"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"\n&gt;&gt;&gt; 正在进行文字替换..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="284"></td><td><pre>    conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>db_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="285"></td><td><pre>    cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="286"></td><td><pre>    cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT name FROM sqlite_master WHERE type='table';"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="287"></td><td><pre>    tables <span class="token operator">=</span> <span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="288"></td><td><pre>    detected_changes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"source_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"target_characters"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="289"></td><td><pre>    <span class="token keyword">for</span> table <span class="token keyword">in</span> tables<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="290"></td><td><pre>        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"PRAGMA table_info(</span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">);"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="291"></td><td><pre>        columns <span class="token operator">=</span> <span class="token punctuation">[</span>row<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="292"></td><td><pre>        <span class="token keyword">for</span> column <span class="token keyword">in</span> columns<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="293"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="294"></td><td><pre>                cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SELECT rowid, </span><span class="token interpolation"><span class="token punctuation">{</span>column<span class="token punctuation">}</span></span><span class="token string"> FROM </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">;"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="295"></td><td><pre>                rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="296"></td><td><pre>                <span class="token keyword">for</span> rowid<span class="token punctuation">,</span> text <span class="token keyword">in</span> rows<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="297"></td><td><pre>                    new_text <span class="token operator">=</span> replace_hanzi<span class="token punctuation">(</span>text<span class="token punctuation">,</span> conversion_dict<span class="token punctuation">,</span> detected_changes<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="298"></td><td><pre>                    <span class="token keyword">if</span> new_text <span class="token operator">!=</span> text<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="299"></td><td><pre>                        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"UPDATE </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string"> SET </span><span class="token interpolation"><span class="token punctuation">{</span>column<span class="token punctuation">}</span></span><span class="token string"> = ? WHERE rowid = ?"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>new_text<span class="token punctuation">,</span> rowid<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="300"></td><td><pre>                conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="301"></td><td><pre>            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="302"></td><td><pre>                print_warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"跳过 </span><span class="token interpolation"><span class="token punctuation">{</span>table<span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>column<span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="303"></td><td><pre>    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="304"></td><td><pre>    existing_log <span class="token operator">=</span> load_existing_log<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="305"></td><td><pre>    existing_source <span class="token operator">=</span> existing_log<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"source_characters"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="306"></td><td><pre>    existing_target <span class="token operator">=</span> existing_log<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"target_characters"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="307"></td><td><pre>    new_source <span class="token operator">=</span> detected_changes<span class="token punctuation">[</span><span class="token string">"source_characters"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="308"></td><td><pre>    new_target <span class="token operator">=</span> detected_changes<span class="token punctuation">[</span><span class="token string">"target_characters"</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="309"></td><td><pre>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> char <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>new_source<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="310"></td><td><pre>        <span class="token keyword">if</span> char <span class="token keyword">not</span> <span class="token keyword">in</span> existing_source<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="311"></td><td><pre>            existing_source <span class="token operator">+=</span> char</pre></td></tr><tr><td data-num="312"></td><td><pre>            existing_target <span class="token operator">+=</span> new_target<span class="token punctuation">[</span>i<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="313"></td><td><pre>    final_log <span class="token operator">=</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="314"></td><td><pre>        <span class="token string">"source_characters"</span><span class="token punctuation">:</span> existing_source<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="315"></td><td><pre>        <span class="token string">"target_characters"</span><span class="token punctuation">:</span> existing_target</pre></td></tr><tr><td data-num="316"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="317"></td><td><pre>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>log_file<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="318"></td><td><pre>        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>final_log<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="319"></td><td><pre>    print_success<span class="token punctuation">(</span><span class="token string">"✅ 文字替换完成，日志已保存到 "</span> <span class="token operator">+</span> log_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="320"></td><td><pre></pre></td></tr><tr><td data-num="321"></td><td><pre><span class="token keyword">def</span> <span class="token function">pack_db_to_script</span><span class="token punctuation">(</span>db_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> script_db_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> pack_flag<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> file_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> repack_type<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="322"></td><td><pre>    <span class="token triple-quoted-string string">"""调用 EscudeTools 打包数据库文件回脚本文件（会在 repack 文件夹内生成文件，并复制覆盖到 script 文件夹）"""</span></pre></td></tr><tr><td data-num="323"></td><td><pre>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>db_path<span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"_staff.db"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="324"></td><td><pre>        script_db_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_db_dir<span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="325"></td><td><pre>        script_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_db_dir<span class="token punctuation">,</span> <span class="token string">"staff"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="326"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="327"></td><td><pre>        script_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_db_dir<span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="328"></td><td><pre>    command <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>pack_flag<span class="token punctuation">}</span></span><span class="token string"> "</span><span class="token interpolation"><span class="token punctuation">{</span>db_path<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>file_type<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>repack_type<span class="token punctuation">}</span></span><span class="token string">'</span></span></pre></td></tr><tr><td data-num="329"></td><td><pre>    run_command<span class="token punctuation">(</span>command<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="330"></td><td><pre>    repack_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_db_dir<span class="token punctuation">,</span> <span class="token string">"repack"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="331"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>repack_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="332"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"错误：未找到 repack 文件夹：</span><span class="token interpolation"><span class="token punctuation">{</span>repack_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="333"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="334"></td><td><pre>    <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>repack_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="335"></td><td><pre>        <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> files<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="336"></td><td><pre>            source_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="337"></td><td><pre>            dest_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_dir<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="338"></td><td><pre>            shutil<span class="token punctuation">.</span>copy2<span class="token punctuation">(</span>source_file<span class="token punctuation">,</span> dest_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="339"></td><td><pre>            print_info<span class="token punctuation">(</span><span class="token string">"替换文件："</span> <span class="token operator">+</span> dest_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="340"></td><td><pre>    print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 数据库文件已打包回脚本，路径在：</span><span class="token interpolation"><span class="token punctuation">{</span>script_dir<span class="token punctuation">}</span></span><span class="token string">。"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="341"></td><td><pre>    shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>repack_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="342"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"已移除 repack 文件夹。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="343"></td><td><pre></pre></td></tr><tr><td data-num="344"></td><td><pre><span class="token keyword">def</span> <span class="token function">pack_script_to_bin</span><span class="token punctuation">(</span>output_dir<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> escude_tools_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="345"></td><td><pre>    <span class="token triple-quoted-string string">"""调用 EscudeTools 打包脚本文件回 .bin 文件"""</span></pre></td></tr><tr><td data-num="346"></td><td><pre>    command <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string"> -r "</span><span class="token interpolation"><span class="token punctuation">{</span>output_dir<span class="token punctuation">}</span></span><span class="token string">"'</span></span></pre></td></tr><tr><td data-num="347"></td><td><pre>    run_command<span class="token punctuation">(</span>command<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="348"></td><td><pre>    print_success<span class="token punctuation">(</span><span class="token string">"✅ 打包生成最终的 .bin 文件。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="349"></td><td><pre></pre></td></tr><tr><td data-num="350"></td><td><pre><span class="token keyword">def</span> <span class="token function">merge_translation_logs</span><span class="token punctuation">(</span>log_list<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> output_log<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="351"></td><td><pre>    <span class="token triple-quoted-string string">"""合并多个转换日志，去重后写入输出文件"""</span></pre></td></tr><tr><td data-num="352"></td><td><pre>    final_source <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="353"></td><td><pre>    final_target <span class="token operator">=</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="354"></td><td><pre>    <span class="token keyword">for</span> log_file <span class="token keyword">in</span> log_list<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="355"></td><td><pre>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="356"></td><td><pre>            log <span class="token operator">=</span> load_existing_log<span class="token punctuation">(</span>log_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="357"></td><td><pre>            <span class="token keyword">for</span> char <span class="token keyword">in</span> log<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"source_characters"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="358"></td><td><pre>                <span class="token keyword">if</span> char <span class="token keyword">not</span> <span class="token keyword">in</span> final_source<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="359"></td><td><pre>                    final_source <span class="token operator">+=</span> char</pre></td></tr><tr><td data-num="360"></td><td><pre>            <span class="token keyword">for</span> char <span class="token keyword">in</span> log<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"target_characters"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="361"></td><td><pre>                <span class="token keyword">if</span> char <span class="token keyword">not</span> <span class="token keyword">in</span> final_target<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="362"></td><td><pre>                    final_target <span class="token operator">+=</span> char</pre></td></tr><tr><td data-num="363"></td><td><pre>    final_log <span class="token operator">=</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="364"></td><td><pre>        <span class="token string">"source_characters"</span><span class="token punctuation">:</span> final_source<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="365"></td><td><pre>        <span class="token string">"target_characters"</span><span class="token punctuation">:</span> final_target</pre></td></tr><tr><td data-num="366"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="367"></td><td><pre>    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>output_log<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="368"></td><td><pre>        json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>final_log<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="369"></td><td><pre>    print_success<span class="token punctuation">(</span><span class="token string">"✅ 合并转换日志完成，保存到 "</span> <span class="token operator">+</span> output_log<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="370"></td><td><pre></pre></td></tr><tr><td data-num="371"></td><td><pre></pre></td></tr><tr><td data-num="372"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="373"></td><td><pre><span class="token comment"># 针对不同任务的处理函数</span></pre></td></tr><tr><td data-num="374"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="375"></td><td><pre><span class="token keyword">def</span> <span class="token function">process_bin_task</span><span class="token punctuation">(</span>task_type<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="376"></td><td><pre>    <span class="token triple-quoted-string string">"""</span></pre></td></tr><tr><td data-num="377"></td><td><pre>    处理任务：</pre></td></tr><tr><td data-num="378"></td><td><pre>      task_type: "script" 或 "data"</pre></td></tr><tr><td data-num="379"></td><td><pre>    返回最终生成的 .bin 文件路径及该任务生成的转换日志路径</pre></td></tr><tr><td data-num="380"></td><td><pre>    """</pre></td></tr><tr><td data-num="381"></td><td><pre>    <span class="token comment"># 设置任务相关参数</span></pre></td></tr><tr><td data-num="382"></td><td><pre>    <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="383"></td><td><pre>        subfolder <span class="token operator">=</span> <span class="token string">"script"</span>         <span class="token comment"># 子文件夹名称（output 下）</span></pre></td></tr><tr><td data-num="384"></td><td><pre>        unpack_flag <span class="token operator">=</span> <span class="token string">"-v"</span>           <span class="token comment"># 解包到数据库命令参数（script 任务用 -v）</span></pre></td></tr><tr><td data-num="385"></td><td><pre>        pack_flag <span class="token operator">=</span> <span class="token string">"-e"</span></pre></td></tr><tr><td data-num="386"></td><td><pre>        final_bin_name <span class="token operator">=</span> <span class="token string">"script.bin"</span></pre></td></tr><tr><td data-num="387"></td><td><pre>        file_type <span class="token operator">=</span> <span class="token string">"-t"</span></pre></td></tr><tr><td data-num="388"></td><td><pre>        file_flag <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="389"></td><td><pre>        translation_required <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># script 任务需要调用翻译工具</span></pre></td></tr><tr><td data-num="390"></td><td><pre>    <span class="token keyword">elif</span> task_type <span class="token operator">==</span> <span class="token string">"data"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="391"></td><td><pre>        subfolder <span class="token operator">=</span> <span class="token string">"data"</span>           <span class="token comment"># 数据任务使用 data 子文件夹</span></pre></td></tr><tr><td data-num="392"></td><td><pre>        unpack_flag <span class="token operator">=</span> <span class="token string">"-d"</span>           <span class="token comment"># 数据任务用 -d</span></pre></td></tr><tr><td data-num="393"></td><td><pre>        pack_flag <span class="token operator">=</span> <span class="token string">"-f"</span></pre></td></tr><tr><td data-num="394"></td><td><pre>        final_bin_name <span class="token operator">=</span> <span class="token string">"data.bin"</span></pre></td></tr><tr><td data-num="395"></td><td><pre>        translation_required <span class="token operator">=</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="396"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="397"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string">"无效的任务类型！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="398"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="399"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> Fore<span class="token punctuation">.</span>MAGENTA <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"开始处理 </span><span class="token interpolation"><span class="token punctuation">{</span>task_type<span class="token punctuation">}</span></span><span class="token string"> 任务..."</span></span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="400"></td><td><pre>    <span class="token keyword">global</span> escude_tools_path<span class="token punctuation">,</span> runed<span class="token punctuation">,</span> run_galtransl_path<span class="token punctuation">,</span> hanzi_table_path<span class="token punctuation">,</span> replaced<span class="token punctuation">,</span> is_set_galtransl<span class="token punctuation">,</span> project_path</pre></td></tr><tr><td data-num="401"></td><td><pre>    <span class="token comment"># 询问是否重新指定 EscudeTools.exe 路径（script 任务额外询问 run_GalTransl.exe 路径）</span></pre></td></tr><tr><td data-num="402"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> runed<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="403"></td><td><pre>        choice <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"是否需要重新指定 EscudeTools.exe 路径？（输入 yes 重新指定，否则输入 no）： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="404"></td><td><pre>        <span class="token keyword">if</span> choice <span class="token operator">==</span> <span class="token string">"yes"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="405"></td><td><pre>            escude_tools_path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"请输入 EscudeTools.exe 的路径: "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="406"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="407"></td><td><pre>            escude_tools_path <span class="token operator">=</span> <span class="token string">r"D:\Tool\汉化工具\net8.0\EscudeTools.exe"</span></pre></td></tr><tr><td data-num="408"></td><td><pre>        choice <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"是否需要重新指定 run_GalTransl.exe 路径？（输入 yes 重新指定，否则输入 no）： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="409"></td><td><pre>        <span class="token keyword">if</span> choice <span class="token operator">==</span> <span class="token string">"yes"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="410"></td><td><pre>            run_galtransl_path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"请输入 run_GalTransl.exe 的路径: "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="411"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="412"></td><td><pre>            run_galtransl_path <span class="token operator">=</span> <span class="token string">r"D:\Tool\GalTransl\GalTransl-v5.9.1-win\run_GalTransl.exe"</span></pre></td></tr><tr><td data-num="413"></td><td><pre>    </pre></td></tr><tr><td data-num="414"></td><td><pre>    <span class="token comment"># 询问 bin 文件所在文件夹</span></pre></td></tr><tr><td data-num="415"></td><td><pre>    bin_folder <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string-interpolation"><span class="token string">f"\n请输入 </span><span class="token interpolation"><span class="token punctuation">{</span>task_type<span class="token punctuation">}</span></span><span class="token string">.bin 文件所在的文件夹路径: "</span></span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="416"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>bin_folder<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="417"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string">"错误：指定的文件夹不存在！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="418"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="419"></td><td><pre>    <span class="token comment"># 删除该文件夹下的旧内容（子文件夹）</span></pre></td></tr><tr><td data-num="420"></td><td><pre>    <span class="token keyword">for</span> item <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>bin_folder<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="421"></td><td><pre>        item_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>bin_folder<span class="token punctuation">,</span> item<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="422"></td><td><pre>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>item_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="423"></td><td><pre>            shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>item_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="424"></td><td><pre>            print_info<span class="token punctuation">(</span><span class="token string">"已删除旧内容："</span> <span class="token operator">+</span> item_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="425"></td><td><pre>    </pre></td></tr><tr><td data-num="426"></td><td><pre>    <span class="token comment"># 第一步：解包 .bin 文件（通用 -u 命令）</span></pre></td></tr><tr><td data-num="427"></td><td><pre>    cmd_unpack <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'"</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string">" -u "</span><span class="token interpolation"><span class="token punctuation">{</span>bin_folder<span class="token punctuation">}</span></span><span class="token string">"'</span></span></pre></td></tr><tr><td data-num="428"></td><td><pre>    run_command<span class="token punctuation">(</span>cmd_unpack<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="429"></td><td><pre>    </pre></td></tr><tr><td data-num="430"></td><td><pre>    <span class="token comment"># 第二步：进一步解包到数据库</span></pre></td></tr><tr><td data-num="431"></td><td><pre>    output_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>bin_folder<span class="token punctuation">,</span> <span class="token string">"output"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="432"></td><td><pre>    task_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> subfolder<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="433"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>task_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="434"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"错误：解包后的 </span><span class="token interpolation"><span class="token punctuation">{</span>subfolder<span class="token punctuation">}</span></span><span class="token string"> 文件夹不存在！"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="435"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="436"></td><td><pre>    <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="437"></td><td><pre>        print_info<span class="token punctuation">(</span><span class="token string">"\n&gt;&gt;&gt; 正在解包output\script文件..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="438"></td><td><pre>        cmd_unpack_db <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'"</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>unpack_flag<span class="token punctuation">}</span></span><span class="token string"> "</span><span class="token interpolation"><span class="token punctuation">{</span>task_dir<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>file_type<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>file_flag<span class="token punctuation">}</span></span><span class="token string">'</span></span></pre></td></tr><tr><td data-num="439"></td><td><pre>        run_command<span class="token punctuation">(</span>cmd_unpack_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="440"></td><td><pre>        print_info<span class="token punctuation">(</span><span class="token string">"\n&gt;&gt;&gt; 正在解包output\script\staff文件..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="441"></td><td><pre>        staff_folder <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>task_dir<span class="token punctuation">,</span> <span class="token string">"staff"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="442"></td><td><pre>        cmd_unpack_db <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'"</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>unpack_flag<span class="token punctuation">}</span></span><span class="token string"> "</span><span class="token interpolation"><span class="token punctuation">{</span>staff_folder<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>file_type<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>file_flag<span class="token punctuation">}</span></span><span class="token string">'</span></span></pre></td></tr><tr><td data-num="443"></td><td><pre>        run_command<span class="token punctuation">(</span>cmd_unpack_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="444"></td><td><pre>    <span class="token keyword">elif</span> task_type <span class="token operator">==</span> <span class="token string">"data"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="445"></td><td><pre>        print_info<span class="token punctuation">(</span><span class="token string">"\n&gt;&gt;&gt; 正在解包output\data文件..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="446"></td><td><pre>        cmd_unpack_db <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'"</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>unpack_flag<span class="token punctuation">}</span></span><span class="token string"> "</span><span class="token interpolation"><span class="token punctuation">{</span>task_dir<span class="token punctuation">}</span></span><span class="token string">"'</span></span></pre></td></tr><tr><td data-num="447"></td><td><pre>        run_command<span class="token punctuation">(</span>cmd_unpack_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="448"></td><td><pre>    </pre></td></tr><tr><td data-num="449"></td><td><pre>    <span class="token comment"># 第三步：处理解包后的数据库</span></pre></td></tr><tr><td data-num="450"></td><td><pre>    db_pattern <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"*.db"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="451"></td><td><pre>    db_files <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token keyword">for</span> f <span class="token keyword">in</span> glob<span class="token punctuation">(</span>db_pattern<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"cn_"</span><span class="token punctuation">)</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="452"></td><td><pre>    <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="453"></td><td><pre>        script_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="454"></td><td><pre>        db_files <span class="token operator">+=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="455"></td><td><pre>            os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">,</span> new<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="456"></td><td><pre>            <span class="token keyword">for</span> f <span class="token keyword">in</span> glob<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_dir<span class="token punctuation">,</span> <span class="token string">"*.db"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="457"></td><td><pre>            <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"cn_"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="458"></td><td><pre>            <span class="token keyword">and</span> <span class="token punctuation">(</span>new <span class="token operator">:=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"_staff.db"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="459"></td><td><pre>            <span class="token keyword">and</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>f<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>script_dir<span class="token punctuation">,</span> new<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="460"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="461"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> db_files<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="462"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string">"未找到待处理的 .db 文件。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="463"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="464"></td><td><pre>    </pre></td></tr><tr><td data-num="465"></td><td><pre>    <span class="token keyword">for</span> db_file <span class="token keyword">in</span> db_files<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="466"></td><td><pre>        print_info<span class="token punctuation">(</span><span class="token string">"\n------------------------------------------"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="467"></td><td><pre>        title <span class="token operator">=</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"请选择要处理的."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"db"</span><span class="token operator">+</span><span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">"文件："</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="468"></td><td><pre>        option<span class="token punctuation">,</span> _ <span class="token operator">=</span> pick<span class="token punctuation">(</span>db_files<span class="token punctuation">,</span> title<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="469"></td><td><pre>        option <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>option<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="470"></td><td><pre>        <span class="token keyword">if</span> option<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"_staff.db"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="471"></td><td><pre>            selected_db <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">,</span> option<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="472"></td><td><pre>            json_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".json"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="473"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="474"></td><td><pre>            selected_db <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> option<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="475"></td><td><pre>            json_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>option<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">".json"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="476"></td><td><pre>        print_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n&gt;&gt;&gt; 正在导出 </span><span class="token interpolation"><span class="token punctuation">{</span>option<span class="token punctuation">}</span></span><span class="token string"> 到 JSON ..."</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="477"></td><td><pre>        export_db_to_json<span class="token punctuation">(</span>selected_db<span class="token punctuation">,</span> json_path<span class="token punctuation">,</span> task_type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="478"></td><td><pre>        </pre></td></tr><tr><td data-num="479"></td><td><pre>        translation_required<span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"是否需要使用翻译工具进行翻译？（输入 yes 进行翻译，否则输入 no）： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"yes"</span><span class="token punctuation">)</span>  <span class="token keyword">else</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="480"></td><td><pre>        <span class="token keyword">if</span> translation_required<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="481"></td><td><pre>            <span class="token keyword">if</span> <span class="token keyword">not</span> is_set_galtransl<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="482"></td><td><pre>                project_path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"请输入项目文件夹路径（翻译工具调用所需）： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="483"></td><td><pre>                is_set_galtransl <span class="token operator">=</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="484"></td><td><pre>            <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>project_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="485"></td><td><pre>                print_error<span class="token punctuation">(</span><span class="token string">"错误：项目文件夹不存在！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="486"></td><td><pre>                sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="487"></td><td><pre>            gt_output <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>project_path<span class="token punctuation">,</span> <span class="token string">"gt_output"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="488"></td><td><pre>            transl_cache <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>project_path<span class="token punctuation">,</span> <span class="token string">"transl_cache"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="489"></td><td><pre>            gt_input <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>project_path<span class="token punctuation">,</span> <span class="token string">"gt_input"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="490"></td><td><pre>            clear_directory<span class="token punctuation">(</span>gt_output<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="491"></td><td><pre>            clear_directory<span class="token punctuation">(</span>transl_cache<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="492"></td><td><pre>            clear_directory<span class="token punctuation">(</span>gt_input<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="493"></td><td><pre>            dest_json_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>gt_input<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="494"></td><td><pre>            shutil<span class="token punctuation">.</span>copy2<span class="token punctuation">(</span>json_path<span class="token punctuation">,</span> dest_json_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="495"></td><td><pre>            print_info<span class="token punctuation">(</span><span class="token string">"已将 JSON 文件复制到："</span> <span class="token operator">+</span> dest_json_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="496"></td><td><pre>            cmd_translate <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'"</span><span class="token interpolation"><span class="token punctuation">{</span>run_galtransl_path<span class="token punctuation">}</span></span><span class="token string">" "</span><span class="token interpolation"><span class="token punctuation">{</span>project_path<span class="token punctuation">}</span></span><span class="token string">"'</span></span></pre></td></tr><tr><td data-num="497"></td><td><pre>            galtransl_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>run_galtransl_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="498"></td><td><pre>            proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>cmd_translate<span class="token punctuation">,</span> shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cwd<span class="token operator">=</span>galtransl_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="499"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="500"></td><td><pre>                print_info<span class="token punctuation">(</span><span class="token string">"\n等待翻译任务完成并生成翻译 JSON 文件..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="501"></td><td><pre>                proc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="502"></td><td><pre>            <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="503"></td><td><pre>                proc<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="504"></td><td><pre>                proc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="505"></td><td><pre>            translated_json_gt <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>gt_output<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>json_path<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="506"></td><td><pre>            print_info<span class="token punctuation">(</span><span class="token string">"\n翻译任务完成，检测是否生成翻译 JSON 文件..."</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="507"></td><td><pre>            timeout <span class="token operator">=</span> <span class="token number">300</span></pre></td></tr><tr><td data-num="508"></td><td><pre>            waited <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="509"></td><td><pre>            <span class="token keyword">while</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>translated_json_gt<span class="token punctuation">)</span> <span class="token keyword">and</span> waited <span class="token operator">&lt;</span> timeout<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="510"></td><td><pre>                time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="511"></td><td><pre>                waited <span class="token operator">+=</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="512"></td><td><pre>            <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>translated_json_gt<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="513"></td><td><pre>                print_error<span class="token punctuation">(</span><span class="token string">"错误：超时未生成翻译 JSON 文件！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="514"></td><td><pre>                sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="515"></td><td><pre>            use_translated <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"是否使用 gt_output 中的翻译结果？（输入 yes 使用，否则输入 no）： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="516"></td><td><pre>            <span class="token keyword">if</span> use_translated <span class="token operator">==</span> <span class="token string">"yes"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="517"></td><td><pre>                final_translated_json <span class="token operator">=</span> translated_json_gt</pre></td></tr><tr><td data-num="518"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="519"></td><td><pre>                final_translated_json <span class="token operator">=</span> dest_json_path</pre></td></tr><tr><td data-num="520"></td><td><pre>            print_info<span class="token punctuation">(</span><span class="token string">"最终使用的翻译 JSON 文件："</span> <span class="token operator">+</span> final_translated_json<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="521"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="522"></td><td><pre>            final_translated_json <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"请输入翻译后的 JSON 文件路径： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="523"></td><td><pre>            <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>final_translated_json<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="524"></td><td><pre>                print_error<span class="token punctuation">(</span><span class="token string">"错误：指定的翻译后 JSON 文件不存在！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="525"></td><td><pre>                sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="526"></td><td><pre>        </pre></td></tr><tr><td data-num="527"></td><td><pre>        new_db_name <span class="token operator">=</span> <span class="token string">"cn_"</span> <span class="token operator">+</span> option</pre></td></tr><tr><td data-num="528"></td><td><pre>        <span class="token keyword">if</span> option<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"_staff.db"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="529"></td><td><pre>            new_db_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"script"</span><span class="token punctuation">,</span> new_db_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="530"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="531"></td><td><pre>            new_db_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> new_db_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="532"></td><td><pre>        clone_db_structure<span class="token punctuation">(</span>selected_db<span class="token punctuation">,</span> new_db_path<span class="token punctuation">,</span> task_type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="533"></td><td><pre>        import_json_to_db<span class="token punctuation">(</span>new_db_path<span class="token punctuation">,</span> final_translated_json<span class="token punctuation">,</span> task_type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="534"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 已完成 </span><span class="token interpolation"><span class="token punctuation">{</span>option<span class="token punctuation">}</span></span><span class="token string"> 的翻译数据写入。"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="535"></td><td><pre>        </pre></td></tr><tr><td data-num="536"></td><td><pre>        print_info<span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt; 开始进行文字替换"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="537"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> replaced<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="538"></td><td><pre>            hanzi_table_path <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"请输入汉字替换表文件路径: "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'"'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="539"></td><td><pre>            replaced <span class="token operator">=</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="540"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>hanzi_table_path<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="541"></td><td><pre>            print_error<span class="token punctuation">(</span><span class="token string">"错误：汉字替换表不存在！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="542"></td><td><pre>            sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="543"></td><td><pre>        log_file <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"translation_log.txt"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="544"></td><td><pre>        conversion_dict <span class="token operator">=</span> load_hanzi_conversion_table<span class="token punctuation">(</span>hanzi_table_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="545"></td><td><pre>        process_database_text<span class="token punctuation">(</span>new_db_path<span class="token punctuation">,</span> conversion_dict<span class="token punctuation">,</span> log_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="546"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 已完成 </span><span class="token interpolation"><span class="token punctuation">{</span>option<span class="token punctuation">}</span></span><span class="token string"> 的文字替换。"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="547"></td><td><pre>        </pre></td></tr><tr><td data-num="548"></td><td><pre>        <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"script"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="549"></td><td><pre>            print_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n&gt;&gt;&gt; 开始生成翻译后的脚本文件到</span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>new_db_path<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="550"></td><td><pre>            pack_db_to_script<span class="token punctuation">(</span>new_db_path<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> pack_flag<span class="token punctuation">,</span> file_type<span class="token punctuation">,</span> file_flag<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="551"></td><td><pre>        cont <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"是否需要处理下一个 .db 文件？（输入 yes 继续，否则输入 no）： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="552"></td><td><pre>        <span class="token keyword">if</span> cont <span class="token operator">!=</span> <span class="token string">"yes"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="553"></td><td><pre>            <span class="token keyword">break</span></pre></td></tr><tr><td data-num="554"></td><td><pre></pre></td></tr><tr><td data-num="555"></td><td><pre>    <span class="token keyword">if</span> task_type <span class="token operator">==</span> <span class="token string">"data"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="556"></td><td><pre>        process_db_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>bin_folder<span class="token punctuation">,</span> <span class="token string">"process_db"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="557"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="558"></td><td><pre>            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="559"></td><td><pre>        <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="560"></td><td><pre>            <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".db"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> f<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"cn_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="561"></td><td><pre>                src <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="562"></td><td><pre>                dst <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="563"></td><td><pre>                shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>src<span class="token punctuation">,</span> dst<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="564"></td><td><pre>                print_info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"移动文件 </span><span class="token interpolation"><span class="token punctuation">{</span>f<span class="token punctuation">}</span></span><span class="token string"> 到 </span><span class="token interpolation"><span class="token punctuation">{</span>process_db_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="565"></td><td><pre>        cmd_pack_db <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'"</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string">" </span><span class="token interpolation"><span class="token punctuation">{</span>pack_flag<span class="token punctuation">}</span></span><span class="token string"> "</span><span class="token interpolation"><span class="token punctuation">{</span>process_db_dir<span class="token punctuation">}</span></span><span class="token string">"'</span></span></pre></td></tr><tr><td data-num="566"></td><td><pre>        run_command<span class="token punctuation">(</span>cmd_pack_db<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="567"></td><td><pre>        target_subfolder <span class="token operator">=</span> task_dir</pre></td></tr><tr><td data-num="568"></td><td><pre>        <span class="token keyword">for</span> f <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="569"></td><td><pre>            <span class="token keyword">if</span> f<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".bin"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> f<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"cn_"</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="570"></td><td><pre>                old_bin_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">,</span> f<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="571"></td><td><pre>                new_bin_name <span class="token operator">=</span> f<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="572"></td><td><pre>                new_bin_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">,</span> new_bin_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="573"></td><td><pre>                os<span class="token punctuation">.</span>rename<span class="token punctuation">(</span>old_bin_path<span class="token punctuation">,</span> new_bin_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="574"></td><td><pre>                shutil<span class="token punctuation">.</span>move<span class="token punctuation">(</span>new_bin_path<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>target_subfolder<span class="token punctuation">,</span> new_bin_name<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="575"></td><td><pre>                print_info<span class="token punctuation">(</span><span class="token string">"处理并移动文件："</span> <span class="token operator">+</span> new_bin_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="576"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string">"✅ DB 文件打包并替换原文件完成。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="577"></td><td><pre>        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="578"></td><td><pre>            shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>process_db_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="579"></td><td><pre>    </pre></td></tr><tr><td data-num="580"></td><td><pre>    cmd_pack_script <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'"</span><span class="token interpolation"><span class="token punctuation">{</span>escude_tools_path<span class="token punctuation">}</span></span><span class="token string">" -r "</span><span class="token interpolation"><span class="token punctuation">{</span>output_dir<span class="token punctuation">}</span></span><span class="token string">"'</span></span></pre></td></tr><tr><td data-num="581"></td><td><pre>    run_command<span class="token punctuation">(</span>cmd_pack_script<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="582"></td><td><pre>    final_bin <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> final_bin_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="583"></td><td><pre>    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>final_bin<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="584"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ </span><span class="token interpolation"><span class="token punctuation">{</span>task_type<span class="token punctuation">.</span>capitalize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">任务打包完成，生成文件： </span><span class="token interpolation"><span class="token punctuation">{</span>final_bin<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="585"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="586"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"错误：未生成最终 </span><span class="token interpolation"><span class="token punctuation">{</span>final_bin_name<span class="token punctuation">}</span></span><span class="token string"> 文件！"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="587"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="588"></td><td><pre>    </pre></td></tr><tr><td data-num="589"></td><td><pre>    <span class="token keyword">return</span> final_bin<span class="token punctuation">,</span> log_file</pre></td></tr><tr><td data-num="590"></td><td><pre></pre></td></tr><tr><td data-num="591"></td><td><pre></pre></td></tr><tr><td data-num="592"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="593"></td><td><pre><span class="token comment"># 主函数：整合两个任务</span></pre></td></tr><tr><td data-num="594"></td><td><pre><span class="token comment"># ===============================</span></pre></td></tr><tr><td data-num="595"></td><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="596"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>MAGENTA <span class="token operator">+</span> <span class="token string">"============================================"</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="597"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>MAGENTA <span class="token operator">+</span> <span class="token string">"       ESCU:DE引擎全自动化汉化任务开始"</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="598"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>MAGENTA <span class="token operator">+</span> <span class="token string">"============================================\n"</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="599"></td><td><pre>    print_info<span class="token punctuation">(</span><span class="token string">"请选择要执行的任务："</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="600"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"1) 脚本任务（处理 script.bin）"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="601"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"2) 数据任务（处理 data.bin）"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="602"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"3) 两者都执行"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="603"></td><td><pre>    choice <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"请输入选项（1/2/3）： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="604"></td><td><pre>    </pre></td></tr><tr><td data-num="605"></td><td><pre>    final_script_bin <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="606"></td><td><pre>    final_data_bin <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="607"></td><td><pre>    log_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="608"></td><td><pre>    <span class="token keyword">global</span> runed<span class="token punctuation">,</span> hanzi_table_path<span class="token punctuation">,</span> replaced<span class="token punctuation">,</span> is_set_galtransl<span class="token punctuation">,</span> project_path</pre></td></tr><tr><td data-num="609"></td><td><pre>    runed <span class="token operator">=</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="610"></td><td><pre>    hanzi_table_path <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="611"></td><td><pre>    replaced <span class="token operator">=</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="612"></td><td><pre>    is_set_galtransl <span class="token operator">=</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="613"></td><td><pre>    project_path <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="614"></td><td><pre>    <span class="token keyword">if</span> choice <span class="token operator">==</span> <span class="token string">"1"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="615"></td><td><pre>        final_script_bin<span class="token punctuation">,</span> log1 <span class="token operator">=</span> process_bin_task<span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="616"></td><td><pre>        log_files<span class="token punctuation">.</span>append<span class="token punctuation">(</span>log1<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="617"></td><td><pre>    <span class="token keyword">elif</span> choice <span class="token operator">==</span> <span class="token string">"2"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="618"></td><td><pre>        final_data_bin<span class="token punctuation">,</span> log2 <span class="token operator">=</span> process_bin_task<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="619"></td><td><pre>        log_files<span class="token punctuation">.</span>append<span class="token punctuation">(</span>log2<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="620"></td><td><pre>    <span class="token keyword">elif</span> choice <span class="token operator">==</span> <span class="token string">"3"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="621"></td><td><pre>        final_script_bin<span class="token punctuation">,</span> log1 <span class="token operator">=</span> process_bin_task<span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="622"></td><td><pre>        runed <span class="token operator">=</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="623"></td><td><pre>        final_data_bin<span class="token punctuation">,</span> log2 <span class="token operator">=</span> process_bin_task<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="624"></td><td><pre>        log_files<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>log1<span class="token punctuation">,</span> log2<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="625"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="626"></td><td><pre>        print_error<span class="token punctuation">(</span><span class="token string">"无效选项！"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="627"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="628"></td><td><pre>    </pre></td></tr><tr><td data-num="629"></td><td><pre>    final_log <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="630"></td><td><pre>    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>log_files<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="631"></td><td><pre>        output_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"output"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="632"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="633"></td><td><pre>            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="634"></td><td><pre>        merged_log <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token string">"translation_log.txt"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="635"></td><td><pre>        merge_translation_logs<span class="token punctuation">(</span>log_files<span class="token punctuation">,</span> merged_log<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="636"></td><td><pre>        final_log <span class="token operator">=</span> merged_log</pre></td></tr><tr><td data-num="637"></td><td><pre>        <span class="token keyword">for</span> file_path <span class="token keyword">in</span> <span class="token punctuation">[</span>final_script_bin<span class="token punctuation">,</span> final_data_bin<span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="638"></td><td><pre>            <span class="token keyword">if</span> file_path <span class="token keyword">and</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span> <span class="token operator">!=</span> output_dir<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="639"></td><td><pre>                shutil<span class="token punctuation">.</span>copy<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> output_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="640"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n已将最终文件</span><span class="token interpolation"><span class="token punctuation">{</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>final_script_bin<span class="token punctuation">)</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>final_data_bin<span class="token punctuation">)</span><span class="token punctuation">,</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>final_log<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">复制到 output 目录。"</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="641"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="642"></td><td><pre>        final_log <span class="token operator">=</span> log_files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="643"></td><td><pre>    </pre></td></tr><tr><td data-num="644"></td><td><pre>    keep_choice <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>CYAN <span class="token operator">+</span> <span class="token string">"\n任务完成。是否保留中间文件？（输入 yes 保留，否则输入 no）： "</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="645"></td><td><pre>    <span class="token keyword">if</span> keep_choice <span class="token operator">!=</span> <span class="token string">"yes"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="646"></td><td><pre>        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>log_files<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="647"></td><td><pre>            output_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>final_script_bin<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>pardir<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="648"></td><td><pre>            savefile <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>final_script_bin<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="649"></td><td><pre>            cleanup_intermediate_files<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token punctuation">[</span>savefile<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="650"></td><td><pre>            output_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>final_data_bin<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>pardir<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="651"></td><td><pre>            savefile <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>final_data_bin<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="652"></td><td><pre>            cleanup_intermediate_files<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token punctuation">[</span>savefile<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="653"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="654"></td><td><pre>            final_file <span class="token operator">=</span> final_script_bin <span class="token keyword">if</span> final_script_bin <span class="token keyword">else</span> final_data_bin</pre></td></tr><tr><td data-num="655"></td><td><pre>            <span class="token keyword">if</span> <span class="token keyword">not</span> final_file<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="656"></td><td><pre>                print_error<span class="token punctuation">(</span><span class="token string">"错误：没有生成任何最终.bin文件。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="657"></td><td><pre>                sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="658"></td><td><pre>            output_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>final_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="659"></td><td><pre>            cleanup_intermediate_files<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token punctuation">[</span>final_file<span class="token punctuation">,</span> final_log<span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="660"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="661"></td><td><pre>        print_info<span class="token punctuation">(</span><span class="token string">"中间文件已保留。"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="662"></td><td><pre>    </pre></td></tr><tr><td data-num="663"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>MAGENTA <span class="token operator">+</span> <span class="token string">"\n============================================"</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="664"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>MAGENTA <span class="token operator">+</span> <span class="token string">"       全自动化任务已完成！"</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="665"></td><td><pre>    <span class="token keyword">if</span> final_script_bin<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="666"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string">"最终生成的 script.bin："</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>final_log<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>final_script_bin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="667"></td><td><pre>    <span class="token keyword">if</span> final_data_bin<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="668"></td><td><pre>        print_success<span class="token punctuation">(</span><span class="token string">"最终生成的 data.bin："</span> <span class="token operator">+</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>final_log<span class="token punctuation">)</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>final_data_bin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="669"></td><td><pre>    print_success<span class="token punctuation">(</span><span class="token string">"最终生成的 translation_log.txt："</span> <span class="token operator">+</span> final_log<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="670"></td><td><pre>    <span class="token keyword">print</span><span class="token punctuation">(</span>Fore<span class="token punctuation">.</span>MAGENTA <span class="token operator">+</span> <span class="token string">"============================================\n"</span> <span class="token operator">+</span> Style<span class="token punctuation">.</span>RESET_ALL<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="671"></td><td><pre></pre></td></tr><tr><td data-num="672"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="673"></td><td><pre>    main<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><p><code>run_color_trans.bat</code> :</p>
<figure class="highlight batch"><figcaption data-lang="batch"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token operator">@</span><span class="token command"><span class="token keyword">echo</span> off</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">REM 调用整合后的 Python 脚本执行全自动化任务</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token command"><span class="token keyword">python</span> color_trans2.py</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token command"><span class="token keyword">pause</span></span></pre></td></tr></tbody></table></figure><p>打包为 exe:</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>python <span class="token parameter variable">-m</span> PyInstaller <span class="token parameter variable">--onefile</span> color_trans2.py</pre></td></tr></tbody></table></figure><div class="tags"><a href="/miyano/tags/%E5%B7%A5%E5%85%B7/" rel="tag"><i class="ic i-tag"></i>工具</a></div></div><footer><div class="meta"></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Rei<i class="ic i-at"><em>@</em></i>自分の為に楽しめ世界</li><li class="link"><strong>本文链接：</strong><a href="https://ei4869.github.io/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%BA%8C)%20/" title="Escu:de汉化(二)——jis替换">https://ei4869.github.io/miyano/Engine-Translation/Gal汉化-Escude(二) /</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%B8%80)/" rel="prev" itemprop="url" data-background-image="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_25.webp" title="Escu:de汉化(一)——GBK编码"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>引擎汉化</span><h3>Escu:de汉化(一)——GBK编码</h3></a></div><div class="item right"><a href="/miyano/Playful-Exploration/shokaX-%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9B%B4%E6%8D%A2/" rel="next" itemprop="url" data-background-image="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_26.webp" title="shokaX-图床搭建及更换"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>整活探索</span><h3>shokaX-图床搭建及更换</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><div class="toc-article" id="toc-div"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text"> 简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">2.</span> <span class="toc-text"> 使用的工具</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%8C%85"><span class="toc-number">3.</span> <span class="toc-text"> 解包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86db%E6%96%87%E4%BB%B6%E7%94%A8%E4%BA%8E%E7%BF%BB%E8%AF%91"><span class="toc-number">4.</span> <span class="toc-text"> 处理 db 文件用于翻译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E8%A1%8C%E7%BF%BB%E8%AF%91"><span class="toc-number">5.</span> <span class="toc-text"> 进行翻译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8A%E7%BF%BB%E8%AF%91%E5%90%8E%E7%9A%84json%E5%86%99%E5%9B%9Edb"><span class="toc-number">6.</span> <span class="toc-text"> 把翻译后的 json 写回 db</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96db%E5%86%85%E5%AE%B9%E8%BF%9B%E8%A1%8C%E6%B1%89%E5%AD%97%E6%9B%BF%E6%8D%A2"><span class="toc-number">7.</span> <span class="toc-text"> 读取 db 内容，进行汉字替换</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%81%E5%8C%85"><span class="toc-number">8.</span> <span class="toc-text"> 封包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%BB%88%E6%B1%89%E5%8C%96"><span class="toc-number">9.</span> <span class="toc-text"> 最终汉化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">10.</span> <span class="toc-text"> 总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E8%87%AA%E5%8A%A8%E6%B1%89%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="toc-number">11.</span> <span class="toc-text"> 全自动汉化工具</span></a></li></ol></div></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%B8%80)/" rel="bookmark" title="Escu:de汉化(一)——GBK编码">Escu:de汉化(一)——GBK编码</a></li><li class="active"><a href="/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%BA%8C)%20/" rel="bookmark" title="Escu:de汉化(二)——jis替换">Escu:de汉化(二)——jis替换</a></li><li><a href="/miyano/Engine-Translation/KrKr%E5%BC%95%E6%93%8E%E6%B1%89%E5%8C%96(%E4%B8%80)/" rel="bookmark" title="KrKr引擎汉化(一)">KrKr引擎汉化(一)</a></li><li><a href="/miyano/Engine-Translation/KrKr%E5%BC%95%E6%93%8E%E6%B1%89%E5%8C%96(%E4%BA%8C)/" rel="bookmark" title="KrKr引擎汉化(二)">KrKr引擎汉化(二)</a></li><li><a href="/miyano/Engine-Translation/KrKr%E5%BC%95%E6%93%8E%E6%B1%89%E5%8C%96(%E4%B8%89)/" rel="bookmark" title="KrKr引擎汉化(三)">KrKr引擎汉化(三)</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Rei" src="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/ai-icon.webp"><p class="name" itemprop="name">Rei</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/miyano/archives/"><span class="count">43</span><span class="name">文章</span></a></div><div class="item categories"><a href="/miyano/categories/"><span class="count">10</span><span class="name">分类</span></a></div><div class="item tags"><a href="/miyano/tags/"><span class="count">9</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/ei4869" class="item github" title="https://github.com/ei4869"><i class="ic i-github"></i></a><a href="mailto:ai4869@gmail.com" class="item email" title="mailto:ai4869@gmail.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/miyano/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/miyano/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/miyano/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/miyano/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-baibaoxiang"></i>宝箱</a><ul class="submenu"><li class="item"><a href="/miyano/gallery/" rel="section"><i class="ic i-xiangce"></i>相册</a></li><li class="item"><a href="/miyano/anime/" rel="section"><i class="ic i-pc-dongman"></i>追番</a></li></ul></li><li class="item"><a href="/miyano/about/" rel="section"><i class="ic i-user"></i>关于</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/miyano/Playful-Exploration/shokaX-%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9B%B4%E6%8D%A2/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%B8%80)/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Course-Study/" title="分类于课程学习">课程学习</a><i class="ic i-angle-right"></i><a href="/miyano/categories/Course-Study/Japanese/" title="分类于日语">日语</a></div><span><a href="/miyano/Course-Study/Japanese/%E5%88%9D%E7%BA%A7%E4%B8%8A-%E7%AC%AC6%E5%8D%95%E5%85%83/">单元六——再见！日本</a></span></li><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Scientific-Notes/" title="分类于科研笔记">科研笔记</a><i class="ic i-angle-right"></i><a href="/miyano/categories/Scientific-Notes/Opening-Report/" title="分类于开题报告">开题报告</a></div><span><a href="/miyano/Scientific-Notes/Opening-Report/%E5%BC%80%E9%A2%98%E6%8A%A5%E5%91%8A-%E7%AD%94%E8%BE%A9%E7%A8%BF/">开题报告-答辩稿</a></span></li><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Scientific-Notes/" title="分类于科研笔记">科研笔记</a><i class="ic i-angle-right"></i><a href="/miyano/categories/Scientific-Notes/Graduation-Project/" title="分类于毕设笔记">毕设笔记</a></div><span><a href="/miyano/Scientific-Notes/Graduation-Project/2024-11-21-%E6%AF%95%E8%AE%BE%E7%AC%94%E8%AE%B0-%E4%BA%8C/">毕设笔记(二)</a></span></li><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Engine-Translation/" title="分类于引擎汉化">引擎汉化</a></div><span><a href="/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%BA%8C)%20/">Escu:de汉化(二)——jis替换</a></span></li><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Course-Study/" title="分类于课程学习">课程学习</a><i class="ic i-angle-right"></i><a href="/miyano/categories/Course-Study/Japanese/" title="分类于日语">日语</a></div><span><a href="/miyano/Course-Study/Japanese/%E5%88%9D%E7%BA%A7%E4%B8%8A-%E7%AC%AC3%E5%8D%95%E5%85%83/">单元三——小李在箱根</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div style="width: 100%; text-align: center;"><span id="time">此站已存活 0 天 0 小时 0 分 0 秒</span></div><script src="/miyano/js/create-time.js" defer="defer"></script><div class="status"><div class="copyright">© 2024 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Rei @ Rei の 手帳</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">598k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">9h4min</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> &amp; Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config="" type="text/javascript">var LOCAL = {
    ispost: true,
        path: `Engine-Translation/Gal汉化-Escude(二) /`,
        favicon: {
        show: `（●´3｀●）萌え萌えキュン`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    justifiedGallery: true,
    jquery: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-4H41ZSPP7G"></script><script data-pjax="data-pjax">window.dataLayer = window.dataLayer || [];
function gtag() {
    dataLayer.push(arguments);
}
gtag('js', new Date());
gtag('config', 'G-4H41ZSPP7G');</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/miyano/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer=""></script></body></html>