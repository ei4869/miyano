<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"><meta name="renderer" content="webkit"><link rel="icon" type="image/ico" sizes="32x32" href="/miyano/assets/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/miyano/assets/apple-touch-icon.png"><link rel="alternate" href="/miyano/rss.xml" title="自分の為に楽しめ世界" type="application/rss+xml"><link rel="alternate" href="/miyano/atom.xml" title="自分の為に楽しめ世界" type="application/atom+xml"><link rel="alternate" type="application/json" title="自分の為に楽しめ世界" href="https://ei4869.github.io/miyano/feed.json"><link rel="preconnect" href="https://s4.zstatic.net"><link rel="preconnect" href="https://at.alicdn.com"><link rel="preconnect" href="https://cloudflare-imgbed-9os.pages.dev"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CFredericka%20the%20Great:400,400italic,700,700italic%7CNoto%20Serif%20JP:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic%7CInconsolata:400,400italic,700,700italic&amp;display=swap&amp;subset=latin,latin-ext" media="none" onload="this.media='all'"><link rel="stylesheet" href="/miyano/css/app.css?v=0.4.17"><link rel="modulepreload" href="/miyano/js/chunk-424DDEWW.js"><link rel="modulepreload" href="/miyano/js/chunk-GL47M7BI.js"><link rel="modulepreload" href="/miyano/js/chunk-LOCL5DEO.js"><link rel="modulepreload" href="/miyano/js/chunk-MTLQDVVJ.js"><link rel="modulepreload" href="/miyano/js/chunk-MWLQAVNJ.js"><link rel="modulepreload" href="/miyano/js/chunk-WIQECBEN.js"><link rel="modulepreload" href="/miyano/js/comments-QIVDG7X3.js"><link rel="modulepreload" href="/miyano/js/copy-tex-W2MNAMYO.js"><link rel="modulepreload" href="/miyano/js/index.esm-3GUGPDKE.js"><link rel="modulepreload" href="/miyano/js/post-WAGXKCY2.js"><link rel="modulepreload" href="/miyano/js/quicklink-DDPSWSOQ.js"><link rel="modulepreload" href="/miyano/js/search-5ACYIQUA.js"><link rel="modulepreload" href="/miyano/js/siteInit.js"><link rel="modulepreload" href="/miyano/js/waline-NVSVNCZW.js"><link rel="stylesheet" href="/miyano/css/comments-LAB2J3GR.css" media="none" onload="this.media='all'"><link rel="stylesheet" href="/miyano/css/siteInit.css" media="none" onload="this.media='all'"><link rel="stylesheet" href="/miyano/css/waline-7JVHAYE3.css" media="none" onload="this.media='all'"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_13.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_1.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_9.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_2.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_14.webp" as="image" fetchpriority="high"><link rel="preload" href="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_10.webp" as="image" fetchpriority="high"><meta name="keywords" content="Blog,shokaX"><meta name="description" content="搭建shokaX主题的开发记录"><link rel="canonical" href="https://ei4869.github.io/miyano/Playful-Exploration/shokaX%E4%B8%BB%E9%A2%98%E7%AC%94%E8%AE%B0/"><script>window.sakuraConfig = {
  sakura: 30,
  xSpeed: 0.5,
  ySpeed: 0.5,
  rSpeed: 0.03,
  direction: "TopRight",
  zIndex: -1
};</script><script src="https://cdn.jsdelivr.net/gh/minz71/sakura-rain/sakura-rain.js" defer="defer"></script><title>shokaX主题-笔记</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope="" itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">shokaX主题-笔记</h1><div class="meta"><span class="item" title="创建时间：2025-01-15 12:32:40"><span class="icon"><i class="ic i-calendar"></i></span><span class="text">发表于</span><time itemprop="dateCreated datePublished" datetime="2025-01-15T12:32:40+08:00">2025-01-15</time></span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i></span><span class="text">本文字数</span><span>104k</span><span class="text">字</span></span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i></span><span class="text">阅读时长</span><span>1h35min</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span><span class="line"></span><span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/miyano/" rel="start">Rei の 手帳</a></li></ul><ul class="right" id="rightNav"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div class="pjax" id="imgs"><ul><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_13.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_1.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_9.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_2.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_14.webp&quot;);"></li><li class="item" style="background-image: url(&quot;https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_10.webp&quot;);"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"></use><use xlink:href="#gentle-wave" x="48" y="3"></use><use xlink:href="#gentle-wave" x="48" y="5"></use><use xlink:href="#gentle-wave" x="48" y="7"></use></g></svg></div><main><div class="inner"><div class="pjax" id="main"><div class="article wrap"><div class="breadcrumb" itemlistelement="" itemscope="" itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i><span><a href="/miyano/">首页</a></span><i class="ic i-angle-right"></i><span class="current" itemprop="itemListElement" itemscope="itemscope" itemtype="https://schema.org/ListItem"><a href="/miyano/categories/Playful-Exploration/" itemprop="item" rel="index" title="分类于整活探索"><span itemprop="name">整活探索<meta itemprop="position" content="0"></span></a></span></div><article class="post block" itemscope="itemscope" itemtype="http://schema.org/Article" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://ei4869.github.io/miyano/Playful-Exploration/shokaX%E4%B8%BB%E9%A2%98%E7%AC%94%E8%AE%B0/"><span hidden="hidden" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="image" content="/miyano/assets/ai-icon.webp"><meta itemprop="name" content="Rei"><meta itemprop="description" content=", "></span><span hidden="hidden" itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="自分の為に楽しめ世界"></span><div class="body md" itemprop="articleBody"><div class="tabs" id="summary"><div class="show-btn"></div><div class="nav"><ul class="special"></ul></div><div class="tab active" data-id="summary" data-title="自我介绍"><p>我是基于Kimi moonshot-v1-8k实现的AI助手，在此博客上负责整理和概括文章</p></div><div class="tab" data-id="summary" data-title="文章概括"><p>本文详细记录了shokaX主题的开发过程，重点介绍了AI总结配置接口的改进，解决了长文章处理和接口兼容性问题。通过提取与预处理、缓存管理、长文处理等步骤，提高了摘要生成的效率和准确性。具体包括读取Markdown原文、替换变量、解析成纯文本、利用本地JSON文件存储摘要和文本哈希、避免重复调用接口、对超过一定字符数的内容采用分块策略生成摘要等。此外，还讨论了自定义页面标题、随机主题图片、优化搜索栏和fancybox效果等方法，并通过修改配置文件和脚本实现页面标题自定义，更新首页和文章图片源，调整随机文章和评论显示数量等。还增加了文章加密插件，确保文章能够成功加密。这些开发记录和技巧有助于提升网站功能和用户体验，为读者提供了一套完整的shokaX主题开发指南。</p></div></div><details class="info"><summary>编辑记录</summary><div>
<div class="note info">
<p>2025-01-15 第一次编辑</p>
</div>
<ul>
<li>整理笔记</li>
</ul>
<div class="note info">
<p>2025-02-27 第二次编辑</p>
</div>
<ul>
<li>优化：搜索栏、字体、fancybox</li>
</ul>
<div class="note info">
<p>2025-02-28 第三次编辑</p>
</div>
<ul>
<li>优化：代码块和 tab 冲突问题</li>
</ul>
<div class="note info">
<p>2025-03-01 第四次编辑</p>
</div>
<ul>
<li>增加文章加密插件</li>
</ul>
<div class="note info">
<p>2025-03-02 第五次编辑</p>
</div>
<ul>
<li>增加 AI 总结的功能</li>
</ul>
<div class="note info">
<p>2025-03-04 第六次编辑</p>
</div>
<ul>
<li>优化 AI 总结</li>
</ul>
</div></details>
<hr>
<h1 id="安装过程"><a class="anchor" href="#安装过程">#</a> 安装过程</h1>
<p>主要参考官方的<a target="_blank" rel="noopener" href="https://docs.kaitaku.xyz/">文档</a>，安装通过如下命令：</p>
<figure class="highlight bash"><figcaption data-lang="bash"><span>安装命令</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>hexo init       <span class="token comment">#初始化 hexo</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">cd</span> your_blog    <span class="token comment">#转到博客目录</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span> shokax-cli <span class="token parameter variable">--location</span><span class="token operator">=</span>global     <span class="token comment">#全局安装</span></pre></td></tr><tr><td data-num="4"></td><td><pre>SXC <span class="token function">install</span> shokaX      <span class="token comment">#安装相关包和依赖</span></pre></td></tr></tbody></table></figure><p>接下来安装文档进行简单的初始配置。<br>
对于 <code>Hexo&gt;=7.0.0</code> ，需要停用停用默认代码高亮，</p>
<figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>syntax_highlighter: false</pre></td></tr><tr><td data-num="2"></td><td><pre>highlight:</pre></td></tr><tr><td data-num="3"></td><td><pre>  enable: false</pre></td></tr><tr><td data-num="4"></td><td><pre>  line_number: true</pre></td></tr><tr><td data-num="5"></td><td><pre>  auto_detect: false</pre></td></tr><tr><td data-num="6"></td><td><pre>  tab_replace: ''</pre></td></tr><tr><td data-num="7"></td><td><pre>  wrap: true</pre></td></tr><tr><td data-num="8"></td><td><pre>  hljs: false</pre></td></tr><tr><td data-num="9"></td><td><pre>prismjs:</pre></td></tr><tr><td data-num="10"></td><td><pre>  enable: false</pre></td></tr><tr><td data-num="11"></td><td><pre>  preprocess: true</pre></td></tr><tr><td data-num="12"></td><td><pre>  line_number: true</pre></td></tr><tr><td data-num="13"></td><td><pre>  tab_replace: ''</pre></td></tr></tbody></table></figure><div class="note info">
<p>注意在 <code>_config.yml</code>  中， <code>theme: shokaX</code> ，这里 X 要与 <code>_config.shokaX.yml</code>  中的一致即大写，否则 <code>hexo deploy</code>  部署后有问题主题渲染不出来。</p>
</div>
<h1 id="自动部署"><a class="anchor" href="#自动部署">#</a> 自动部署</h1>
<p>采用 <code>Github Pages</code>  进行自动部署，本个博客连接到之前的 Github 已有的存放博客代码的仓库中，作为新的分支<span class="pink"> shoka</span>，与之前的博客共同管理。</p>
<figure class="highlight bash"><figcaption data-lang="bash"><span>新建分支共同管理</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">cd</span> /path/to/原博客源码</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">git</span> checkout main</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">git</span> branch shoka</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token function">git</span> checkout shoka</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">git</span> commit --allow-empty <span class="token parameter variable">-m</span> <span class="token string">"Initialize empty shoka branch"</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token function">git</span> push origin shoka <span class="token parameter variable">--force</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token function">git</span> checkout main</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token builtin class-name">cd</span> /path/to/新博客源码</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">git</span> init</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">git</span> remote <span class="token function">add</span> origin <span class="token operator">&lt;</span>远程仓库URL<span class="token operator">&gt;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token function">git</span> checkout shoka</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"Initial commit for shoka blog"</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token function">git</span> push --set-upstream origin shoka</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token function">git</span> push origin shoka <span class="token parameter variable">--force</span></pre></td></tr></tbody></table></figure><p>自动部署，同时管理双博客的部署任务：</p>
<ul>
<li>如果为 push 触发，根据 push 的是哪个分支，设置哪个标志位为 <code>true</code> ，另一个则为 <code>false</code> 。</li>
<li>如果为 schedule 触发，则标志位都设置为 <code>true</code> ，顺序进行部署。</li>
<li>如果为手动触发，则可以选择部署哪一个或者同时部署。<br>
每个分支的部署按照同一套流程顺序执行，根据标志位判断是否执行。</li>
</ul>
<figure class="highlight yaml"><figcaption data-lang="YAML"><span>自动部署的工作流文件</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token key atrule">name</span><span class="token punctuation">:</span> 自动任务</pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">push</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">branches</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token punctuation">-</span> master</pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">-</span> shoka</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">release</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">types</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> published</pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">workflow_dispatch</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">inputs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token key atrule">branch</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token key atrule">description</span><span class="token punctuation">:</span> <span class="token string">"选择分支"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token key atrule">required</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token string">"shoka"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token key atrule">options</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          <span class="token punctuation">-</span> master</pre></td></tr><tr><td data-num="19"></td><td><pre>          <span class="token punctuation">-</span> shoka</pre></td></tr><tr><td data-num="20"></td><td><pre>          <span class="token punctuation">-</span> all</pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">schedule</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">-</span> <span class="token key atrule">cron</span><span class="token punctuation">:</span> <span class="token string">"0 16 * * *"</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token key atrule">jobs</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token key atrule">deploy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">steps</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 确定分支和标志位</pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token key atrule">id</span><span class="token punctuation">:</span> setup_flags</pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="32"></td><td><pre>          if [[ "$" == "workflow_dispatch" ]]; then</pre></td></tr><tr><td data-num="33"></td><td><pre>            SELECTED_BRANCH="$"</pre></td></tr><tr><td data-num="34"></td><td><pre>          elif [[ "$" == "schedule" ]]; then</pre></td></tr><tr><td data-num="35"></td><td><pre>            SELECTED_BRANCH="all"</pre></td></tr><tr><td data-num="36"></td><td><pre>          else</pre></td></tr><tr><td data-num="37"></td><td><pre>            SELECTED_BRANCH="$"</pre></td></tr><tr><td data-num="38"></td><td><pre>          fi</pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>          if <span class="token punctuation">[</span><span class="token punctuation">[</span> "$SELECTED_BRANCH" == "all" <span class="token punctuation">|</span><span class="token punctuation">|</span> "$SELECTED_BRANCH" == "master" <span class="token punctuation">]</span><span class="token punctuation">]</span>; then</pre></td></tr><tr><td data-num="41"></td><td><pre>            FLAG_MASTER=true</pre></td></tr><tr><td data-num="42"></td><td><pre>          else</pre></td></tr><tr><td data-num="43"></td><td><pre>            FLAG_MASTER=false</pre></td></tr><tr><td data-num="44"></td><td><pre>          fi</pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>          if <span class="token punctuation">[</span><span class="token punctuation">[</span> "$SELECTED_BRANCH" == "all" <span class="token punctuation">|</span><span class="token punctuation">|</span> "$SELECTED_BRANCH" == "shoka" <span class="token punctuation">]</span><span class="token punctuation">]</span>; then</pre></td></tr><tr><td data-num="47"></td><td><pre>            FLAG_SHOKA=true</pre></td></tr><tr><td data-num="48"></td><td><pre>          else</pre></td></tr><tr><td data-num="49"></td><td><pre>            FLAG_SHOKA=false</pre></td></tr><tr><td data-num="50"></td><td><pre>          fi</pre></td></tr><tr><td data-num="51"></td><td><pre></pre></td></tr><tr><td data-num="52"></td><td><pre>          echo "SELECTED_BRANCH=$SELECTED_BRANCH" <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> $GITHUB_ENV</pre></td></tr><tr><td data-num="53"></td><td><pre>          echo "FLAG_MASTER=$FLAG_MASTER" <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> $GITHUB_ENV</pre></td></tr><tr><td data-num="54"></td><td><pre>          echo "FLAG_SHOKA=$FLAG_SHOKA" <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> $GITHUB_ENV</pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 安装 Node</pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1</pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="59"></td><td><pre>          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">"20.x"</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 设置时区</pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> echo "TZ='Asia/Shanghai'" <span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span> $GITHUB_ENV</pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 配置 Git 用户信息</pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="66"></td><td><pre>          git config --global user.name "$"</pre></td></tr><tr><td data-num="67"></td><td><pre>          git config --global user.email "$"</pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token comment"># 执行 Master 分支任务</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 克隆 Master 分支</pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2</pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="74"></td><td><pre>          <span class="token key atrule">ref</span><span class="token punctuation">:</span> master</pre></td></tr><tr><td data-num="75"></td><td><pre></pre></td></tr><tr><td data-num="76"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 清除旧缓存（Master）</pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="79"></td><td><pre>          echo "Clearing old cache for Master branch..."</pre></td></tr><tr><td data-num="80"></td><td><pre>          rm -rf node_modules</pre></td></tr><tr><td data-num="81"></td><td><pre></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 缓存 Hexo（Master）</pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/cache@v1</pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token key atrule">id</span><span class="token punctuation">:</span> cache_master</pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="87"></td><td><pre>          <span class="token key atrule">path</span><span class="token punctuation">:</span> node_modules</pre></td></tr><tr><td data-num="88"></td><td><pre>          <span class="token key atrule">key</span><span class="token punctuation">:</span> $&lt;<span class="token tag">!--swig</span>￼6<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">-</span>master<span class="token punctuation">-</span>$&lt;<span class="token tag">!--swig</span>￼7<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 安装依赖（Master）</pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm install <span class="token punctuation">-</span><span class="token punctuation">-</span>save</pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 执行 Master 分支任务</pre></td></tr><tr><td data-num="95"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="97"></td><td><pre>          echo "Running tasks for Master branch..."</pre></td></tr><tr><td data-num="98"></td><td><pre>          node fix_kramed.js</pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 安装 Hexo（Master）</pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="102"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="103"></td><td><pre>          export TZ='Asia/Shanghai'</pre></td></tr><tr><td data-num="104"></td><td><pre>          npm install hexo-cli -g</pre></td></tr><tr><td data-num="105"></td><td><pre></pre></td></tr><tr><td data-num="106"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 生成静态文件（Master）</pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="108"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="109"></td><td><pre>          export TZ='Asia/Shanghai'</pre></td></tr><tr><td data-num="110"></td><td><pre>          hexo clean</pre></td></tr><tr><td data-num="111"></td><td><pre>          hexo generate</pre></td></tr><tr><td data-num="112"></td><td><pre>          gulp</pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 设置 SSH 密钥（Master）</pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> webfactory/ssh<span class="token punctuation">-</span>agent@v0.5.3</pre></td></tr><tr><td data-num="117"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="118"></td><td><pre>          <span class="token key atrule">ssh-private-key</span><span class="token punctuation">:</span> $&lt;<span class="token tag">!--swig</span>￼8<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 部署（Master）</pre></td></tr><tr><td data-num="121"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_MASTER == 'true'</pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> hexo deploy</pre></td></tr><tr><td data-num="123"></td><td><pre></pre></td></tr><tr><td data-num="124"></td><td><pre>      <span class="token comment"># 执行 Shoka 分支任务</span></pre></td></tr><tr><td data-num="125"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 克隆 Shoka 分支</pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="127"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2</pre></td></tr><tr><td data-num="128"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="129"></td><td><pre>          <span class="token key atrule">ref</span><span class="token punctuation">:</span> shoka</pre></td></tr><tr><td data-num="130"></td><td><pre></pre></td></tr><tr><td data-num="131"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 清除旧缓存（Shoka）</pre></td></tr><tr><td data-num="132"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="133"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="134"></td><td><pre>          echo "Clearing old cache for Shoka branch..."</pre></td></tr><tr><td data-num="135"></td><td><pre>          rm -rf node_modules</pre></td></tr><tr><td data-num="136"></td><td><pre></pre></td></tr><tr><td data-num="137"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 缓存 Hexo（Shoka）</pre></td></tr><tr><td data-num="138"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/cache@v1</pre></td></tr><tr><td data-num="140"></td><td><pre>        <span class="token key atrule">id</span><span class="token punctuation">:</span> cache_shoka</pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="142"></td><td><pre>          <span class="token key atrule">path</span><span class="token punctuation">:</span> node_modules</pre></td></tr><tr><td data-num="143"></td><td><pre>          <span class="token key atrule">key</span><span class="token punctuation">:</span> $&lt;<span class="token tag">!--swig</span>￼9<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span><span class="token punctuation">-</span>shoka<span class="token punctuation">-</span>$&lt;<span class="token tag">!--swig</span>￼10<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span></pre></td></tr><tr><td data-num="144"></td><td><pre></pre></td></tr><tr><td data-num="145"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 安装依赖（Shoka）</pre></td></tr><tr><td data-num="146"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="147"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> npm install <span class="token punctuation">-</span><span class="token punctuation">-</span>save</pre></td></tr><tr><td data-num="148"></td><td><pre></pre></td></tr><tr><td data-num="149"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 执行 Shoka 分支任务</pre></td></tr><tr><td data-num="150"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="151"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="152"></td><td><pre>          echo "Running tasks for Shoka branch..."</pre></td></tr><tr><td data-num="153"></td><td><pre>          node updateYaml.js</pre></td></tr><tr><td data-num="154"></td><td><pre>          echo "Contents of _images.yml:"</pre></td></tr><tr><td data-num="155"></td><td><pre>          cat ./themes/shokaX/_images.yml</pre></td></tr><tr><td data-num="156"></td><td><pre>          echo "Contents of _images_index.yml:"</pre></td></tr><tr><td data-num="157"></td><td><pre>          cat ./themes/shokaX/_images_index.yml</pre></td></tr><tr><td data-num="158"></td><td><pre>          ls -l source/_posts/*/cover.jpg || echo "No cover images found."</pre></td></tr><tr><td data-num="159"></td><td><pre></pre></td></tr><tr><td data-num="160"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 安装 Hexo（Shoka）</pre></td></tr><tr><td data-num="161"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="162"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="163"></td><td><pre>          export TZ='Asia/Shanghai'</pre></td></tr><tr><td data-num="164"></td><td><pre>          npm install hexo-cli -g</pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 生成静态文件（Shoka）</pre></td></tr><tr><td data-num="167"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="168"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></span></pre></td></tr><tr><td data-num="169"></td><td><pre>          export TZ='Asia/Shanghai'</pre></td></tr><tr><td data-num="170"></td><td><pre>          hexo clean</pre></td></tr><tr><td data-num="171"></td><td><pre>          hexo generate</pre></td></tr><tr><td data-num="172"></td><td><pre>          hexo algolia</pre></td></tr><tr><td data-num="173"></td><td><pre></pre></td></tr><tr><td data-num="174"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 设置 SSH 密钥（Shoka）</pre></td></tr><tr><td data-num="175"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="176"></td><td><pre>        <span class="token key atrule">uses</span><span class="token punctuation">:</span> webfactory/ssh<span class="token punctuation">-</span>agent@v0.5.3</pre></td></tr><tr><td data-num="177"></td><td><pre>        <span class="token key atrule">with</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="178"></td><td><pre>          <span class="token key atrule">ssh-private-key</span><span class="token punctuation">:</span> $&lt;<span class="token tag">!--swig</span>￼11<span class="token punctuation">-</span><span class="token punctuation">-</span><span class="token punctuation">&gt;</span></pre></td></tr><tr><td data-num="179"></td><td><pre></pre></td></tr><tr><td data-num="180"></td><td><pre>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 部署（Shoka）</pre></td></tr><tr><td data-num="181"></td><td><pre>        <span class="token key atrule">if</span><span class="token punctuation">:</span> env.FLAG_SHOKA == 'true'</pre></td></tr><tr><td data-num="182"></td><td><pre>        <span class="token key atrule">run</span><span class="token punctuation">:</span> hexo deploy</pre></td></tr></tbody></table></figure><h1 id="统计网站运行时间"><a class="anchor" href="#统计网站运行时间">#</a> 统计网站运行时间</h1>
<p>创建文件： <code>themes\shokaX\source\js\create-time.js</code> :</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>create-time.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">createtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> createTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">"2025/01/02 00:00:00"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 替换为您的站点创建时间</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">const</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">const</span> diff <span class="token operator">=</span> now <span class="token operator">-</span> createTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">const</span> days <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>diff <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">const</span> hours <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>diff <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">const</span> minutes <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>diff <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">const</span> seconds <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>diff <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> </pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">此站已存活 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>days<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 天 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hours<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 小时 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>minutes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 分 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>seconds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 秒</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token function">setInterval</span><span class="token punctuation">(</span>createtime<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>创建文件： <code>themes\shokaX\layout\_partials\create-time.pug</code> :</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>create-time.pug</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">div</span><span class="token punctuation">(</span>style<span class="token operator">=</span><span class="token string">"width: 100%; text-align: center;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token function">span</span><span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token string">"time"</span><span class="token punctuation">)</span> 此站已存活 <span class="token number">0</span> 天 <span class="token number">0</span> 小时 <span class="token number">0</span> 分 <span class="token number">0</span> 秒</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">script</span><span class="token punctuation">(</span>src<span class="token operator">=</span><span class="token string">"/miyano/js/create-time.js"</span> defer<span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><div class="note info">
<p>这里由于我的博客的 <code>Github Pages</code>  部署在仓库 <code>miyano</code>  中，所以默认的地址一般有多个 <code>/miyano</code> 。需要加上否则找不到文件路径。</p>
</div>
<p>最后在 <code>themes\shokaX\layout\_partials\footer.pug</code>  中第一行新增代码 <code>include create-time.pug</code>  即可引入站点存活时间。</p>
<h1 id="实现相册功能"><a class="anchor" href="#实现相册功能">#</a> 实现相册功能</h1>
<h2 id="相册主页面配置"><a class="anchor" href="#相册主页面配置">#</a> <span class="blue">相册</span>主页面配置</h2>
<ol>
<li>创建 <code>source\_data\gallery.yml</code>  用于存放相册数据，方便配置。格式为：</li>
</ol>
<figure class="highlight yaml"><figcaption data-lang="YAML"><span>相册数据格式gallery.yml</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token key atrule">gallery_groups</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> KON</pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">descr</span><span class="token punctuation">:</span> KON一生推，毕业不是终点，今后也都是朋友。</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /miyano/gallery/kon/</pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/kon_16.webp"</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">photos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/kon_16.webp"</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Summer Pockets</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">descr</span><span class="token punctuation">:</span> 还记得那个夏天吗？那份炫目，别忘了口袋里的夏天。</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> /miyano/gallery/sp/</pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">img</span><span class="token punctuation">:</span> <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/sp_3.webp"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">photos</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/sp_4.webp"</span></pre></td></tr></tbody></table></figure><p>注意这里配置了 <code>id</code>  为 <code>gallery_groups</code> 。</p>
<ol start="2">
<li>创建 <code>themes\shokaX\layout\gallery.pug</code>  生成一个相册页面，展示多个相册组。</li>
</ol>
<figure class="highlight pug"><figcaption data-lang="pug"><span>gallery.pug</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">extends ./_partials/layout.pug</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">block content</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token tag">div<span class="token attr-id">#gallery-container</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//- h1.page-title 相册</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag">div<span class="token attr-class">.gallery-group-main</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> group <span class="token keyword">in</span></span> page<span class="token punctuation">.</span>posts </span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value">group<span class="token punctuation">.</span>url target<span class="token operator">=</span><span class="token string">"_blank"</span></span><span class="token punctuation">)</span></span></span> </pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token tag">figure<span class="token attr-class">.gallery-group</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token tag">img<span class="token attr-class">.gallery-group-img</span><span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value">group<span class="token punctuation">.</span>img alt<span class="token operator">=</span>group<span class="token punctuation">.</span>name</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token tag">figcaption</span></pre></td></tr><tr><td data-num="12"></td><td><pre>              <span class="token tag">div<span class="token attr-class">.gallery-group-name</span></span><span class="token punctuation">=</span><span class="token code"> group<span class="token punctuation">.</span>name</span></pre></td></tr><tr><td data-num="13"></td><td><pre>              <span class="token tag">p</span><span class="token punctuation">=</span><span class="token code"> group<span class="token punctuation">.</span>descr</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">include _partials/pagination.pug</span></pre></td></tr></tbody></table></figure><p>使用 <code>each</code>  循环遍历 <code>page.posts</code>  中的每个相册组，并为每个相册组生成一个链接和相应的内容； <code>a(href=group.url target="_blank")</code> ：为每个相册组生成一个链接，链接地址为 <code>group.url</code> ，并在新标签页中打开；定义一个 <code>figcaption</code>  元素，用于包含相册组的标题和描述；包含 <code>_partials/pagination.pug</code>  文件，用于添加分页功能。</p>
<ol start="3">
<li>创建 <code>themes\shokaX\scripts\inject-gallery.js</code>  用于在生成静态网站时注入相册数据。将相册组数据注入到当前页面的本地变量 <code>locals.page.gallery_groups</code>  中，从而实现了在相册页面中动态加载相册数据的功能。</li>
</ol>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>inject-gallery.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> yaml <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'js-yaml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>filter<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'template_locals'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">locals</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>locals<span class="token punctuation">.</span>page<span class="token punctuation">.</span>layout <span class="token operator">===</span> <span class="token string">'gallery'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">const</span> galleryDataPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>hexo<span class="token punctuation">.</span>source_dir<span class="token punctuation">,</span> <span class="token string">'_data/gallery.yml'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token keyword">const</span> data <span class="token operator">=</span> yaml<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>galleryDataPath<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">.</span>gallery_groups<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        locals<span class="token punctuation">.</span>page<span class="token punctuation">.</span>gallery_groups <span class="token operator">=</span> data<span class="token punctuation">.</span>gallery_groups<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        locals<span class="token punctuation">.</span>page<span class="token punctuation">.</span>gallery_groups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error loading gallery.yml:'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      locals<span class="token punctuation">.</span>page<span class="token punctuation">.</span>gallery_groups <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><div class="note info">
<p>需要在 <code>gallery</code>  的 <code>index.md</code>  配置好 <code>layout: gallery</code></p>
</div>
<ol start="3">
<li>创建 <code>themes\shokaX\source\css\_common\components\tags\gallery.styl</code>  用于设置相册页面的排列样式，效果是实现网格布局，每行最多显示三个相册，每个相册占据相等的宽度，鼠标悬停时有过渡效果显示相册描述。并对移动端单独适配，对于移动端一行只显示一个相册。该文件在 <code>themes\shokaX\source\css\_common\components\components.styl</code>  中引入： <code>@import 'tags/gallery';</code></li>
</ol>
<figure class="highlight stylus"><figcaption data-lang="stylus"><span>gallery.styl</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token selector"><span class="token comment">/* 限制 Gallery 样式作用域 */</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>.gallery-group-main</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property-declaration"><span class="token property">display</span> grid</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property-declaration"><span class="token property">grid-template-columns</span> <span class="token func"><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token unit">fr</span><span class="token punctuation">)</span> </span><span class="token comment">// 每行最多三个相册</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token property-declaration"><span class="token property">gap</span> <span class="token number">20</span><span class="token unit">px</span> <span class="token comment">// 调整相册间距，确保布局更美观</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token property-declaration"><span class="token property">justify-items</span> center <span class="token comment">// 确保相册内容在单元格内居中</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token property-declaration"><span class="token property">padding</span> <span class="token number">20</span><span class="token unit">px</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token comment">/* 移动端适配 */</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token atrule-declaration"><span class="token atrule">@media</span> <span class="token punctuation">(</span>max-width<span class="token punctuation">:</span> <span class="token number">768</span><span class="token unit">px</span><span class="token punctuation">)</span> <span class="token comment">// 当屏幕宽度小于 768px 时</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token property-declaration"><span class="token property">grid-template-columns</span> <span class="token number">1</span><span class="token unit">fr</span> <span class="token comment">// 每行一个相册，按列排列</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token property-declaration"><span class="token property">gap</span> <span class="token number">15</span><span class="token unit">px</span> <span class="token comment">// 调整相册间距，适应窄屏布局</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token property-declaration"><span class="token property">padding</span> <span class="token number">10</span><span class="token unit">px</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token selector"><span class="token comment">/* 针对 Gallery 内的 Figure */</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>.gallery-group-main figure.gallery-group</pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token property-declaration"><span class="token property">position</span> relative</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token property-declaration"><span class="token property">width</span> <span class="token number">100</span><span class="token unit">%</span> <span class="token comment">// 使相册占满单元格宽度</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token property-declaration"><span class="token property">max-width</span> <span class="token number">300</span><span class="token unit">px</span> <span class="token comment">// 设置最大宽度，避免相册过大</span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token property-declaration"><span class="token property">aspect-ratio</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">1</span> <span class="token comment">// 确保相册为正方形</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token property-declaration"><span class="token property">border-radius</span> <span class="token number">8</span><span class="token unit">px</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token property-declaration"><span class="token property">background</span> <span class="token hexcode">#000000</span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token property-declaration"><span class="token property">overflow</span> hidden</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token property-declaration"><span class="token property">transition</span> transform <span class="token number">0.3</span><span class="token unit">s</span><span class="token punctuation">,</span> box-shadow <span class="token number">0.3</span><span class="token unit">s</span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token property-declaration"><span class="token property">box-shadow</span> <span class="token number">0</span> <span class="token number">4</span><span class="token unit">px</span> <span class="token number">6</span><span class="token unit">px</span> <span class="token func"><span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token property-declaration"><span class="token property">cursor</span> pointer</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token selector">&amp;:hover</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token property-declaration"><span class="token property">transform</span> <span class="token func"><span class="token function">translateY</span><span class="token punctuation">(</span><span class="token number">-5</span><span class="token unit">px</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token property-declaration"><span class="token property">box-shadow</span> <span class="token number">0</span> <span class="token number">8</span><span class="token unit">px</span> <span class="token number">12</span><span class="token unit">px</span> <span class="token func"><span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token selector">img</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token property-declaration"><span class="token property">opacity</span> <span class="token number">0.4</span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token selector">figcaption</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token property-declaration"><span class="token property">opacity</span> <span class="token number">1</span></span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token selector"><span class="token comment">/* Gallery 内的 Image */</span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>.gallery-group-main img.gallery-group-img</pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token property-declaration"><span class="token property">width</span> <span class="token number">100</span><span class="token unit">%</span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token property-declaration"><span class="token property">height</span> <span class="token number">100</span><span class="token unit">%</span></span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token property-declaration"><span class="token property">object-fit</span> cover</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token property-declaration"><span class="token property">transition</span> opacity <span class="token number">0.3</span><span class="token unit">s</span> ease</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token selector"><span class="token comment">/* Gallery 的 Caption 容器 */</span></span></pre></td></tr><tr><td data-num="45"></td><td><pre>.gallery-group-main figcaption</pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token property-declaration"><span class="token property">position</span> absolute</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token property-declaration"><span class="token property">bottom</span> <span class="token number">0</span></span></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token property-declaration"><span class="token property">left</span> <span class="token number">0</span></span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token property-declaration"><span class="token property">width</span> <span class="token number">100</span><span class="token unit">%</span></span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token property-declaration"><span class="token property">padding</span> <span class="token number">15</span><span class="token unit">px</span></span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token property-declaration"><span class="token property">background</span> <span class="token func"><span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token property-declaration"><span class="token property">color</span> <span class="token hexcode">#fff</span></span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token property-declaration"><span class="token property">opacity</span> <span class="token number">0</span></span></pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token property-declaration"><span class="token property">transition</span> opacity <span class="token number">0.3</span><span class="token unit">s</span> ease-<span class="token operator">in</span>-out</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>  <span class="token selector">.gallery-group-name</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token property-declaration"><span class="token property">margin</span> <span class="token number">0</span></span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token property-declaration"><span class="token property">font-size</span> <span class="token number">1.2</span><span class="token unit">em</span></span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token property-declaration"><span class="token property">line-height</span> <span class="token number">1.4</span></span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token property-declaration"><span class="token property">font-weight</span> bold</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token property-declaration"><span class="token property">text-shadow</span> <span class="token number">0</span> <span class="token number">2</span><span class="token unit">px</span> <span class="token number">4</span><span class="token unit">px</span> <span class="token func"><span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token selector">.gallery-group-descr</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token property-declaration"><span class="token property">margin</span> <span class="token number">10</span><span class="token unit">px</span> <span class="token number">0</span> <span class="token number">0</span></span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token property-declaration"><span class="token property">font-size</span> <span class="token number">0.9</span><span class="token unit">em</span></span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token property-declaration"><span class="token property">line-height</span> <span class="token number">1.4</span></span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token property-declaration"><span class="token property">text-shadow</span> <span class="token number">0</span> <span class="token number">2</span><span class="token unit">px</span> <span class="token number">4</span><span class="token unit">px</span> <span class="token func"><span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span></span></span></pre></td></tr></tbody></table></figure><ol start="4">
<li>调整 <code>themes\shokaX\source\css\_common\outline\sidebar\sidebar.styl</code>  对相册页面的侧边栏进行调整：取消侧边栏，位置由主页面占据。<br>
大约在原文件<span class="green"> 40-44</span> 新增:</li>
</ol>
<figure class="highlight stylus"><figcaption data-lang="stylus"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token selector"><span class="token comment">// 新增：gallery 页面隐藏 sidebar</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>body.gallery #sidebar <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property-declaration"><span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>在原文件<span class="green"> 74-89</span> 新增：</p>
<figure class="highlight stylus"><figcaption data-lang="stylus"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token selector"><span class="token comment">// 新增：gallery 页面 pjax 全宽</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>body.gallery .pjax <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token property-declaration"><span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">%</span><span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token property-declaration"><span class="token property">max-width</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">%</span><span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token property-declaration"><span class="token property">flex</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token selector"><span class="token comment">// 如果需要支持 flex 布局的全宽调整</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>.inner <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token selector"><span class="token comment">//gallery 页面全宽覆盖逻辑</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>  body.gallery &amp; &gt; .pjax <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token property-declaration"><span class="token property">flex</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token property-declaration"><span class="token property">max-width</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">%</span><span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><ol start="5">
<li>第<span class="yellow"> 4</span> 点需要指明相册页面的 body 的类 <code>class</code>  为 <code>gallery</code>  才能生效，且为了防止<em> PJAX</em> 导致的其他页面同步配置该效果，需要在 <code>themes\shokaX\source\js\_app\pjax\siteInit.ts</code>  中进行配置。</li>
</ol>
<figure class="highlight typescript"><figcaption data-lang="typescript"><span>siteinit.ts</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> domInit <span class="token keyword">from</span> <span class="token string">'./domInit'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> pjaxReload<span class="token punctuation">,</span> siteRefresh <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./refresh'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> cloudflareInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../components/cloudflare'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">BODY</span><span class="token punctuation">,</span> <span class="token constant">CONFIG</span><span class="token punctuation">,</span> pjax<span class="token punctuation">,</span> setPjax<span class="token punctuation">,</span> setSiteSearch<span class="token punctuation">,</span> siteSearch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../globals/globalVars'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> autoDarkmode<span class="token punctuation">,</span> themeColorListener <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../globals/themeColor'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> resizeHandle<span class="token punctuation">,</span> scrollHandle<span class="token punctuation">,</span> visibilityListener <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../globals/handles'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> pagePosition <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../globals/tools'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> Pjax <span class="token keyword">from</span> <span class="token string">'theme-shokax-pjax'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> initVue <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/vue'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> $dom <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/dom'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> createChild <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/proto'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> transition <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/anime'</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="13"></td><td><pre><span class="token keyword">import</span> initializeGallery <span class="token keyword">from</span> <span class="token string">'../library/gallery'</span><span class="token punctuation">;</span> <span class="token comment">// 替换为实际路径</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="15"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">updateGalleryPageLayout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="16"></td><td><pre>  <span class="token keyword">const</span> body <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="17"></td><td><pre>  <span class="token keyword">const</span> footer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"footer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="18"></td><td><pre>  <span class="token keyword">const</span> main <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="19"></td><td><pre>  <span class="token keyword">const</span> headerAlternate <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#header .artboard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="20"></td><td><pre>  <span class="token keyword">const</span> headerTitle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#header .title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="21"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="22"></td><td><pre>  <span class="token keyword">const</span> HeaderMsgConfigPath <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取配置了 Header 参数的页面路径</span></pre></td></tr><tr class="marked"><td data-num="23"></td><td><pre>  <span class="token keyword">const</span> HeaderMsgConfig <span class="token operator">=</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>pages<span class="token punctuation">[</span>HeaderMsgConfigPath<span class="token operator">+</span><span class="token string">'index.html'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 从页面元数据中获取当前页面配置</span></pre></td></tr><tr class="marked"><td data-num="24"></td><td><pre>  <span class="token comment">//console.log ("当前页面配置:", HeaderMsgConfig);</span></pre></td></tr><tr class="marked"><td data-num="25"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="26"></td><td><pre>  <span class="token keyword">const</span> DefaultHeaderMsgConfig <span class="token operator">=</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>headerMsg</pre></td></tr><tr class="marked"><td data-num="27"></td><td><pre>  <span class="token comment">//console.log ("默认页面配置:", DefaultHeaderMsgConfig);</span></pre></td></tr><tr class="marked"><td data-num="28"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="29"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'/gallery'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="30"></td><td><pre>    body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"gallery"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="31"></td><td><pre>    </pre></td></tr><tr class="marked"><td data-num="32"></td><td><pre>    <span class="token comment">// 隐藏 footer</span></pre></td></tr><tr class="marked"><td data-num="33"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>footer<span class="token punctuation">)</span> footer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">"none"</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="34"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="35"></td><td><pre>    <span class="token comment">// 调整 main 的 margin-bottom</span></pre></td></tr><tr class="marked"><td data-num="36"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> main<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginBottom <span class="token operator">=</span> <span class="token string">"0px"</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="37"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="38"></td><td><pre>    <span class="token comment">// 如果页面配置了自定义字段，则动态更新 header</span></pre></td></tr><tr class="marked"><td data-num="39"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>HeaderMsgConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="40"></td><td><pre>      <span class="token keyword">const</span> <span class="token punctuation">{</span> alternate<span class="token punctuation">,</span> headerTitle<span class="token operator">:</span> pageTitle <span class="token punctuation">}</span> <span class="token operator">=</span> HeaderMsgConfig<span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="41"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>headerAlternate <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">)</span> headerAlternate<span class="token punctuation">.</span>textContent <span class="token operator">=</span> alternate<span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="42"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>headerTitle <span class="token operator">&amp;&amp;</span> pageTitle<span class="token punctuation">)</span> headerTitle<span class="token punctuation">.</span>textContent <span class="token operator">=</span> pageTitle<span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="43"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr class="marked"><td data-num="44"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="45"></td><td><pre>    <span class="token function">initializeGallery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="46"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="47"></td><td><pre>    body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"gallery"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="48"></td><td><pre>    <span class="token comment">// 恢复 footer 的显示</span></pre></td></tr><tr class="marked"><td data-num="49"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>footer<span class="token punctuation">)</span> footer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="50"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="51"></td><td><pre>    <span class="token comment">// 恢复 main 的 margin-bottom</span></pre></td></tr><tr class="marked"><td data-num="52"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> main<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginBottom <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="53"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="54"></td><td><pre>    <span class="token comment">// 恢复默认 header 内容</span></pre></td></tr><tr class="marked"><td data-num="55"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DefaultHeaderMsgConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="56"></td><td><pre>      <span class="token keyword">const</span> <span class="token punctuation">{</span> alternate<span class="token punctuation">,</span> headerTitle<span class="token operator">:</span> pageTitle <span class="token punctuation">}</span> <span class="token operator">=</span> DefaultHeaderMsgConfig<span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="57"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>headerAlternate <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">)</span> headerAlternate<span class="token punctuation">.</span>textContent <span class="token operator">=</span> alternate<span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="58"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>headerTitle <span class="token operator">&amp;&amp;</span> pageTitle<span class="token punctuation">)</span> headerTitle<span class="token punctuation">.</span>textContent <span class="token operator">=</span> pageTitle<span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="59"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr class="marked"><td data-num="60"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr class="marked"><td data-num="61"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="62"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="63"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">updateAnimePageLayout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="64"></td><td><pre>  <span class="token keyword">const</span> comment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"comments"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="65"></td><td><pre>  <span class="token keyword">const</span> main <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="66"></td><td><pre>  <span class="token keyword">const</span> footer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"footer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="67"></td><td><pre>  <span class="token keyword">const</span> ffooter <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'footer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="68"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'/anime'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="69"></td><td><pre>    <span class="token comment">// 隐藏 footer</span></pre></td></tr><tr class="marked"><td data-num="70"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">)</span> comment<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">"none"</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="71"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>footer<span class="token punctuation">)</span> footer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">"none"</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="72"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ffooter<span class="token punctuation">)</span> ffooter<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">"none"</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="73"></td><td><pre>    <span class="token comment">// 调整 main 的 margin-bottom</span></pre></td></tr><tr class="marked"><td data-num="74"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> main<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginBottom <span class="token operator">=</span> <span class="token string">"0px"</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="75"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="76"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'/gallery'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr class="marked"><td data-num="77"></td><td><pre>      <span class="token comment">// 恢复 footer 的显示</span></pre></td></tr><tr class="marked"><td data-num="78"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">)</span> comment<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="79"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>footer<span class="token punctuation">)</span> footer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="80"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>ffooter<span class="token punctuation">)</span> ffooter<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="81"></td><td><pre>      <span class="token comment">// 恢复 main 的 margin-bottom</span></pre></td></tr><tr class="marked"><td data-num="82"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> main<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginBottom <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="83"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr class="marked"><td data-num="84"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr class="marked"><td data-num="85"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre></pre></td></tr><tr><td data-num="87"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">siteInit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token function">initVue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token function">domInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token function">setPjax</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Pjax</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="92"></td><td><pre>    selectors<span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="93"></td><td><pre>      <span class="token string">'head title'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="94"></td><td><pre>      <span class="token string">'.languages'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      <span class="token string">'.twikoo'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="96"></td><td><pre>      <span class="token string">'.pjax'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="97"></td><td><pre>      <span class="token string">'.leancloud-recent-comment'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      <span class="token string">'script[data-config]'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    cacheBust<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>  <span class="token constant">CONFIG</span><span class="token punctuation">.</span>quicklink<span class="token punctuation">.</span>ignores <span class="token operator">=</span> <span class="token constant">LOCAL</span><span class="token punctuation">.</span>ignores<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'quicklink'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> listen <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>quicklink<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token function">autoDarkmode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre></pre></td></tr><tr><td data-num="110"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__shokax_VL__<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token function">visibilityListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="113"></td><td><pre>  <span class="token function">themeColorListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__shokax_search__<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="116"></td><td><pre>    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'li.item.search &gt; i'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="117"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>search <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>siteSearch<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="122"></td><td><pre>        <span class="token function">setSiteSearch</span><span class="token punctuation">(</span><span class="token function">createChild</span><span class="token punctuation">(</span><span class="token constant">BODY</span><span class="token punctuation">,</span> <span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="123"></td><td><pre>          id<span class="token operator">:</span> <span class="token string">'search'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="124"></td><td><pre>          innerHTML<span class="token operator">:</span> <span class="token string">'&lt;div class="inner"&gt;&lt;div class="header"&gt;&lt;span class="icon"&gt;&lt;i class="ic i-search"&gt;&lt;/i&gt;&lt;/span&gt;&lt;div class="search-input-container"&gt;&lt;/div&gt;&lt;span class="close-btn"&gt;&lt;i class="ic i-times-circle"&gt;&lt;/i&gt;&lt;/span&gt;&lt;/div&gt;&lt;div class="results"&gt;&lt;div class="inner"&gt;&lt;div id="search-stats"&gt;&lt;/div&gt;&lt;div id="search-hits"&gt;&lt;/div&gt;&lt;div id="search-pagination"&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="125"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="127"></td><td><pre></pre></td></tr><tr><td data-num="128"></td><td><pre>      <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'../page/search'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{</span> algoliaSearch <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="129"></td><td><pre>        <span class="token function">algoliaSearch</span><span class="token punctuation">(</span>pjax<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre></pre></td></tr><tr><td data-num="132"></td><td><pre>      $dom<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token string">'.search'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="133"></td><td><pre>        element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="134"></td><td><pre>          document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflow <span class="token operator">=</span> <span class="token string">'hidden'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>          <span class="token function">transition</span><span class="token punctuation">(</span>siteSearch<span class="token punctuation">,</span> <span class="token string">'shrinkIn'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="136"></td><td><pre>            <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.search-input'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLInputElement<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">focus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> once<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> capture<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>__shokax_fireworks__<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="144"></td><td><pre>    <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'mouse-firework'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>firework<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="145"></td><td><pre>      firework<span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>fireworks<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="148"></td><td><pre></pre></td></tr><tr class="marked"><td data-num="149"></td><td><pre>  <span class="token comment">// 初始化时更新 gallery 页面布局</span></pre></td></tr><tr class="marked"><td data-num="150"></td><td><pre>  <span class="token function">updateGalleryPageLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="151"></td><td><pre>  <span class="token function">updateAnimePageLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> scrollHandle<span class="token punctuation">,</span> <span class="token punctuation">{</span> passive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> resizeHandle<span class="token punctuation">,</span> <span class="token punctuation">{</span> passive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pjax:send'</span><span class="token punctuation">,</span> pjaxReload<span class="token punctuation">,</span> <span class="token punctuation">{</span> passive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre></pre></td></tr><tr><td data-num="156"></td><td><pre>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'pjax:success'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="157"></td><td><pre>    <span class="token function">siteRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr class="marked"><td data-num="158"></td><td><pre>    <span class="token function">updateGalleryPageLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PJAX 切换完成后更新布局</span></pre></td></tr><tr class="marked"><td data-num="159"></td><td><pre>    <span class="token function">updateAnimePageLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> passive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre></pre></td></tr><tr><td data-num="162"></td><td><pre>  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeunload'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="163"></td><td><pre>    <span class="token function">pagePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre>  <span class="token keyword">await</span> <span class="token function">siteRefresh</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre></pre></td></tr><tr><td data-num="169"></td><td><pre><span class="token function">cloudflareInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre>window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'DOMContentLoaded'</span><span class="token punctuation">,</span> siteInit<span class="token punctuation">,</span> <span class="token punctuation">{</span> passive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre></pre></td></tr><tr><td data-num="173"></td><td><pre><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'%c Theme.ShokaX v'</span> <span class="token operator">+</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>version <span class="token operator">+</span> <span class="token string">' %c https://github.com/theme-shoka-x/hexo-theme-shokaX '</span><span class="token punctuation">,</span> <span class="token string">'color: white; background: #e9546b; padding:5px 0;'</span><span class="token punctuation">,</span> <span class="token string">'padding:4px;border:1px solid #e9546b;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>先只关注这里的：</p>
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'/gallery'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'gallery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">'gallery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>实现了动态切换类名。然后在 <code>siteInit</code>  函数中初始化时调用 <code>updateGalleryPageLayout();</code> ，在<em> PJAX</em> 切换完成后更新： <code>在 window.addEventListener('pjax:success', ...)</code>  中调用 <code>updateGalleryPageLayout();</code> ，确保切换页面时动态更新类名。<br>
并且同时使相册页面不显示 <code>footer</code> ，使 <code>&lt;main&gt;...&lt;/main&gt;</code>  容器可以适当向下增加空间。当处于 <code>gallery</code>  界面时隐藏 <code>footer</code>  并使 <code>main</code>  和底部边缘为 <code>0</code> ，否则恢复原样。</p>
<ol start="6">
<li>添加分页按钮<br>
创建文件： <code>themes\shokaX\scripts\generaters\gallery.js</code> ，用于处理分页逻辑，前面已经在 <code>themes\shokaX\layout\gallery.pug</code>  中引入了原来的分页布局： <code>include _partials/pagination.pug</code> ，并且已经有 <code>themes\shokaX\source\css\_common\scaffolding\pagination.styl</code>  文件。不用另外配置。</li>
</ol>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>gallery.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> pagination <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'hexo-pagination'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// 主相册页面生成</span></pre></td></tr><tr><td data-num="5"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>generator<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'gallery'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">locals</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment">// 确保读取 gallery_groups 下的数据</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">const</span> galleryGroups <span class="token operator">=</span> <span class="token punctuation">(</span>locals<span class="token punctuation">.</span>data<span class="token punctuation">.</span>gallery <span class="token operator">&amp;&amp;</span> locals<span class="token punctuation">.</span>data<span class="token punctuation">.</span>gallery<span class="token punctuation">.</span>gallery_groups<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>galleryGroups<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Gallery data is empty. Check your gallery.yml file.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">pagination</span><span class="token punctuation">(</span><span class="token string">'/gallery'</span><span class="token punctuation">,</span> galleryGroups<span class="token punctuation">,</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token literal-property property">perPage</span><span class="token operator">:</span> hexo<span class="token punctuation">.</span>config<span class="token punctuation">.</span>per_page <span class="token operator">||</span> <span class="token number">6</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token literal-property property">layout</span><span class="token operator">:</span> <span class="token string">'gallery'</span><span class="token punctuation">,</span>    <span class="token comment">// 使用 gallery.pug 模板</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token literal-property property">gallery</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 标记为相册页面</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>以上代码用于生成分页数据。在 <code>themes\shokaX\layout\gallery.pug</code>  通过 <code>page.posts</code>  读取分页数据并渲染分页数据。</p>
<h2 id="相册子页面配置"><a class="anchor" href="#相册子页面配置">#</a> <span class="blue">相册</span>子页面配置</h2>
<ol>
<li>创建文件： <code>themes\shokaX\layout\gallery-item.pug</code> ，用于生成一个相册组页面，展示相册组中的所有照片。</li>
</ol>
<figure class="highlight pug"><figcaption data-lang="pug"><span>gallery-item.pug</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">extends ./_partials/layout.pug</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">block content</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token tag">div<span class="token attr-class">.gallery-container</span><span class="token attr-class">.gallery-items</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> photo <span class="token keyword">in</span></span> page<span class="token punctuation">.</span>photos</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token tag">a<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">href</span><span class="token punctuation">=</span><span class="token attr-value">photo <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"gallery-item"</span> data<span class="token operator">-</span>src<span class="token operator">=</span>photo</span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token tag">img<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value">photo alt<span class="token operator">=</span>page<span class="token punctuation">.</span>group<span class="token punctuation">.</span>name title<span class="token operator">=</span>page<span class="token punctuation">.</span>group<span class="token punctuation">.</span>descr loading<span class="token operator">=</span><span class="token string">"lazy"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr></tbody></table></figure><ol start="2">
<li><code>themes\shokaX\scripts\generaters\gallery.js</code>  中・增加代码传递 yml 的相册数据到 <code>gallery-item.pug</code>  被读取。</li>
</ol>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>gallery.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment">// 子相册页面生成</span></pre></td></tr><tr><td data-num="2"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>generator<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'galleryPages'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">locals</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">const</span> galleryGroups <span class="token operator">=</span> <span class="token punctuation">(</span>locals<span class="token punctuation">.</span>data<span class="token punctuation">.</span>gallery <span class="token operator">&amp;&amp;</span> locals<span class="token punctuation">.</span>data<span class="token punctuation">.</span>gallery<span class="token punctuation">.</span>gallery_groups<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  </pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">return</span> galleryGroups<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">group</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 确保 photos 是字符串数组</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">const</span> photos <span class="token operator">=</span> group<span class="token punctuation">.</span>photos <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 不再需要解析对象，直接返回数组内容</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 根据 URL 提取唯一标识符</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// const groupId = group.url.split('/').filter((part) =&gt; part).pop();</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>group<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'/miyano'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 由于获取的 url 里已经含有 '/miyano' 导致重复，需要去掉。</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token literal-property property">layout</span><span class="token operator">:</span> <span class="token string">'gallery-item'</span><span class="token punctuation">,</span> <span class="token comment">// 使用 gallery-item.pug 模板</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        group<span class="token punctuation">,</span>      <span class="token comment">// 传递 group 数据</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        photos<span class="token punctuation">,</span>     <span class="token comment">// 直接传递字符串数组的 photos</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">//id: groupId // 传递唯一的 id</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><ol start="3">
<li>实现相册集内图片的自动自适应布局以及灯箱功能，查看文档：<a target="_blank" rel="noopener" href="https://github.com/miromannino/Justified-Gallery">Justified-Gallery</a> 和<a target="_blank" rel="noopener" href="https://www.lightgalleryjs.com/"> lightgallery</a> 进行实现。<br>
依赖的文件有：</li>
</ol>
<ul>
<li><strong>CSS 文件</strong>:</li>
</ul>
<figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/lightgallery/css/lightgallery.min.css<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></pre></td></tr></tbody></table></figure><ul>
<li><strong>JS 文件</strong>:</li>
</ul>
<figure class="highlight html"><figcaption data-lang="HTML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/lightgallery/lightgallery.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/lightgallery/plugins/zoom/lg-zoom.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.jsdelivr.net/npm/lightgallery/plugins/thumbnail/lg-thumbnail.min.js<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span></pre></td></tr></tbody></table></figure><p>需要创建文件 <code>themes\shokaX\source\js\_app\library\gallery.ts</code>  实现，动态导入了以上的 css 和 js 文件 (注意到其实 <code>shokaX</code>  已经实现的 <code>fancybox</code>  就是利用了 <code>justifiedGallery</code> ，并且已在 <code>_config.shokaX.yml</code>  中的 <code>vendors</code>  中引入了)。这里模仿了 <code>themes\shokaX\source\js\_app\page\fancybox.ts</code>  使用的方法。</p>
<figure class="highlight typescript"><figcaption data-lang="typescript"><span>gallery.ts</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment">// 动态加载 CSS</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> loadCss <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'link'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  link<span class="token punctuation">.</span>rel <span class="token operator">=</span> <span class="token string">'stylesheet'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  link<span class="token punctuation">.</span>href <span class="token operator">=</span> url<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 动态加载 JS</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">const</span> loadJs <span class="token operator">=</span> <span class="token punctuation">(</span>url<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    script<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    script<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    script<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to load script: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">const</span> destroyLightGallery <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">// 获取所有 LightGallery 容器</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">const</span> lightGalleryContainers <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'.lg-container'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// console.log('LightGallery containers found:', lightGalleryContainers);</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>lightGalleryContainers<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token comment">// console.log('No LightGallery instances found to destroy.');</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 遍历每个 LightGallery 容器</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    lightGalleryContainers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token comment">// console.log('Destroying LightGallery instance for container:', container);</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token comment">// 清理与 LightGallery 容器关联的事件</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token keyword">const</span> containerId <span class="token operator">=</span> container<span class="token punctuation">.</span>id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token keyword">const</span> backdrop <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lg-backdrop-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>containerId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token keyword">const</span> outer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lg-outer-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>containerId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token keyword">const</span> content <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">lg-content-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>containerId<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token comment">// 清理事件和相关子元素</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>backdrop<span class="token punctuation">)</span> backdrop<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>outer<span class="token punctuation">)</span> outer<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">)</span> content<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>      <span class="token comment">// 移除容器本身</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      container<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token comment">// console.log('LightGallery instance and DOM elements destroyed for:', containerId);</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">// 确保没有遗留的全局实例</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lgInstances<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lgInstances <span class="token operator">=</span> <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lgInstances<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inst<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token keyword">const</span> isDestroyed <span class="token operator">=</span> <span class="token operator">!</span>document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>inst<span class="token punctuation">.</span>LGEl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>isDestroyed<span class="token punctuation">)</span> <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Removed destroyed instance:'</span><span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">return</span> <span class="token operator">!</span>isDestroyed<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token comment">// console.log('All LightGallery instances and DOM cleaned up.');</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error destroying LightGallery instances:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment">// 初始化 Justified Gallery 和 LightGallery</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token keyword">const</span> initializeGallery <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token comment">// 动态加载 CSS</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    <span class="token function">loadCss</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token function">loadCss</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/lightgallery/css/lightgallery-bundle.css'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token comment">// 动态加载 JS</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">loadJs</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">loadJs</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">loadJs</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/lightgallery/lightgallery.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">loadJs</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/lightgallery/plugins/zoom/lg-zoom.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">loadJs</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/lightgallery/plugins/thumbnail/lg-thumbnail.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">loadJs</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/lightgallery/plugins/autoplay/lg-autoplay.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">loadJs</span><span class="token punctuation">(</span><span class="token string">'https://cdn.jsdelivr.net/npm/lightgallery/plugins/rotate/lg-rotate.min.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token keyword">const</span> $ <span class="token operator">=</span> <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>jQuery<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token comment">//const pathSegments = window.location.pathname.split ('/').filter (segment =&gt; segment); // 提取路径段</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token comment">//const galleryId = pathSegments [pathSegments.length - 1]; // 获取最后一个路径段</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">const</span> galleryContainer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.gallery-items'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> HTMLElement<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>galleryContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'No gallery container found.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token comment">// 销毁现有 LightGallery 实例，防止重复初始化</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token function">destroyLightGallery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre></pre></td></tr><tr><td data-num="96"></td><td><pre>    <span class="token comment">// 初始化 Justified Gallery</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token function">$</span><span class="token punctuation">(</span>galleryContainer<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      <span class="token punctuation">.</span><span class="token function">justifiedGallery</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        rowHeight<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        margins<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        lastRow<span class="token operator">:</span> <span class="token string">'justify'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        captions<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="104"></td><td><pre>      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'jg.complete'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Justified Gallery layout complete.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token comment">// 初始化 LightGallery</span></pre></td></tr><tr><td data-num="108"></td><td><pre>        <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lightGallery</span><span class="token punctuation">(</span>galleryContainer<span class="token punctuation">,</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="109"></td><td><pre>          plugins<span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="110"></td><td><pre>            <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lgZoom<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="111"></td><td><pre>            <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lgThumbnail<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="112"></td><td><pre>            <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lgAutoplay<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="113"></td><td><pre>            <span class="token punctuation">(</span>window <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lgRotate<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="114"></td><td><pre>          <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="115"></td><td><pre>          speed<span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="116"></td><td><pre>          thumbnail<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="117"></td><td><pre>          zoom<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre>        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'LightGallery initialized.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error initializing gallery:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="125"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre></pre></td></tr><tr><td data-num="127"></td><td><pre><span class="token keyword">export</span> <span class="token keyword">default</span> initializeGallery<span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>首先，为了防止<em> PJAX</em> 的缓存问题，选择使用 ts 实现，并在 <code>siteinit.ts</code>  中导入该模块，实现 pjax 刷新，但遇到了 <code>lightgallery</code>  的对象没有清除，在切换相册时会叠加出现的问题，最后通过实现 <code>destroyLightGallery()</code>  方法，在每次初始化容器前都先清除对象防止对象叠加影响。<br>
关于 <code>justifiedGallery</code>  和 <code>lightGallery</code>  的实例化的参数详见文档。注意 <code>lightgallery</code>  增加插件 plugins 需要导入对应的脚本，这些脚本也可在文档查到。<br>
最后该模块 <code>initializeGallery</code>  在 <code>siteinit.ts</code>  中通过 <code>import initializeGallery from '../library/gallery';</code>  导入即可，放在 <code>updateGalleryPageLayout()</code>  内当处于 <code>gallery</code>  页面时。</p>
<h1 id="页面标题自定义"><a class="anchor" href="#页面标题自定义">#</a> 页面标题自定义</h1>
<p>就是显示在大封面的每个页面的两行字，即：</p>
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> headerAlternate <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#header .artboard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">const</span> headerTitle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#header .title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>实现可以在 <code>index.md</code>  中自定义配置。通过 <code>siteinit.ts</code>  中的 <code>import { BODY, CONFIG, pjax, setPjax, setSiteSearch, siteSearch } from '../globals/globalVars';</code>  中的 <code>CONFIG</code>  追踪到 <code>themes\shokaX\scripts\generaters\script.js</code> ，在<span class="green"> 31-64</span> 行中加入代码:</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>script.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment">// 读取 gallery.yml 的数据</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">const</span> galleryData <span class="token operator">=</span> hexo<span class="token punctuation">.</span>locals<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>gallery <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  locals<span class="token punctuation">.</span>pages<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">page</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// galleryData.gallery_groups.forEach((group) =&gt; {</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//   // 去掉 Group URL 中的 "miyano/" 前缀</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">//   const groupUrl = group.url.replace(/^\/?miyano\//, "").replace(/\/$/, "");</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">//   // 去掉 Page Path 中的 "index.html" 后缀</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">//   const pagePath = page.path.replace(/index\.html$/, "").replace(/\/$/, "");</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">//   console.log("Page Path:", pagePath);</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">//   console.log("Group URL:", groupUrl);</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// });</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">const</span> galleryItem <span class="token operator">=</span> galleryData<span class="token punctuation">.</span>gallery_groups<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">(</span><span class="token parameter">group</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> page<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">index\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">===</span> group<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\/?miyano\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>galleryItem<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      page<span class="token punctuation">.</span>alternate <span class="token operator">=</span> galleryItem<span class="token punctuation">.</span>name<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      page<span class="token punctuation">.</span>headerTitle <span class="token operator">=</span> galleryItem<span class="token punctuation">.</span>descr<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  </pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token comment">// 动态生成页面元数据</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">const</span> pages <span class="token operator">=</span> locals<span class="token punctuation">.</span>pages<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> page</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">const</span> metadata <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span>alternate<span class="token punctuation">)</span> metadata<span class="token punctuation">.</span>alternate <span class="token operator">=</span> page<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span>headerTitle<span class="token punctuation">)</span> metadata<span class="token punctuation">.</span>headerTitle <span class="token operator">=</span> page<span class="token punctuation">.</span>headerTitle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      acc<span class="token punctuation">[</span>page<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> metadata<span class="token punctuation">;</span> <span class="token comment">// 仅记录有自定义参数的页面</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">return</span> acc<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">//console.log ("页面数据：",pages);</span></pre></td></tr></tbody></table></figure><p>其中，对于子相册页面，通过读取 <code>source\_data\gallery.yml</code>  中的 <code>name</code>  和 <code>descr</code>  参数作为该页面的 <code>alternate</code>  和 <code>headerTitle</code>  的数据。其中需要获取到和当前子页面路径匹配的 yml 中对应的 url 的数据。需要对两个路径分别进行处理才能得到一致的结构获取到对应的数据。<br>
后面一步则是获取 <code>index.md</code>  中有配置 <code>alternate</code>  和 <code>headerTitle</code>  参数的页面，如果有配置，则返回该页面 <code>pages</code> （带有页面路径和配置的参数值的数据。）<br>
在<span class="green"> 66-69</span> 添加代码获取默认的 <code>alternate</code>  和 <code>title</code>  参数用于默认的页面标题。<br>
在<span class="green"> 110</span> 添加参数 pages.</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>script.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token literal-property property">headerMsg</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token literal-property property">alternate</span><span class="token operator">:</span> theme<span class="token punctuation">.</span>alternate<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token literal-property property">title</span><span class="token operator">:</span> config<span class="token punctuation">.</span>title<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    pages<span class="token punctuation">,</span></pre></td></tr></tbody></table></figure><p>接着，在 <code>siteinit.ts</code>  中，加入下面代码:</p>
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">updateGalleryPageLayout</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">const</span> body <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">const</span> footer <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"footer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">const</span> main <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"main"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token keyword">const</span> headerAlternate <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#header .artboard"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token keyword">const</span> headerTitle <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">"#header .title"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">const</span> HeaderMsgConfigPath <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>root<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取配置了 Header 参数的页面路径</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">const</span> HeaderMsgConfig <span class="token operator">=</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>pages<span class="token punctuation">[</span>HeaderMsgConfigPath<span class="token operator">+</span><span class="token string">'index.html'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 从页面元数据中获取当前页面配置</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment">//console.log ("当前页面配置:", HeaderMsgConfig);</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token keyword">const</span> DefaultHeaderMsgConfig <span class="token operator">=</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>headerMsg</pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">//console.log ("默认页面配置:", DefaultHeaderMsgConfig);</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>pathname<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'/gallery'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"gallery"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    </pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">// 隐藏 footer</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>footer<span class="token punctuation">)</span> footer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">"none"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 调整 main 的 margin-bottom</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> main<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginBottom <span class="token operator">=</span> <span class="token string">"0px"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 如果页面配置了自定义字段，则动态更新 header</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>HeaderMsgConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token keyword">const</span> <span class="token punctuation">{</span> alternate<span class="token punctuation">,</span> headerTitle<span class="token operator">:</span> pageTitle <span class="token punctuation">}</span> <span class="token operator">=</span> HeaderMsgConfig<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>headerAlternate <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">)</span> headerAlternate<span class="token punctuation">.</span>textContent <span class="token operator">=</span> alternate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>headerTitle <span class="token operator">&amp;&amp;</span> pageTitle<span class="token punctuation">)</span> headerTitle<span class="token punctuation">.</span>textContent <span class="token operator">=</span> pageTitle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token function">initializeGallery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    body<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token string">"gallery"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token comment">// 恢复 footer 的显示</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>footer<span class="token punctuation">)</span> footer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 恢复 main 的 margin-bottom</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>main<span class="token punctuation">)</span> main<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginBottom <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">// 恢复默认 header 内容</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>DefaultHeaderMsgConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token keyword">const</span> <span class="token punctuation">{</span> alternate<span class="token punctuation">,</span> headerTitle<span class="token operator">:</span> pageTitle <span class="token punctuation">}</span> <span class="token operator">=</span> DefaultHeaderMsgConfig<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>headerAlternate <span class="token operator">&amp;&amp;</span> alternate<span class="token punctuation">)</span> headerAlternate<span class="token punctuation">.</span>textContent <span class="token operator">=</span> alternate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>headerTitle <span class="token operator">&amp;&amp;</span> pageTitle<span class="token punctuation">)</span> headerTitle<span class="token punctuation">.</span>textContent <span class="token operator">=</span> pageTitle<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>实现了页面的 <code>Header</code>  字段自定义，退出 <code>gallery</code>  页面时则恢复默认。</p>
<h1 id="每天随机主题图片"><a class="anchor" href="#每天随机主题图片">#</a> 每天随机主题图片</h1>
<ol>
<li><code>themes\shokaX\_images_index.yml</code>  为首页图片源文件， <code>themes\shokaX\_images.yml</code>  为首页的后备图片源和文章的图片源。创建一个 <code>themes\shokaX\images.json</code>  用于管理各个主题的图片集，格式为：</li>
</ol>
<figure class="highlight json"><figcaption data-lang="JSON"><span>images.json</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token property">"kon"</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token property">"home"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/kon_14.webp"</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token property">"articles"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/kon_28.webp"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token property">"eva"</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token property">"home"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/eva_35.webp"</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token property">"articles"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/eva_23.webp"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token property">"sp"</span><span class="token operator">:</span> <span class="token punctuation">{</span> </pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token property">"home"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/sp_3.webp"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token property">"articles"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/ghibli_31.webp"</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token property">"articles"</span><span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token string">"https://cloudflare-imgbed-9os.pages.dev/file/ghibli_9.webp"</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">]</span></pre></td></tr><tr><td data-num="29"></td><td><pre>     <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>分别存储了用于首页和文章的图片。</p>
<ol start="2">
<li>创建文件： <code>updateYaml.js</code> ，用于根据日期选择主题或者根据 <code>_config.shokaX.yml</code>  中配置的 <code>Mytheme</code>  选择主题。通过读取<em> json</em> 文件，将图片集写入两个<em> yml</em> 文件，运行 <code>node updateYaml.js</code>  实现更新。这一步在自动部署中定时实现。</li>
</ol>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>updateYaml.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// JSON 文件路径</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">const</span> jsonFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"themes/shokaX/images.json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">// YAML 文件路径</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">const</span> indexYmlPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"themes/shokaX/_images_index.yml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">const</span> articleYmlPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"themes/shokaX/_images.yml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// 主题图片文件夹路径</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">const</span> coverImgDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"source/_data/coverimg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment">// 博客文章文件夹路径</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">const</span> postsDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"source/_posts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// 获取当前主题逻辑</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">getTheme</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">const</span> configPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"_config.shokaX.yml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">const</span> config <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>configPath<span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token keyword">const</span> match <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">MyTheme:\s*(\S+)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">return</span> match <span class="token operator">?</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">// 随机从数组中选取 n 个元素</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">getRandomElements</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">const</span> shuffled <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token number">0.5</span> <span class="token operator">-</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token keyword">return</span> shuffled<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment">// 获取文件夹数量</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">getSubfolderCount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">const</span> itemPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>itemPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment">// 更新 YAML 文件和生成封面图片</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token keyword">const</span> <span class="token function-variable function">updateYmlFiles</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token keyword">const</span> theme <span class="token operator">=</span> <span class="token function">getTheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>  <span class="token keyword">const</span> jsonData <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>jsonFilePath<span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token keyword">let</span> selectedTheme <span class="token operator">=</span> theme<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>theme <span class="token operator">===</span> <span class="token string">"default"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token keyword">const</span> themes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"kon"</span><span class="token punctuation">,</span> <span class="token string">"sp"</span><span class="token punctuation">,</span> <span class="token string">"eva"</span><span class="token punctuation">,</span> <span class="token string">"ghibli"</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      <span class="token keyword">const</span> currentDate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>      <span class="token keyword">const</span> beijingTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span>currentDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// UTC 时间转为北京时间</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"beijingTime:"</span><span class="token punctuation">,</span>beijingTime<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="50"></td><td><pre>      beijingTime<span class="token punctuation">.</span><span class="token function">setDate</span><span class="token punctuation">(</span>beijingTime<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 在当前日期上加上 d_day, 为了与另一个网站主题同步</span></pre></td></tr><tr><td data-num="51"></td><td><pre>      <span class="token keyword">const</span> formattedDate <span class="token operator">=</span> beijingTime<span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取修改后的日期的 YYYY-MM-DD 格式</span></pre></td></tr><tr><td data-num="52"></td><td><pre>      <span class="token keyword">const</span> hash <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>formattedDate<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sum<span class="token punctuation">,</span> char</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> sum <span class="token operator">+</span> char<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算日期字符串的哈希值</span></pre></td></tr><tr><td data-num="53"></td><td><pre>      <span class="token keyword">const</span> themeIndex <span class="token operator">=</span> hash <span class="token operator">%</span> themes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token comment">// 对主题数组长度取模</span></pre></td></tr><tr><td data-num="54"></td><td><pre>      selectedTheme <span class="token operator">=</span> themes<span class="token punctuation">[</span>themeIndex<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="56"></td><td><pre>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"selectedTheme"</span><span class="token punctuation">,</span>selectedTheme<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token keyword">const</span> homeImages <span class="token operator">=</span> jsonData<span class="token punctuation">[</span>selectedTheme<span class="token punctuation">]</span><span class="token operator">?.</span>home <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token keyword">const</span> articleImages <span class="token operator">=</span> jsonData<span class="token punctuation">[</span>selectedTheme<span class="token punctuation">]</span><span class="token operator">?.</span>articles <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token comment">// 写入 YAML 文件</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>indexYmlPath<span class="token punctuation">,</span> homeImages<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>articleYmlPath<span class="token punctuation">,</span> articleImages<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">- </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">YAML files updated for theme: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>selectedTheme<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token comment">// 获取主题对应的图片文件夹</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  <span class="token keyword">const</span> themeCoverDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>coverImgDir<span class="token punctuation">,</span> selectedTheme<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>themeCoverDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Theme folder not found: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>themeCoverDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token comment">// 获取主题图片列表</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token keyword">const</span> themeImages <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>themeCoverDir<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(jpg|jpeg|png|webp)$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>themeImages<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No images found in theme folder: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>themeCoverDir<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="79"></td><td><pre></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token comment">// 获取博客文章文件夹数量</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">const</span> postFolders <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>postsDir<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">const</span> itemPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>postsDir<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>itemPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token comment">// 随机选取图片并生成 cover.jpg</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token keyword">const</span> selectedImages <span class="token operator">=</span> <span class="token function">getRandomElements</span><span class="token punctuation">(</span>themeImages<span class="token punctuation">,</span> postFolders<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>  postFolders<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">folder<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">const</span> postFolderPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>postsDir<span class="token punctuation">,</span> folder<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token keyword">const</span> sourceImagePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>themeCoverDir<span class="token punctuation">,</span> selectedImages<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token keyword">const</span> outputImagePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>postFolderPath<span class="token punctuation">,</span> <span class="token string">"cover.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token comment">// 复制图片为 cover.jpg</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    fs<span class="token punctuation">.</span><span class="token function">copyFileSync</span><span class="token punctuation">(</span>sourceImagePath<span class="token punctuation">,</span> outputImagePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">cover.jpg created for </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>folder<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre><span class="token function">updateYmlFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>注意：对于分类卡片的图片，需要先创建分类的文章文件夹，在每个分类文件夹下存入对应的文章，再加上一张 <code>cover.jpg</code> ，必须命名为该格式，才能渲染出卡片。要实现分类卡片的主题切换，于是新建 <code>source\_data\coverimg</code>  文件夹，里面再设置各个主题的子文件夹，每个主题下存入对应图片的 <code>jpg</code>  图片， <code>updateYaml.js</code>  则根据当天主题将该主题下的图片抽取重命名为 <code>cover</code>  后覆盖掉原来分类文件夹里的图片，作为当前主题的分类卡片图片。(注意每个主题下存入的图片数量需大于分类的类别数量。)<br>
 附：首页的分类卡片，还需要在 <code>_config.yml</code>  中进行配置，如：</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment"># Category &amp; Tag</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">default_category</span><span class="token punctuation">:</span> uncategorized</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">category_map</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">文献翻译</span><span class="token punctuation">:</span> Literature<span class="token punctuation">-</span>Translation</pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">整活探索</span><span class="token punctuation">:</span> Playful<span class="token punctuation">-</span>Exploration</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">科研笔记</span><span class="token punctuation">:</span> Scientific<span class="token punctuation">-</span>Notes</pre></td></tr></tbody></table></figure><div class="note info">
<p>为了使部署后的网页的分类卡片能立即刷新，可以加入时间戳清除缓存，修改 <code>themes\shokaX\layout\_mixin\card.pug</code> ，第<span class="green"> 2</span> 行修改为:</p>
<figure class="highlight pug"><figcaption data-lang="pug"><span>card.pug</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> timestamp <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> </span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">-</span><span class="token code"> cover <span class="token operator">=</span> <span class="token function">url_for</span><span class="token punctuation">(</span>theme<span class="token punctuation">.</span>statics <span class="token operator">+</span> item<span class="token punctuation">.</span>slug <span class="token operator">+</span> <span class="token string">'/cover.jpg'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'?v='</span> <span class="token operator">+</span> timestamp</span></pre></td></tr></tbody></table></figure></div>
<div class="note info">
<p>注意：js 获取的时间 <code>const currentDate = new Date();</code>  为<em> UTC</em> 时间，需要转为<em> UTC+8</em> 的北京时间，不然更新主题会出错。</p>
</div>
<h1 id="增改一些参数"><a class="anchor" href="#增改一些参数">#</a> 增改一些参数</h1>
<ol>
<li><code>_config.shokaX.yml</code>  中 <code>widgets</code>  中增加参数：</li>
</ol>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token key atrule">widgets</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment"># if true, will show random posts</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">random_posts</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">post_number</span><span class="token punctuation">:</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment"># if true, will show recent comments</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">recent_comments</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">comment_number</span><span class="token punctuation">:</span> <span class="token number">5</span></pre></td></tr></tbody></table></figure><p>用于配置随机文章和最新评论的显示数量。<br>
于是在 <code>themes\shokaX\scripts\generaters\script.js</code>  第<span class="green"> 70</span> 增加代码：</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>script.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token literal-property property">recent_comments_count</span><span class="token operator">:</span> theme<span class="token punctuation">.</span>widgets<span class="token punctuation">.</span>recent_comments<span class="token punctuation">.</span>comment_number<span class="token punctuation">,</span></pre></td></tr></tbody></table></figure><p>修改 <code>themes\shokaX\source\js\_app\components\comments.ts</code> ，首先，为了点击最新评论后能正确跳转到该评论所在文章，需要修改第<span class="green"> 32</span> 行为：</p>
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> root <span class="token operator">=</span> shokax_siteURL<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(https?:\/\/)?[^/]*(\/miyano)?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>防止重复的 <code>'/miyano'</code> 。接着，修改<span class="green"> 34-37</span> 为：</p>
<figure class="highlight typescript"><figcaption data-lang="typescript"><span>comment.ts</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">{</span> comments <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">RecentComments</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    serverURL<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>waline<span class="token punctuation">.</span>serverURL<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/+$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    count<span class="token operator">:</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>recent_comments_count <span class="token operator">||</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><p>应用设置的参数作为评论数量。<br>
修改 <code>themes\shokaX\layout\_mixin\widgets.pug</code> ，<span class="green">19-22</span> 修改为:</p>
<figure class="highlight pug"><figcaption data-lang="pug"><span>widgets.pug</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> postNumber <span class="token operator">=</span> theme<span class="token punctuation">.</span>widgets<span class="token punctuation">.</span>random_posts<span class="token punctuation">.</span>post_number <span class="token operator">||</span> <span class="token number">5</span> <span class="token comment">// 默认值为 5</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">-</span><span class="token code"> <span class="token keyword">var</span> posts <span class="token operator">=</span> site<span class="token punctuation">.</span>posts<span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>postNumber<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 使用配置的 post_number</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token flow-control"><span class="token each"><span class="token keyword">each</span> item <span class="token keyword">in</span></span> posts</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag">field<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">item</span><span class="token punctuation">)</span></span></span></pre></td></tr></tbody></table></figure><ol start="2">
<li>修改站点文章阅读时间的格式<br>
修改 <code>themes\shokaX\scripts\helpers\symbols_count_time.js</code>  的<span class="green"> 28-37</span> 为:</li>
</ol>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>symbols_count_time.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">function</span> <span class="token function">getFormatTime</span><span class="token punctuation">(</span><span class="token parameter">minutes<span class="token punctuation">,</span> suffix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token keyword">const</span> fHours <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>minutes <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token keyword">let</span> fMinutes <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>minutes <span class="token operator">-</span> fHours <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fMinutes <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    fMinutes <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment">// return fHours &lt; 1 ? fMinutes + " " + suffix : fHours + ":" + ("00" + fMinutes).slice(-2);</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment">// 修改时间格式化方式为？h?min</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token keyword">return</span> fHours <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fMinutes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">min</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fHours<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">h</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fMinutes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">min</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>显示时间的格式改为 <code>?h?min</code> 。</p>
<ol start="3">
<li>
<p>增加或修改图标<br>
按照<a target="_blank" rel="noopener" href="https://docs.kaitaku.xyz/">文档</a>操作，组建自己的图标项目，生成 css 代码，将需要的图标代码加入 <code>themes\shokaX\source\css\_iconfont.styl</code>  文件中。</p>
</li>
<li>
<p>增加或修改字段<br>
修改文件 <code>themes\shokaX\languages\zh-CN.yml</code> ，例如：</p>
</li>
</ol>
<figure class="highlight yaml"><figcaption data-lang="YAML"><span>zh-CN.yml</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token key atrule">favicon</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token comment"># show: （●´3｀●）やれやれだぜ</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">show</span><span class="token punctuation">:</span> （●´3｀●）萌え萌えキュン</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">hide</span><span class="token punctuation">:</span> (´Д｀)大変だ！</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">menu</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">gallery</span><span class="token punctuation">:</span> 相册</pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">repository</span><span class="token punctuation">:</span> 宝箱</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">anime</span><span class="token punctuation">:</span> 追番</pre></td></tr></tbody></table></figure><h1 id="移除头图模糊"><a class="anchor" href="#移除头图模糊">#</a> 移除头图模糊</h1>
<p>参考<a target="_blank" rel="noopener" href="https://blog.minz.li/shokaX/ShokaX%E6%8F%92%E4%BB%B6-%E7%A7%BB%E9%99%A4%E9%A0%82%E9%83%A8%E9%9C%A7%E9%9D%A2%E6%95%88%E6%9E%9C/">链接</a>，新建文件： <code>themes\shokaX\scripts\removeTopBlur.js</code> ，内容为：</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>removeTopBlur.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>filter<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'theme_inject'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">injects</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    injects<span class="token punctuation">.</span>style<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'themes/shokaX/source/views/removeTopBlur.styl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>新建文件： <code>themes\shokaX\source\views\removeTopBlur.styl</code> ，内容为：</p>
<figure class="highlight stylus"><figcaption data-lang="stylus"><span>removeTopBlur.styl</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token selector">#nav <span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token property-declaration"><span class="token property">backdrop-filter</span><span class="token punctuation">:</span> <span class="token func"><span class="token function">saturate</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token unit">%</span><span class="token punctuation">)</span> <span class="token func"><span class="token function">blur</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token unit">px</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token selector">&amp;.show <span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token property-declaration"><span class="token property">backdrop-filter</span><span class="token punctuation">:</span> <span class="token func"><span class="token function">saturate</span><span class="token punctuation">(</span><span class="token number">180</span><span class="token unit">%</span><span class="token punctuation">)</span> <span class="token func"><span class="token function">blur</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">}</span>   </pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><h1 id="增加头图樱花特效"><a class="anchor" href="#增加头图樱花特效">#</a> 增加头图樱花特效</h1>
<p>参考<a target="_blank" rel="noopener" href="https://blog.minz.li/shokaX/ShokaX%E6%8F%92%E4%BB%B6-%E6%AB%BB%E8%8A%B1/">链接</a>，新建文件： <code>themes\shokaX\scripts\sakura.js</code> ，内容为：</p>
<figure class="highlight javascript"><figcaption data-lang="javascript"><span>sakura.js</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>filter<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'theme_inject'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">injects</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    injects<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span><span class="token string">'sakura'</span><span class="token punctuation">,</span> <span class="token string">'themes/shokaX/source/views/sakura.pug'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>新建文件： <code>themes\shokaX\source\views\sakura.pug</code> ，内容为：</p>
<figure class="highlight pug"><figcaption data-lang="pug"><span>sakura.pug</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag">script</span><span class="token punctuation">.</span><span class="token multiline-script"></span></pre></td></tr><tr><td data-num="2"></td><td><pre>      window<span class="token punctuation">.</span>sakuraConfig <span class="token operator">=</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token literal-property property">sakura</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token literal-property property">xSpeed</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token literal-property property">ySpeed</span><span class="token operator">:</span> <span class="token number">0.5</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token literal-property property">rSpeed</span><span class="token operator">:</span> <span class="token number">0.03</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token literal-property property">direction</span><span class="token operator">:</span> <span class="token string">"TopRight"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token literal-property property">zIndex</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag">script<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">src</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"https://cdn.jsdelivr.net/gh/minz71/sakura-rain/sakura-rain.js"</span> defer</span><span class="token punctuation">)</span></span></span></pre></td></tr></tbody></table></figure><h1 id="设置音乐列表"><a class="anchor" href="#设置音乐列表">#</a> 设置音乐列表</h1>
<p>在 <code>_config.shokaX.yml</code>  中配置：</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token key atrule">audio</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre> <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> KON</pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token key atrule">list</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>     <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//music.163.com/<span class="token comment">#/playlist?id=8881745341</span></pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> Summer Pockets</pre></td></tr><tr><td data-num="6"></td><td><pre>   <span class="token key atrule">list</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>     <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//y.qq.com/n/ryqq/playlist/7784860213</pre></td></tr><tr><td data-num="8"></td><td><pre> <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> EVA</pre></td></tr><tr><td data-num="9"></td><td><pre>   <span class="token key atrule">list</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>     <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//y.qq.com/n/ryqq/playlist/1754837879</pre></td></tr><tr><td data-num="11"></td><td><pre> <span class="token punctuation">-</span> <span class="token key atrule">title</span><span class="token punctuation">:</span> Ghibli</pre></td></tr><tr><td data-num="12"></td><td><pre>   <span class="token key atrule">list</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>     <span class="token punctuation">-</span> https<span class="token punctuation">:</span>//y.qq.com/n/ryqq/playlist/2854515338</pre></td></tr></tbody></table></figure><h1 id="设置追番页面"><a class="anchor" href="#设置追番页面">#</a> 设置追番页面</h1>
<p>路径为： <code>source\anime\index.html</code> ，需要是 <code>html</code>  的格式。需要安装：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre>$ <span class="token function">npm</span> <span class="token function">install</span> hexo-bilibili-bangumi <span class="token parameter variable">--save</span></pre></td></tr></tbody></table></figure><p>在 <code>_config.yml</code>  中进行配置：</p>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment"># 追番插件</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># https://github.com/HCLonely/hexo-bilibili-bangumi</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">bangumi</span><span class="token punctuation">:</span> <span class="token comment"># 追番设置</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">source</span><span class="token punctuation">:</span> bili</pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">path</span><span class="token punctuation">:</span> anime/index.html</pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token key atrule">vmid</span><span class="token punctuation">:</span> <span class="token number">397884429</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">"追番列表"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">quote</span><span class="token punctuation">:</span> <span class="token string">"生命不息，追番不止！"</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">show</span><span class="token punctuation">:</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">lazyload</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token key atrule">loading</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">showMyComment</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token key atrule">pagination</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">metaColor</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token key atrule">color</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">webp</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">progress</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">extraOrder</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">proxy</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">host</span><span class="token punctuation">:</span> <span class="token string">"代理host"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token string">"代理端口"</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">extra_options</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">top_img</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">lazyload</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr></tbody></table></figure><h1 id="文章图片管理"><a class="anchor" href="#文章图片管理">#</a> 文章图片管理</h1>
<p>新建文件夹 <code>themes\shokaX\source\img\post</code>  用于存储博客文章用到的图片，注意路径必须全英文才能转化为 <code>webp</code>  格式。引用格式例如：</p>
<figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">loading</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>lazy<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>/miyano/img/post/trans/trans4/1.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">width</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>50%<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span></pre></td></tr></tbody></table></figure><h1 id="调试技巧"><a class="anchor" href="#调试技巧">#</a> 调试技巧</h1>
<p>要想比较某个版本的仓库代码和当前最新版本的仓库代码的区别时，可以如下命令：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">git</span> checkout <span class="token parameter variable">-b</span> temp-branch <span class="token operator">&lt;</span>commit_hash<span class="token operator">&gt;</span>  <span class="token comment"># 创建一个临时分支来操作旧版本</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">git</span> checkout shoka   <span class="token comment"># 切回原分支</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token function">git</span> branch <span class="token parameter variable">-D</span> temp-branch   <span class="token comment"># 如果临时分支不再需要，可以删除 </span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 想将 main 的最新内容合并到当前分支，不引入完整的合并历史，如下操作：</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token function">git</span> checkout temp-branch    <span class="token comment"># 确保在 temp-branch 分支</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token function">git</span> merge <span class="token parameter variable">--squash</span> shoka     <span class="token comment"># 合并 shoka 分支的最新内容</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">"Merged shoka's latest commit into temp-branch"</span>   <span class="token comment"># 提交更改</span></pre></td></tr></tbody></table></figure><h1 id="自定义字体"><a class="anchor" href="#自定义字体">#</a> 自定义字体</h1>
<p>原先的是使用 <em>Google Font</em> 的字体，如果想自定义字体，需要进行配置如下：</p>
<ol>
<li>确保不引入<em> Google Font</em><br>
 <code>_config.shokaX.yml</code>  中的配置为：</li>
</ol>
<figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token key atrule">font</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment"># 从 google 字体库加载，如果自定义 @font-face 请关闭</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">loadFromGoogle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment"># 字体选项:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment"># `external`: 从 google 字体库加载字体.</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment"># `family: 字体家族名，无需引号</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token comment"># `size: x.x`. 以 `em` 为单位。默认: 1 (16px)</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token comment"># 适用于所有在 body 标签内的文字.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token key atrule">global</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Mulish</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment"># 大标题字体.</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token key atrule">logo</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Fredericka the Great</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">3.5</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment"># 页面标题字体.</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token key atrule">title</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Noto Serif JP</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">2.5</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>  <span class="token comment"># 标题字体.</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token key atrule">headings</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Noto Serif SC</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token key atrule">size</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment"># 文章字体.</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token key atrule">posts</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> </pre></td></tr><tr><td data-num="38"></td><td><pre>    </pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token comment"># 代码块的字体</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token key atrule">codes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token key atrule">external</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token key atrule">family</span><span class="token punctuation">:</span> Inconsolata</pre></td></tr></tbody></table></figure><p>其中，对于 <code>posts</code>  设置 <code>external: false</code> ，保证能通过 <code>@font-face</code>  加载自定义字体。</p>
<ol start="2">
<li>准备字体文件<br>
用于网页端，为了提高性能，最好为 <code>woff2</code>  格式的字体，其他格式可通过<a target="_blank" rel="noopener" href="https://cloudconvert.com/ttf-to-woff2">工具</a>进行转换。<br>
目前我用的字体是<a target="_blank" rel="noopener" href="https://github.com/lxgw/LxgwWenKai"> LXGW WenKai</a>，备选是<a target="_blank" rel="noopener" href="https://github.com/atelier-anchor/smiley-sans"> smiley-sans<br>
</a>。</li>
</ol>
<ul>
<li>方法一可建立文件夹： <code>source\fonts</code> ，里面存放字体文件。</li>
<li>方法二就是把文件存到服务器，例如<em> CloudFlare</em> 或者<em>阿里云 OSS</em> 等，通过 url 链接获取字体文件。</li>
</ul>
<p>对于小的字体文件 (&lt;2MB)，本地字体文件的速度足够；较大的文件则通过服务器效果更好，速度更快。</p>
<ol start="2">
<li>创建 <code>fonts.styl</code> <br>
 路径为： <code>themes\shokaX\source\css\fonts.styl</code> ，代码为：</li>
</ol>
<figure class="highlight stylus"><figcaption data-lang="stylus"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token atrule-declaration"><span class="token atrule">@font-face</span> <span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'SmileySans Oblique'</span><span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>  src<span class="token punctuation">:</span> <span class="token func"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'https://miyano.oss-cn-wuhan-lr.aliyuncs.com/fonts/LXGWWenKai-Light.woff2'</span><span class="token function">) format</span><span class="token punctuation">(</span><span class="token string">'woff2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>       <span class="token func"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string">'/miyano/fonts/SmileySans-Oblique.otf.woff2'</span><span class="token punctuation">)</span> format<span class="token punctuation">(</span><span class="token string">'woff2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">//src: url('https://miyano.oss-cn-wuhan-lr.aliyuncs.com/fonts/SmileySans-Oblique.ttf.woff2') format('woff2'),</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token comment">//url('https://miyano.oss-cn-wuhan-lr.aliyuncs.com/fonts/SmileySans-Oblique.otf.woff2') format('woff2');</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-style</span><span class="token punctuation">:</span> oblique<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-weight</span><span class="token punctuation">:</span> normal<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-display</span><span class="token punctuation">:</span> swap<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token property-declaration"><span class="token property">size-adjust</span><span class="token punctuation">:</span> <span class="token number">120</span><span class="token unit">%</span><span class="token punctuation">;</span> <span class="token comment">/* 让字体整体放大 20% */</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token selector">article.post .body.md <span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'SmileySans Oblique'</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token selector">article.post .body.md h1 <span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'SmileySans Oblique'</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token selector">article.post .body.md h2 <span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'SmileySans Oblique'</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token selector">article.post .body.md h3 <span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'SmileySans Oblique'</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token selector">article.post .body.md h4 <span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'SmileySans Oblique'</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token selector">#sidebar<span class="token punctuation">{</span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token property-declaration"><span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'SmileySans Oblique'</span><span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><p>其中， <code>font-family: 'SmileySans Oblique';</code>  里的名字可以自定义，用于指代字体。</p>
<pre><code>  src: url('https://miyano.oss-cn-wuhan-lr.aliyuncs.com/fonts/LXGWWenKai-Light.woff2') format('woff2'),
</code></pre>
<p>用于获取 url 链接。</p>
<pre><code>url('/miyano/fonts/SmileySans-Oblique.otf.woff2') format('woff2');
</code></pre>
<p>用于获取本地字体文件。<br>
一般 <code>src</code>  设置两个 url 的话，后面一个用于备选。 <code>size-adjust: 120%;</code>  用于整体放大字体。后面的<em> CSS</em> 选择器则是指定让哪些内容字体用自定义的字体。这里包括：文章内容、侧边栏、小节标题。</p>
<ol start="3">
<li>修改 <code>app.styl</code> <br>
 路径为： <code>themes\shokaX\source\css\app.styl</code> ，其实就是引入 <code>fonts.styl</code> 。在最后加入代码：</li>
</ol>
<figure class="highlight stylus"><figcaption data-lang="stylus"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment">// Font</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token atrule-declaration"><span class="token atrule">@import</span> <span class="token string">"fonts"</span><span class="token punctuation">;</span></span></pre></td></tr></tbody></table></figure><p>通过以上设置，成功完成自定义字体对内容的渲染。</p>
<h1 id="改进搜索栏"><a class="anchor" href="#改进搜索栏">#</a> 改进搜索栏</h1>
<p>原来的搜索栏搜索时只显示匹配文章的分类和标题，没有显示匹配的内容片段。这里进行改进。即修改 <code>themes\shokaX\source\js\_app\page\search.ts</code>  文件，修改片段为：</p>
<div class="tab" data-id="id1" data-title="new1">
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      container<span class="token operator">:</span> <span class="token string">'#search-hits'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      templates<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">item</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token keyword">const</span> <span class="token function-variable function">highlightExcerpt</span> <span class="token operator">=</span> <span class="token punctuation">(</span>html<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> maxLength <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>html<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token comment">// 查找第一个高亮标签</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">const</span> tagStart <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;mark&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>tagStart <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="10"></td><td><pre>              <span class="token comment">// 无高亮时返回空字符串，不显示内容</span></pre></td></tr><tr><td data-num="11"></td><td><pre>              <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token comment">// 获取高亮片段结束位置</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">const</span> tagEnd <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;/mark&gt;'</span><span class="token punctuation">,</span> tagStart<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">const</span> contextSize <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>maxLength <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 计算截取范围</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token keyword">const</span> start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> tagStart <span class="token operator">-</span> contextSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">const</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>html<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token punctuation">(</span>tagEnd <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> tagEnd <span class="token operator">:</span> tagStart<span class="token punctuation">)</span> <span class="token operator">+</span> contextSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">let</span> excerpt <span class="token operator">=</span> html<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">const</span> <span class="token punctuation">[</span>lead<span class="token punctuation">,</span> trail<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>start <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">'...'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span> end <span class="token operator">&lt;</span> html<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token string">'...'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment">// 如果截取内容中高亮标签不平衡，则进行修正</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">const</span> openTags <span class="token operator">=</span> <span class="token punctuation">(</span>excerpt<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;mark&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">const</span> closeTags <span class="token operator">=</span> <span class="token punctuation">(</span>excerpt<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;\/mark&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>openTags <span class="token operator">&gt;</span> closeTags<span class="token punctuation">)</span> excerpt <span class="token operator">+=</span> <span class="token string">'&lt;/mark&gt;'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">return</span> lead <span class="token operator">+</span> excerpt <span class="token operator">+</span> trail<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    </pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token keyword">const</span> cats <span class="token operator">=</span> data<span class="token punctuation">.</span>categories<span class="token operator">?.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&lt;i class="ic i-angle-right"&gt;&lt;/i&gt;'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token keyword">const</span> title <span class="token operator">=</span> data<span class="token punctuation">.</span>_highlightResult<span class="token operator">?.</span>title<span class="token operator">?.</span>value <span class="token operator">||</span> data<span class="token punctuation">.</span>title<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          <span class="token keyword">const</span> rawContent <span class="token operator">=</span> data<span class="token punctuation">.</span>_highlightResult<span class="token operator">?.</span>contentStripTruncate<span class="token operator">?.</span>value <span class="token operator">||</span> data<span class="token punctuation">.</span>contentStripTruncate <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    </pre></td></tr><tr><td data-num="32"></td><td><pre>          <span class="token comment">// 生成高亮摘录，如果无高亮，则返回空字符串</span></pre></td></tr><tr><td data-num="33"></td><td><pre>          <span class="token keyword">const</span> highlighted <span class="token operator">=</span> <span class="token function">highlightExcerpt</span><span class="token punctuation">(</span>rawContent<span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    </pre></td></tr><tr><td data-num="35"></td><td><pre>          <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>root <span class="token operator">+</span> data<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"&gt;</span></span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    <span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cats <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;span&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cats<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/span&gt;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    &lt;h3&gt;<span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/h3&gt;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>highlighted <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>highlighted<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span></pre></td></tr><tr><td data-num="39"></td><td><pre>                  &lt;/a&gt;<span class="token template-punctuation string">`</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token function">empty</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="42"></td><td><pre>          <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div id="hits-empty"&gt;</span></span></pre></td></tr><tr><td data-num="43"></td><td><pre>                    <span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">LOCAL</span><span class="token punctuation">.</span>search<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$\{query}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span></pre></td></tr><tr><td data-num="44"></td><td><pre>                  &lt;/div&gt;<span class="token template-punctuation string">`</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="47"></td><td><pre>      cssClasses<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        item<span class="token operator">:</span> <span class="token string">'item'</span></pre></td></tr><tr><td data-num="49"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id1" data-title="new2">
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      container<span class="token operator">:</span> <span class="token string">'#search-hits'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      templates<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">item</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token keyword">const</span> cats <span class="token operator">=</span> data<span class="token punctuation">.</span>categories </pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token operator">?</span> <span class="token string">'&lt;span&gt;'</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>categories<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&lt;i class="ic i-angle-right"&gt;&lt;/i&gt;'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/span&gt;'</span> </pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token operator">:</span> <span class="token string">''</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    </pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token comment">// 获取 Algolia 处理后的高亮文本（已包含 &lt;mark&gt; 标签）</span></pre></td></tr><tr><td data-num="10"></td><td><pre>          <span class="token keyword">const</span> fullContent <span class="token operator">=</span> data<span class="token punctuation">.</span>_highlightResult<span class="token operator">?.</span>contentStripTruncate<span class="token operator">?.</span>value <span class="token operator">||</span> <span class="token string">''</span></pre></td></tr><tr><td data-num="11"></td><td><pre>          </pre></td></tr><tr><td data-num="12"></td><td><pre>          <span class="token comment">// 如果没有高亮内容，truncatedContent 设为空，不显示内容部分</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token keyword">let</span> truncatedContent <span class="token operator">=</span> <span class="token string">''</span></pre></td></tr><tr><td data-num="14"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>fullContent<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token comment">// ** 找到第一个 &lt;mark&gt; 标签的位置 **</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">const</span> firstHighlightIndex <span class="token operator">=</span> fullContent<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'&lt;mark&gt;'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            </pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstHighlightIndex <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="19"></td><td><pre>              <span class="token comment">// ** 向前截取 50 字符，向后截取 150 字符 **</span></pre></td></tr><tr><td data-num="20"></td><td><pre>              <span class="token keyword">let</span> start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> firstHighlightIndex <span class="token operator">-</span> <span class="token number">50</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>              <span class="token keyword">let</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>fullContent<span class="token punctuation">.</span>length<span class="token punctuation">,</span> firstHighlightIndex <span class="token operator">+</span> <span class="token number">150</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    </pre></td></tr><tr><td data-num="23"></td><td><pre>              <span class="token comment">// ** 保留 HTML 结构（确保 &lt;mark&gt; 高亮不丢失）**</span></pre></td></tr><tr><td data-num="24"></td><td><pre>              truncatedContent <span class="token operator">=</span> <span class="token punctuation">(</span>start <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">'...'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                                 fullContent<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                                 <span class="token punctuation">(</span>end <span class="token operator">&lt;</span> fullContent<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token string">'...'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    </pre></td></tr><tr><td data-num="30"></td><td><pre>          <span class="token comment">// 如果没有高亮内容，就不显示内容部分</span></pre></td></tr><tr><td data-num="31"></td><td><pre>          <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CONFIG</span><span class="token punctuation">.</span>root <span class="token operator">+</span> data<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"&gt;</span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    <span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cats<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>_highlightResult<span class="token punctuation">.</span>title <span class="token keyword">as</span> HitHighlightResult<span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"></span></pre></td></tr><tr><td data-num="33"></td><td><pre>                  &lt;/a&gt;</pre></td></tr><tr><td data-num="34"></td><td><pre>                  <span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>truncatedContent <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;p class="search-preview"&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>truncatedContent<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token function">empty</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="37"></td><td><pre>          <span class="token keyword">return</span> <span class="token string">'&lt;div id="hits-empty"&gt;'</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token constant">LOCAL</span><span class="token punctuation">.</span>search<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$\{query}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token string">'&lt;/div&gt;'</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="42"></td><td><pre>      cssClasses<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        item<span class="token operator">:</span> <span class="token string">'item'</span></pre></td></tr><tr><td data-num="44"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id1" data-title="old">
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">hits</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      container<span class="token operator">:</span> <span class="token string">'#search-hits'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      templates<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token function">item</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token keyword">const</span> cats <span class="token operator">=</span> data<span class="token punctuation">.</span>categories <span class="token operator">?</span> <span class="token string">'&lt;span&gt;'</span> <span class="token operator">+</span> data<span class="token punctuation">.</span>categories<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&lt;i class="ic i-angle-right"&gt;&lt;/i&gt;'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'&lt;/span&gt;'</span> <span class="token operator">:</span> <span class="token string">''</span></pre></td></tr><tr><td data-num="6"></td><td><pre>          <span class="token keyword">return</span> <span class="token string">'&lt;a href="'</span> <span class="token operator">+</span> <span class="token constant">CONFIG</span><span class="token punctuation">.</span>root <span class="token operator">+</span> data<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token string">'"&gt;'</span> <span class="token operator">+</span> cats <span class="token operator">+</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>_highlightResult<span class="token punctuation">.</span>title <span class="token keyword">as</span> HitHighlightResult<span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token string">'&lt;/a&gt;'</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token function">empty</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token keyword">return</span> <span class="token string">'&lt;div id="hits-empty"&gt;'</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token constant">LOCAL</span><span class="token punctuation">.</span>search<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$\{query}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token string">'&lt;/div&gt;'</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      cssClasses<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        item<span class="token operator">:</span> <span class="token string">'item'</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr></tbody></table></figure></div>
<p>方法二的思路是：</p>
<ul>
<li>找到第一个高亮的  <code>&lt;mark&gt;</code>  搜索词 <code>&lt;/mark&gt;</code></li>
<li>以此为中心，向前截取 50 个字符，向后截取 50 个字符（防止内容太短）</li>
<li>保留  <code>&lt;mark&gt;</code>  高亮标签，确保搜索词可见<br>
方法一多加了一步：自动平衡高亮标签，防止标签不闭合。</li>
</ul>
<p>至此完成了搜索栏的改进，但有一个问题就是： <code>Algoria</code>  的搜索机制好像有问题，调配置参数也没解决，就是会出现搜索结果中有不含搜索词的文章，所以进行了处理：当没有高亮内容时，使显示内容只有分类和标题。 还会出现搜索词会进行部分匹配的问题，比如搜索” 磁学 “会出现含有” 学 “和含有” 磁 “的结果。这部分后续再看。</p>
<h1 id="fancybox优化"><a class="anchor" href="#fancybox优化">#</a> fancybox 优化</h1>
<p>原来的博客中，虽然有 <strong>fancybox</strong> 的相关文件，但实际上根本用不了，看了原开发者的笔记，跟着设置但也没用，点击图片后仍然没有灯箱效果。于是只能自己一步步顺着文件摸索。最终终于实现了 <strong>fancybox</strong> 的效果。</p>
<h2 id="增加变量的设置"><a class="anchor" href="#增加变量的设置">#</a> 增加变量的设置</h2>
<p>查找原先的 <code>fancybox.ts</code>  文件：发现了函数在 <code>vendorJs('jquery', ()=&gt;{</code> 处就已经卡住了，于是根据该函数找到 <code>themes\shokaX\source\js\_app\library\loadFile.ts</code> ，发现了一个判断条件： <code>if (LOCAL[type])</code> ，再控制台打印这个 <code>LOCAL</code> ，结果中果然没有 <code>jquery</code> ，于是再去找 <code>LOCAL</code>  的定义，找到了 <code>themes\shokaX\layout\_partials\layout.pug</code> ，里面定义了 <code>LOCAL</code> ，果然缺了变量，于是补上：</p>
<div class="tab" data-id="id2" data-title="new">
<figure class="highlight pug"><figcaption data-lang="pug"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag">var</span> <span class="token plain-text">LOCAL = {</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                <span class="token tag">ispost<span class="token punctuation">:</span></span> <span class="token punctuation">!</span>{is_post()},</pre></td></tr><tr><td data-num="3"></td><td><pre>                    <span class="token tag">path<span class="token punctuation">:</span></span> `#{_permapath(page<span class="token punctuation">.</span>path)}`,</pre></td></tr><tr><td data-num="4"></td><td><pre>                    <span class="token tag">favicon<span class="token punctuation">:</span></span> {</pre></td></tr><tr><td data-num="5"></td><td><pre>                    <span class="token tag">show<span class="token punctuation">:</span></span> `#{__('favicon<span class="token punctuation">.</span>show')}`,</pre></td></tr><tr><td data-num="6"></td><td><pre>                    <span class="token tag">hide<span class="token punctuation">:</span></span> `#{__('favicon<span class="token punctuation">.</span>hide')}`</pre></td></tr><tr><td data-num="7"></td><td><pre>                },</pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token tag">search<span class="token punctuation">:</span></span> {</pre></td></tr><tr><td data-num="9"></td><td><pre>                    <span class="token tag">placeholder<span class="token punctuation">:</span></span> "<span class="token punctuation">!</span>{__('search<span class="token punctuation">.</span>placeholder')}",</pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token tag">empty<span class="token punctuation">:</span></span> "<span class="token punctuation">!</span>{__('search<span class="token punctuation">.</span>empty')}",</pre></td></tr><tr><td data-num="11"></td><td><pre>                    <span class="token tag">stats<span class="token punctuation">:</span></span> "<span class="token punctuation">!</span>{__('search<span class="token punctuation">.</span>stats')}"</pre></td></tr><tr><td data-num="12"></td><td><pre>                },</pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token tag">copy_tex<span class="token punctuation">:</span></span> #{<span class="token punctuation">!!</span>page<span class="token punctuation">.</span>math},</pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token tag">katex<span class="token punctuation">:</span></span> #{<span class="token punctuation">!!</span>page<span class="token punctuation">.</span>math},</pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token tag">mermaid<span class="token punctuation">:</span></span> #{<span class="token punctuation">!!</span>page<span class="token punctuation">.</span>mermaid},</pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token tag">audio<span class="token punctuation">:</span></span> <span class="token punctuation">!</span>{audioValue},</pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token tag">fancybox<span class="token punctuation">:</span></span> #{page<span class="token punctuation">.</span>fancybox <span class="token punctuation">!==</span> false},</pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token tag">justifiedGallery<span class="token punctuation">:</span></span> #{page<span class="token punctuation">.</span>fancybox <span class="token punctuation">!==</span> false},   //<span class="token punctuation">-</span> 增加变量定义，这里保持与fancybox相同</pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token tag">jquery<span class="token punctuation">:</span></span> #{page<span class="token punctuation">.</span>fancybox <span class="token punctuation">!==</span> false},             //<span class="token punctuation">-</span> 增加变量定义</pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token tag">nocopy<span class="token punctuation">:</span></span> #{<span class="token punctuation">!!</span>page<span class="token punctuation">.</span>nocopy},</pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token tag">outime<span class="token punctuation">:</span></span> #{page<span class="token punctuation">.</span>outime <span class="token punctuation">!==</span> false},</pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token tag">template<span class="token punctuation">:</span></span> `<span class="token punctuation">!</span>{__('outime<span class="token punctuation">.</span>template')}`,</pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token tag">quiz<span class="token punctuation">:</span></span> {</pre></td></tr><tr><td data-num="24"></td><td><pre>                    <span class="token tag">choice<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>choice')}`,</pre></td></tr><tr><td data-num="25"></td><td><pre>                    <span class="token tag">multiple<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>multiple')}`,</pre></td></tr><tr><td data-num="26"></td><td><pre>                    <span class="token tag">true_false<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>true_false')}`,</pre></td></tr><tr><td data-num="27"></td><td><pre>                    <span class="token tag">essay<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>essay')}`,</pre></td></tr><tr><td data-num="28"></td><td><pre>                    <span class="token tag">gap_fill<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>gap_fill')}`,</pre></td></tr><tr><td data-num="29"></td><td><pre>                    <span class="token tag">mistake<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>mistake')}`</pre></td></tr><tr><td data-num="30"></td><td><pre>                },</pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token tag">ignores<span class="token punctuation">:</span></span> [</pre></td></tr><tr><td data-num="32"></td><td><pre>                    (uri) <span class="token punctuation">=</span>&gt; uri<span class="token punctuation">.</span>includes('#'),</pre></td></tr><tr><td data-num="33"></td><td><pre>                    (uri) <span class="token punctuation">=</span>&gt; new RegExp(LOCAL<span class="token punctuation">.</span>path + '$')<span class="token punctuation">.</span>test(uri),</pre></td></tr><tr><td data-num="34"></td><td><pre>                        <span class="token punctuation">!</span>{JSON<span class="token punctuation">.</span>stringify(ignores)}</pre></td></tr><tr><td data-num="35"></td><td><pre>                ]</pre></td></tr><tr><td data-num="36"></td><td><pre>            };</pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id2" data-title="old">
<figure class="highlight pug"><figcaption data-lang="pug"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag">var</span> <span class="token plain-text">LOCAL = {</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                <span class="token tag">ispost<span class="token punctuation">:</span></span> <span class="token punctuation">!</span>{is_post()},</pre></td></tr><tr><td data-num="3"></td><td><pre>                    <span class="token tag">path<span class="token punctuation">:</span></span> `#{_permapath(page<span class="token punctuation">.</span>path)}`,</pre></td></tr><tr><td data-num="4"></td><td><pre>                    <span class="token tag">favicon<span class="token punctuation">:</span></span> {</pre></td></tr><tr><td data-num="5"></td><td><pre>                    <span class="token tag">show<span class="token punctuation">:</span></span> `#{__('favicon<span class="token punctuation">.</span>show')}`,</pre></td></tr><tr><td data-num="6"></td><td><pre>                    <span class="token tag">hide<span class="token punctuation">:</span></span> `#{__('favicon<span class="token punctuation">.</span>hide')}`</pre></td></tr><tr><td data-num="7"></td><td><pre>                },</pre></td></tr><tr><td data-num="8"></td><td><pre>                <span class="token tag">search<span class="token punctuation">:</span></span> {</pre></td></tr><tr><td data-num="9"></td><td><pre>                    <span class="token tag">placeholder<span class="token punctuation">:</span></span> "<span class="token punctuation">!</span>{__('search<span class="token punctuation">.</span>placeholder')}",</pre></td></tr><tr><td data-num="10"></td><td><pre>                    <span class="token tag">empty<span class="token punctuation">:</span></span> "<span class="token punctuation">!</span>{__('search<span class="token punctuation">.</span>empty')}",</pre></td></tr><tr><td data-num="11"></td><td><pre>                    <span class="token tag">stats<span class="token punctuation">:</span></span> "<span class="token punctuation">!</span>{__('search<span class="token punctuation">.</span>stats')}"</pre></td></tr><tr><td data-num="12"></td><td><pre>                },</pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token tag">copy_tex<span class="token punctuation">:</span></span> #{<span class="token punctuation">!!</span>page<span class="token punctuation">.</span>math},</pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token tag">katex<span class="token punctuation">:</span></span> #{<span class="token punctuation">!!</span>page<span class="token punctuation">.</span>math},</pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token tag">mermaid<span class="token punctuation">:</span></span> #{<span class="token punctuation">!!</span>page<span class="token punctuation">.</span>mermaid},</pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token tag">audio<span class="token punctuation">:</span></span> <span class="token punctuation">!</span>{audioValue},</pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token tag">fancybox<span class="token punctuation">:</span></span> #{page<span class="token punctuation">.</span>fancybox <span class="token punctuation">!==</span> false},</pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token tag">nocopy<span class="token punctuation">:</span></span> #{<span class="token punctuation">!!</span>page<span class="token punctuation">.</span>nocopy},</pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token tag">outime<span class="token punctuation">:</span></span> #{page<span class="token punctuation">.</span>outime <span class="token punctuation">!==</span> false},</pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token tag">template<span class="token punctuation">:</span></span> `<span class="token punctuation">!</span>{__('outime<span class="token punctuation">.</span>template')}`,</pre></td></tr><tr><td data-num="21"></td><td><pre>                <span class="token tag">quiz<span class="token punctuation">:</span></span> {</pre></td></tr><tr><td data-num="22"></td><td><pre>                    <span class="token tag">choice<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>choice')}`,</pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token tag">multiple<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>multiple')}`,</pre></td></tr><tr><td data-num="24"></td><td><pre>                    <span class="token tag">true_false<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>true_false')}`,</pre></td></tr><tr><td data-num="25"></td><td><pre>                    <span class="token tag">essay<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>essay')}`,</pre></td></tr><tr><td data-num="26"></td><td><pre>                    <span class="token tag">gap_fill<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>gap_fill')}`,</pre></td></tr><tr><td data-num="27"></td><td><pre>                    <span class="token tag">mistake<span class="token punctuation">:</span></span> `#{__('quiz<span class="token punctuation">.</span>mistake')}`</pre></td></tr><tr><td data-num="28"></td><td><pre>                },</pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token tag">ignores<span class="token punctuation">:</span></span> [</pre></td></tr><tr><td data-num="30"></td><td><pre>                    (uri) <span class="token punctuation">=</span>&gt; uri<span class="token punctuation">.</span>includes('#'),</pre></td></tr><tr><td data-num="31"></td><td><pre>                    (uri) <span class="token punctuation">=</span>&gt; new RegExp(LOCAL<span class="token punctuation">.</span>path + '$')<span class="token punctuation">.</span>test(uri),</pre></td></tr><tr><td data-num="32"></td><td><pre>                        <span class="token punctuation">!</span>{JSON<span class="token punctuation">.</span>stringify(ignores)}</pre></td></tr><tr><td data-num="33"></td><td><pre>                ]</pre></td></tr><tr><td data-num="34"></td><td><pre>            };</pre></td></tr></tbody></table></figure></div>
<p>这里只是进入判断的第一步，第二步则是 <code>CONFIG['js'][type]</code>  是否有值，再找到 <code>themes/shokaX/source/js/_app/globals/globalVars</code> ，里面定义了 <code>CONFIG = shokax_CONFIG</code> ，再找到 <code>themes\shokaX\scripts\generaters\script.js</code> ，里面定义了 <code>shokax_CONFIG: JSON.stringify(siteConfig)</code> ，进而找到了 <code>siteConfig</code>  并进行变量增加，修改如下：</p>
<div class="tab" data-id="id3" data-title="new">
<figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token literal-property property">js</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token literal-property property">jquery</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>js<span class="token punctuation">.</span>jquery<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 添加 jQuery</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token literal-property property">copy_tex</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>async_js<span class="token punctuation">.</span>copy_tex<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token literal-property property">fancybox</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>async_js<span class="token punctuation">.</span>fancybox<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token literal-property property">justifiedGallery</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>async_js<span class="token punctuation">.</span>justifiedGallery<span class="token punctuation">)</span> <span class="token comment">// 添加 justifiedGallery</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token literal-property property">katex</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>css<span class="token punctuation">.</span>katex<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token literal-property property">mermaid</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token literal-property property">url</span><span class="token operator">:</span> theme<span class="token punctuation">.</span>css <span class="token operator">+</span> <span class="token string">"/mermaid.css"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token literal-property property">local</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token literal-property property">sri</span><span class="token operator">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token literal-property property">fancybox</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>css<span class="token punctuation">.</span>fancybox<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token literal-property property">justifiedGallery</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>css<span class="token punctuation">.</span>justifiedGallery<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id3" data-title="old">
<figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token literal-property property">js</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token literal-property property">copy_tex</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>async_js<span class="token punctuation">.</span>copy_tex<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>      <span class="token literal-property property">fancybox</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>async_js<span class="token punctuation">.</span>fancybox<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token literal-property property">css</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token literal-property property">katex</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>css<span class="token punctuation">.</span>katex<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token literal-property property">mermaid</span><span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token literal-property property">url</span><span class="token operator">:</span> theme<span class="token punctuation">.</span>css <span class="token operator">+</span> <span class="token string">"/mermaid.css"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token literal-property property">local</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token literal-property property">sri</span><span class="token operator">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token literal-property property">fancybox</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>css<span class="token punctuation">.</span>fancybox<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token literal-property property">justifiedGallery</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> import_utils<span class="token punctuation">.</span>getVendorLink<span class="token punctuation">)</span><span class="token punctuation">(</span>hexo<span class="token punctuation">,</span> theme<span class="token punctuation">.</span>vendors<span class="token punctuation">.</span>css<span class="token punctuation">.</span>justifiedGallery<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr></tbody></table></figure></div>
<p>这其中添加的 js 的 <code>jquery</code>  和 <code>justifiedGallery</code>  要和 <code>_config.shokaX.yml</code>  里的 <code>vendors</code>  里的配置对应上。</p>
<p>到这一步，基本的变量已经都配置好了，但出现了问题： <code>jquery</code>  和 <code>justifiedGallery</code>  都能正常加载，但 <code>fancybox</code>  通过 <code>vendorJs</code>  加载脚本却是 <code>failed</code> 。无论怎么修改没找到问题。甚至改变了 cdnjs 的源，方法是：</p>
<ol>
<li>在<a target="_blank" rel="noopener" href="https://cdnjs.com/"> cdnjs</a> 找需要的 js、css 资源</li>
<li>由于该网站默认 sci 为 <code>SHA-512</code> ，该主题默认使用的是 <code>SHA-384</code> ，所以需要转换。通过<a target="_blank" rel="noopener" href="https://srihash.zstatic.net/"> SRI Hash 在线生成器</a>可以方便地获取需要的脚本对应的 sri。</li>
<li>最终在  <code>_config.shokaX.yml</code>  中配置如下：</li>
</ol>
<div class="tab" data-id="id4" data-title="new">
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token key atrule">vendors</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cdns</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">cdnjs</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//cdnjs.cloudflare.com/ajax/libs</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">js</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">pace</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> pace/1.2.4/pace.min.js</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">jquery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> jquery/3.7.1/jquery.min.js</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-1H217gwSVyLSIfaLxHbE7dRb3v4mYCKbpQvzx0cegeju1MVsGrX5xXxAvs/HgeFs"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">async_js</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">fancybox</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> fancybox/3.5.7/jquery.fancybox.min.js</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-Zm+UU4tdcfAm29vg+MTbfu//q5B/lInMbMCr4T8c9rQFyOv6PlfQYpB5wItcXWe7"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">justifiedGallery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js</pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-TOxsBplaL96/QDWPIUg+ye3v89qSE3s22XNtJMmCeZEep3cVDmXy1zEfZvVv+y2m"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">copy_tex</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> KaTeX/0.16.9/contrib/copy<span class="token punctuation">-</span>tex.min.js</pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A"</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token key atrule">css</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token key atrule">katex</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> KaTeX/0.16.9/katex.min.css</pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">comment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> local</pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> css/comment.css</pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token key atrule">fancybox</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> fancybox/3.5.7/jquery.fancybox.min.css</pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-Q8BgkilbsFGYNNiDqJm69hvDS7NCJWOodvfK/cwTyQD4VQA0qKzuPpvqNER1UC0F"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token key atrule">justifiedGallery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> justifiedGallery/3.8.1/css/justifiedGallery.min.css</pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-V/1Ew9pYm8xpy/L9i078ZXT6HSEOrGC6KNFYLbXOdtqb3+c6brpGqVzZtEPSQOiz"</span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id4" data-title="old">
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token key atrule">vendors</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">cdns</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token key atrule">cdnjs</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//s4.zstatic.net/ajax/libs</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">js</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">pace</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> pace/1.2.4/pace.min.js</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8"</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">jquery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> jquery/3.5.1/jquery.min.js</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">async_js</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">fancybox</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> fancybox/3.5.7/jquery.fancybox.min.js</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-Zm+UU4tdcfAm29vg+MTbfu//q5B/lInMbMCr4T8c9rQFyOv6PlfQYpB5wItcXWe7"</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">justifiedGallery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js</pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-TOxsBplaL96/QDWPIUg+ye3v89qSE3s22XNtJMmCeZEep3cVDmXy1zEfZvVv+y2m"</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">copy_tex</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> KaTeX/0.16.9/contrib/copy<span class="token punctuation">-</span>tex.min.js</pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A"</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token key atrule">css</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token key atrule">katex</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> KaTeX/0.16.9/katex.min.css</pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV"</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">comment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> local</pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> css/comment.css</pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">""</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token key atrule">fancybox</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> fancybox/3.5.7/jquery.fancybox.min.css</pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-Q8BgkilbsFGYNNiDqJm69hvDS7NCJWOodvfK/cwTyQD4VQA0qKzuPpvqNER1UC0F"</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token key atrule">justifiedGallery</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token key atrule">source</span><span class="token punctuation">:</span> cdnjs</pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token key atrule">url</span><span class="token punctuation">:</span> justifiedGallery/3.8.1/css/justifiedGallery.min.css</pre></td></tr><tr><td data-num="42"></td><td><pre>      <span class="token key atrule">sri</span><span class="token punctuation">:</span> <span class="token string">"sha384-V/1Ew9pYm8xpy/L9i078ZXT6HSEOrGC6KNFYLbXOdtqb3+c6brpGqVzZtEPSQOiz"</span></pre></td></tr></tbody></table></figure></div>
<p>但该方法没有奏效。</p>
<h2 id="改进fancyboxts"><a class="anchor" href="#改进fancyboxts">#</a> 改进 fancybox.ts</h2>
<p>放弃原来的实现方案，使用手动加载 js，代码为：</p>
<div class="tab" data-id="id5" data-title="new">
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> $dom <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/dom'</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> vendorCss<span class="token punctuation">,</span> vendorJs<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/loadFile'</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> insertAfter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/proto'</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">CONFIG</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../globals/globalVars'</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">// TODO 使用 PhotoSwipe 替换 Fancybox</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">postFancybox</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Function called with selector:'</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">const</span> images <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' .md img:not(.emoji):not(.vemoji)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>images<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] No images found for selector:'</span><span class="token punctuation">,</span> p <span class="token operator">+</span> <span class="token string">' .md img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Found images in:'</span><span class="token punctuation">,</span> p <span class="token operator">+</span> <span class="token string">' .md img'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token function">vendorCss</span><span class="token punctuation">(</span><span class="token string">'fancybox'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token function">vendorCss</span><span class="token punctuation">(</span><span class="token string">'justifiedGallery'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token comment">// ** 手动加载 jQuery（如果尚未加载）**</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> jQuery <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] jQuery not found, loading manually...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">await</span> <span class="token function">manualLoadScript</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'jquery'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] jQuery loaded:'</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> jQuery <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> <span class="token string">'Success'</span> <span class="token operator">:</span> <span class="token string">'Failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token comment">// ** 手动加载 justifiedGallery**</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">await</span> <span class="token function">manualLoadScript</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'justifiedGallery'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] justifiedGallery loaded:'</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> jQuery<span class="token punctuation">.</span>fn<span class="token punctuation">.</span>justifiedGallery <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> <span class="token string">'Success'</span> <span class="token operator">:</span> <span class="token string">'Failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token comment">// ** 手动加载 Fancybox**</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token keyword">await</span> <span class="token function">manualLoadScript</span><span class="token punctuation">(</span><span class="token constant">CONFIG</span><span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'fancybox'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] fancybox loaded:'</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> jQuery<span class="token punctuation">.</span>fancybox <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">?</span> <span class="token string">'Success'</span> <span class="token operator">:</span> <span class="token string">'Failed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> jQuery<span class="token punctuation">.</span>fancybox <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[Fix] Fancybox function not found, manually binding...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    window<span class="token punctuation">.</span>jQuery <span class="token operator">=</span> jQuery<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    window<span class="token punctuation">.</span>$ <span class="token operator">=</span> jQuery<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">const</span> q <span class="token operator">=</span> jQuery<span class="token punctuation">.</span><span class="token function">noConflict</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">// ** 处理 gallery**</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Processing galleries...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>  $dom<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' p.gallery'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Found gallery element:'</span><span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">const</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    box<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'gallery'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    box<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data-height'</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-height'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">220</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    box<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> element<span class="token punctuation">.</span>innerHTML<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;br&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre></pre></td></tr><tr><td data-num="55"></td><td><pre>    element<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    element<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>  <span class="token comment">// ** 处理文章中的图片 **</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Processing images...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>  $dom<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' .md img:not(.emoji):not(.vemoji)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Processing image:'</span><span class="token punctuation">,</span> element<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token keyword">const</span> $image <span class="token operator">=</span> <span class="token function">q</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token keyword">const</span> imageLink <span class="token operator">=</span> $image<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span> <span class="token operator">||</span> $image<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">// 如果图片还没有被 &amp; lt;a &gt; 包裹，则进行包裹</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$image<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">'a.fancybox'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="69"></td><td><pre>      $image<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;a class="fancybox" href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>imageLink<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">" itemscope itemtype="https://schema.org/ImageObject" itemprop="url"&gt;&lt;/a&gt;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="71"></td><td><pre>    </pre></td></tr><tr><td data-num="72"></td><td><pre>    <span class="token comment">// 重新选取包裹图片的 &lt;a&gt; 标签，并统一设置属性</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">const</span> $anchor <span class="token operator">=</span> $image<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token string">'a.fancybox'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    $anchor<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="75"></td><td><pre>      <span class="token string-property property">'data-fancybox'</span><span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      <span class="token string-property property">'rel'</span><span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      <span class="token comment">// 明确指定缩略图 URL</span></pre></td></tr><tr><td data-num="78"></td><td><pre>      <span class="token string-property property">'data-thumb'</span><span class="token operator">:</span> imageLink</pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>    <span class="token keyword">let</span> captionClass <span class="token operator">=</span> <span class="token string">'image-info'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$image<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">'a img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="83"></td><td><pre>      $image<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'safe-src'</span><span class="token punctuation">,</span> imageLink<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$image<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">'.gallery img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token comment">// 此处已统一设置，不重复调用</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token comment">// $anchor.attr('data-fancybox', 'default').attr('rel', 'default');</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        captionClass <span class="token operator">=</span> <span class="token string">'jg-caption'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token keyword">const</span> info <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span> <span class="token operator">||</span> $image<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'alt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="94"></td><td><pre>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Found caption:'</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      $anchor<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'data-caption'</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>      <span class="token keyword">const</span> para <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>      para<span class="token punctuation">.</span>textContent <span class="token operator">=</span> info<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      para<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>captionClass<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>      <span class="token function">insertAfter</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> para<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>  <span class="token comment">// ** 初始化 justifiedGallery**</span></pre></td></tr><tr><td data-num="105"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Initializing justifiedGallery...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  $dom<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' div.gallery'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>el<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Processing gallery:'</span><span class="token punctuation">,</span> el<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token function">q</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">justifiedGallery</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="110"></td><td><pre>      rowHeight<span class="token operator">:</span> <span class="token function">q</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">120</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="111"></td><td><pre>      rel<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">gallery-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'jg.complete'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="113"></td><td><pre>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[postFancybox] justifiedGallery initialized for gallery-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>      <span class="token function">q</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> ele<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        ele<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data-fancybox'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">gallery-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre></pre></td></tr><tr><td data-num="120"></td><td><pre>  <span class="token comment">// ** 初始化 Fancybox**</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Initializing Fancybox...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  q<span class="token punctuation">.</span>fancybox<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token function">q</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' .fancybox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fancybox</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    loop<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    slideShow<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="126"></td><td><pre>      autoStart<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="127"></td><td><pre>      speed<span class="token operator">:</span> <span class="token number">2000</span></pre></td></tr><tr><td data-num="128"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="129"></td><td><pre>    thumbs<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="130"></td><td><pre>      autoStart<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="131"></td><td><pre>      axis<span class="token operator">:</span> <span class="token string">'y'</span></pre></td></tr><tr><td data-num="132"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token comment">// 指定需要显示的按钮（注意：部分按钮是自定义的）</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    buttons<span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="135"></td><td><pre>      <span class="token string">'slideShow'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="136"></td><td><pre>      <span class="token string">'fullScreen'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="137"></td><td><pre>      <span class="token string">'download'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="138"></td><td><pre>      <span class="token string">'zoom'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="139"></td><td><pre>      <span class="token string">'thumbs'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="140"></td><td><pre>      <span class="token string">'close'</span></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>    helpers<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="144"></td><td><pre>      overlay<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="145"></td><td><pre>        locked<span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="146"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Fancybox initialized successfully.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="154"></td><td><pre> * ** 手动加载 JS 文件 **</pre></td></tr><tr><td data-num="155"></td><td><pre> * @param {string} url - JS 文件 URL</pre></td></tr><tr><td data-num="156"></td><td><pre> * @returns {Promise}</pre></td></tr><tr><td data-num="157"></td><td><pre> */</pre></td></tr><tr><td data-num="158"></td><td><pre><span class="token keyword">function</span> <span class="token function">manualLoadScript</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="159"></td><td><pre>  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="160"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>url<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="161"></td><td><pre>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[manualLoadScript] Empty URL provided, skipping.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>      <span class="token keyword">return</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="164"></td><td><pre></pre></td></tr><tr><td data-num="165"></td><td><pre>    <span class="token keyword">const</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>    script<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>    script<span class="token punctuation">.</span>crossOrigin <span class="token operator">=</span> <span class="token string">'anonymous'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    script<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="169"></td><td><pre>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[manualLoadScript] Script loaded successfully: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>    script<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="173"></td><td><pre>      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[manualLoadScript] Failed to load script: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>      <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Failed to load </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="176"></td><td><pre></pre></td></tr><tr><td data-num="177"></td><td><pre>    document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="179"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id5" data-title="old">
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> $dom <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/dom'</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> vendorCss<span class="token punctuation">,</span> vendorJs <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/loadFile'</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> insertAfter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../library/proto'</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">// TODO 使用 PhotoSwipe 替换 Fancybox</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">postFancybox</span> <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token operator">:</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' .md img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">vendorCss</span><span class="token punctuation">(</span><span class="token string">'fancybox'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token function">vendorCss</span><span class="token punctuation">(</span><span class="token string">'justifiedGallery'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">vendorJs</span><span class="token punctuation">(</span><span class="token string">'jquery'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token function">vendorJs</span><span class="token punctuation">(</span><span class="token string">'justifiedGallery'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">vendorJs</span><span class="token punctuation">(</span><span class="token string">'fancybox'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="13"></td><td><pre>          <span class="token keyword">const</span> q <span class="token operator">=</span> jQuery<span class="token punctuation">.</span><span class="token function">noConflict</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>          $dom<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' p.gallery'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">const</span> box <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            box<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'gallery'</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            box<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data-height'</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'data-height'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">220</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>            box<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> element<span class="token punctuation">.</span>innerHTML<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;br&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>            element<span class="token punctuation">.</span>parentNode<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>box<span class="token punctuation">,</span> element<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            element<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>          $dom<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' .md img:not(.emoji):not(.vemoji)'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token keyword">const</span> $image <span class="token operator">=</span> <span class="token function">q</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">const</span> imageLink <span class="token operator">=</span> $image<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'data-src'</span><span class="token punctuation">)</span> <span class="token operator">||</span> $image<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span> <span class="token comment">// 替换</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">const</span> $imageWrapLink <span class="token operator">=</span> $image<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token string">'&lt;a class="fancybox" href="'</span> <span class="token operator">+</span> imageLink <span class="token operator">+</span> <span class="token string">'" itemscope itemtype="https://schema.org/ImageObject" itemprop="url"&gt;&lt;/a&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">let</span> info<span class="token punctuation">;</span> <span class="token keyword">let</span> captionClass <span class="token operator">=</span> <span class="token string">'image-info'</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$image<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">'a img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="32"></td><td><pre>              $image<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'safe-src'</span><span class="token punctuation">,</span> imageLink<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre>              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>$image<span class="token punctuation">.</span><span class="token keyword">is</span><span class="token punctuation">(</span><span class="token string">'.gallery img'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                $imageWrapLink<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'data-fancybox'</span><span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'rel'</span><span class="token punctuation">,</span> <span class="token string">'default'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="35"></td><td><pre>              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                captionClass <span class="token operator">=</span> <span class="token string">'jg-caption'</span></pre></td></tr><tr><td data-num="37"></td><td><pre>              <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>info <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="40"></td><td><pre>              $imageWrapLink<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token string">'data-caption'</span><span class="token punctuation">,</span> info<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="41"></td><td><pre>              <span class="token keyword">const</span> para <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'span'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="42"></td><td><pre>              <span class="token keyword">const</span> txt <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>              para<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>txt<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="44"></td><td><pre>              para<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span>captionClass<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="45"></td><td><pre>              <span class="token function">insertAfter</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> para<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="47"></td><td><pre>          <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>          $dom<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' div.gallery'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>el<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token comment">// @ts-ignore</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token function">q</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">justifiedGallery</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="52"></td><td><pre>              rowHeight<span class="token operator">:</span> <span class="token function">q</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">120</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>              rel<span class="token operator">:</span> <span class="token string">'gallery-'</span> <span class="token operator">+</span> i</pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'jg.complete'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="55"></td><td><pre>              <span class="token function">q</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> ele<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                ele<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'data-fancybox'</span><span class="token punctuation">,</span> <span class="token string">'gallery-'</span> <span class="token operator">+</span> i<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="57"></td><td><pre>              <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="59"></td><td><pre>          <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>          q<span class="token punctuation">.</span>fancybox<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="62"></td><td><pre>          <span class="token function">q</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' .fancybox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fancybox</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            loop<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token comment">// @ts-ignore</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            helpers<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="66"></td><td><pre>              overlay<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="67"></td><td><pre>                locked<span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="68"></td><td><pre>              <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="71"></td><td><pre>          <span class="token comment">// @ts-ignore</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">,</span> window<span class="token punctuation">.</span>jQuery<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">}</span></pre></td></tr></tbody></table></figure></div>
<p>这里面的 ".md" 可以换为 "[itemprop="articleBody"]" 也是同样的效果。</p>
<p>对于新的代码：</p>
<ol>
<li>直接通过函数 <code>manualLoadScript</code>  加载脚本，脚本 url 通过 <code>CONFIG['js'][type].url</code>  获取。</li>
<li>一开始时，没有使文章的图片有共同的属性 'data-fancybox'，导致 <strong>fancybox</strong> 没有把图片当成同组，导致后面的灯箱工具栏的'slideShow' 和 thumbs 无法显示，即使加在 <code>buttons</code>  里也没有图标，无法使用。<br>
但当修改代码统一设置了属性后，都能正常渲染了：</li>
</ol>
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment">// 重新选取包裹图片的 &lt;a&gt; 标签，并统一设置属性</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">const</span> $anchor <span class="token operator">=</span> $image<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token string">'a.fancybox'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    $anchor<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="4"></td><td><pre>      <span class="token string-property property">'data-fancybox'</span><span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token string-property property">'rel'</span><span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      <span class="token comment">// 明确指定缩略图 URL</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token string-property property">'data-thumb'</span><span class="token operator">:</span> imageLink</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>这里面还专门设置了 <code>'data-thumb': imageLink</code>  用于指向图片链接，使 <code>thumbnail</code>  的预览图都能正常渲染，否则可能因为懒加载，有些图片能加载出来有预览图，而有些图片没有预览图，提前为预览图指向图片地址后成功渲染。<br>
3. <strong>fancybox</strong> 工具栏配置：</p>
<figure class="highlight typescript"><figcaption data-lang="typescript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment">// ** 初始化 Fancybox**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[postFancybox] Initializing Fancybox...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  q<span class="token punctuation">.</span>fancybox<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token function">q</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token string">' .fancybox'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fancybox</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    loop<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    slideShow<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      autoStart<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      speed<span class="token operator">:</span> <span class="token number">2000</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    thumbs<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      autoStart<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      axis<span class="token operator">:</span> <span class="token string">'y'</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 指定需要显示的按钮（注意：部分按钮是自定义的）</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    buttons<span class="token operator">:</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token string">'slideShow'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token string">'fullScreen'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token string">'download'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token string">'zoom'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token string">'thumbs'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token string">'close'</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    </pre></td></tr><tr><td data-num="24"></td><td><pre>    helpers<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      overlay<span class="token operator">:</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        locked<span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure><p>至此，图片的 <strong>fancybox</strong> 功能完整实现。只需在文章中使用：</p>
<pre><code>&lt;img loading="lazy" src="/miyano/img/post//engine_tools/krkr4.jpg" style="max-width: 100%; height: auto;"&gt;
![这里是 alt](https://tva3.sinaimg.cn/large/6833939bly1gicis081o9j20zk0m8dmr.jpg "这里是 title")
</code></pre>
<p>等方式，图片就会自动被包裹标签处理，点击有灯箱效果。</p>
<h1 id="代码块和tab冲突问题"><a class="anchor" href="#代码块和tab冲突问题">#</a> 代码块和 tab 冲突问题</h1>
<p>原来的情况下，由于两个组件（代码块和 tab）都使用了相同的 CSS 类名 “show-btn”，导致样式冲突。tab 组件在外层生成了一个空的  <code>&lt;div class="show-btn"&gt;&lt;/div&gt;</code> （通常用来提供 tab 自身的展开或其他操作），而代码块内部也有一个用于显示向下箭头的  <code>&lt;div class="show-btn"&gt;</code> 。当两者同时存在时，tab 组件的样式可能会影响代码块内部的按钮定位，从而导致箭头偏移到代码块内部左下的位置。<br>
解决方案是为代码块的箭头使用不同的类名（例如 code-show-btn），并对应调整 HTML 和 CSS，这样就能彻底避免与 tab 组件的  <code>show-btn</code>  产生冲突。<br>
于是全局查找 <code>show-btn</code> ，找到如下文件并进行修改:</p>
<figure class="highlight stylus"><figcaption data-lang="stylus"><span>themes\shokaX\source\css\_common\components\highlight\highlight.styl</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token selector">.code-show-btn<span class="token punctuation">{</span></span>     <span class="token selector"><span class="token comment">// 原来为 show-btn</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>      <span class="token property-declaration"><span class="token property">position</span><span class="token punctuation">:</span> fixed<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token selector">.code-show-btn <span class="token punctuation">{</span></span>    <span class="token comment">// 原来为 show-btn</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token property-declaration"><span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token property-declaration"><span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr></tbody></table></figure><figure class="highlight typescript"><figcaption data-lang="typescript"><span>themes\shokaX\source\js\_app\page\post.ts</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>code_container <span class="token operator">&amp;&amp;</span> code_container<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'tr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="2"></td><td><pre>          <span class="token keyword">const</span> showBtn <span class="token operator">=</span> code_container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.code-show-btn'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>          code_container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>maxHeight <span class="token operator">=</span> <span class="token string">'300px'</span></pre></td></tr><tr><td data-num="4"></td><td><pre>          showBtn<span class="token punctuation">.</span><span class="token function">removeClass</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>code_container <span class="token operator">&amp;&amp;</span> code_container<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">'tr'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token keyword">const</span> showBtn <span class="token operator">=</span> code_container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.code-show-btn'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          code_container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>maxHeight <span class="token operator">=</span> <span class="token string">''</span></pre></td></tr><tr><td data-num="10"></td><td><pre>          showBtn<span class="token punctuation">.</span><span class="token function">addClass</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>      code_container<span class="token punctuation">.</span><span class="token function">insertAdjacentHTML</span><span class="token punctuation">(</span><span class="token string">'beforeend'</span>， <span class="token string">'&lt;div class="code-show-btn"&gt;&lt;i class="ic i-angle-down"&gt;&lt;/i&gt;&lt;/div&gt;'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token keyword">const</span> showBtn <span class="token operator">=</span> code_container<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.code-show-btn'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">const</span> angleDown <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelectorAll</span><span class="token punctuation">(</span><span class="token string">'.code-show-btn .i-angle-down'</span><span class="token punctuation">)</span></pre></td></tr></tbody></table></figure><p>简单来说就是进行替换，把 <code>show-btn</code>  替换为 <code>code-show-btn</code>  后解决冲突，问题解决，正常显示.</p>
<h1 id="增加文章加密插件"><a class="anchor" href="#增加文章加密插件">#</a> 增加文章加密插件</h1>
<ol>
<li>安装插件</li>
</ol>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">--save</span> hexo-blog-encrypt</pre></td></tr></tbody></table></figure><ol start="2">
<li>配置文件<br>
可在 <code>_config.yml</code>  中统一配置，但具有优先级：文章信息头 &gt; _config.yml &gt; 默认值。</li>
</ol>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token comment"># Security</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">encrypt</span><span class="token punctuation">:</span> <span class="token comment"># hexo-blog-encrypt</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token key atrule">abstract</span><span class="token punctuation">:</span> 有东西被加密了<span class="token punctuation">,</span> 请输入密码查看.</pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">message</span><span class="token punctuation">:</span> 确定要看吗<span class="token punctuation">?</span>だめよ.除非<span class="token punctuation">...</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment"># tags:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token comment"># - {name: tagName, password: 密码 A}</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token comment"># - {name: tagName, password: 密码 B}</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token key atrule">theme</span><span class="token punctuation">:</span> xray</pre></td></tr><tr><td data-num="9"></td><td><pre>  <span class="token key atrule">wrong_pass_message</span><span class="token punctuation">:</span> 抱歉<span class="token punctuation">,</span> 这个密码看着不太对<span class="token punctuation">,</span> 请再试试.</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">wrong_hash_message</span><span class="token punctuation">:</span> 抱歉<span class="token punctuation">,</span> 这个文章不能被校验<span class="token punctuation">,</span> 不过您还是能看看解密后的内容.</pre></td></tr></tbody></table></figure><p>其中的 <code>theme</code>  可以修改加密效果的主题，可选有：default、blink、shrink、flip、up、surge、wave、xray 等。<br>
可在文章 <code>Front-Matter</code>  进行配置：</p>
<figure class="highlight markdown"><figcaption data-lang="markdown"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token front-matter-block"><span class="token punctuation">---</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> Hello World</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">tags</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">-</span> 作为日记加密</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token key atrule">date</span><span class="token punctuation">:</span> <span class="token datetime number">2016-03-30 21:12:21</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token key atrule">password</span><span class="token punctuation">:</span> mikemessi</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token key atrule">abstract</span><span class="token punctuation">:</span> 有东西被加密了<span class="token punctuation">,</span> 请输入密码查看.</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token key atrule">message</span><span class="token punctuation">:</span> 您好<span class="token punctuation">,</span> 这里需要密码.</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token key atrule">wrong_pass_message</span><span class="token punctuation">:</span> 抱歉<span class="token punctuation">,</span> 这个密码看着不太对<span class="token punctuation">,</span> 请再试试.</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token key atrule">wrong_hash_message</span><span class="token punctuation">:</span> 抱歉<span class="token punctuation">,</span> 这个文章不能被校验<span class="token punctuation">,</span> 不过您还是能看看解密后的内容.</pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">---</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>或者直接：</pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token hr punctuation">---</span></pre></td></tr><tr><td data-num="16"></td><td><pre>title: Hello World</pre></td></tr><tr><td data-num="17"></td><td><pre>date: 2016-03-30 21:18:02</pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token title important">password: hello</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">---</span></pre></td></tr></tbody></table></figure><ol start="3">
<li>修改目录显示问题<br>
需要对加密的文章的目录问题进行修正，即加密时看不到目录，解密后才能看到。修改文件 <code>themes\shokaX\layout\_mixin\sidebar.pug</code></li>
</ol>
<div class="tab" data-id="id6" data-title="new">
<figure class="highlight pug"><figcaption data-lang="pug"><span>sidebar.pug</span></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"inner"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"panels"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"inner"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"contents panel pjax"</span> data<span class="token operator">-</span>title<span class="token operator">=</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string">'sidebar.toc'</span></span><span class="token punctuation">)</span></span></span>)</pre></td></tr><tr><td data-num="5"></td><td><pre>                    <span class="token flow-control"><span class="token branch keyword">if</span> display_toc</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                        <span class="token comment">// 根据是否加密来决定 TOC 的显示与内容</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                        <span class="token tag">div<span class="token attr-id">#toc-div</span><span class="token attr-class">.toc-article</span><span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">style</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token punctuation">(</span>page<span class="token punctuation">.</span>encrypt <span class="token operator">?</span> <span class="token string">"display:none"</span> <span class="token operator">:</span> <span class="token string">""</span></span><span class="token punctuation">)</span></span></span>)</pre></td></tr><tr><td data-num="8"></td><td><pre>                            <span class="token flow-control"><span class="token branch keyword">if</span> page<span class="token punctuation">.</span>encrypt</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                                <span class="token comment">// 解密后的页面使用原始内容生成目录</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                                <span class="token punctuation">!=</span><span class="token code"> <span class="token function">toc</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">list_number</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>                            <span class="token flow-control"><span class="token branch keyword">else</span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>                                <span class="token comment">// 普通文章使用页面内容生成目录</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                                <span class="token punctuation">!=</span><span class="token code"> <span class="token function">toc</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span>content<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">list_number</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id6" data-title="old">
<figure class="highlight pug"><figcaption data-lang="pug"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"inner"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"panels"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"inner"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"contents panel pjax"</span> data<span class="token operator">-</span>title<span class="token operator">=</span><span class="token function">__</span><span class="token punctuation">(</span><span class="token string">'sidebar.toc'</span></span><span class="token punctuation">)</span></span></span>)</pre></td></tr><tr><td data-num="5"></td><td><pre>                    <span class="token flow-control"><span class="token branch keyword">if</span> display_toc</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                        <span class="token punctuation">!=</span><span class="token code"> <span class="token function">toc</span><span class="token punctuation">(</span>page<span class="token punctuation">.</span>content<span class="token punctuation">)</span></span></pre></td></tr></tbody></table></figure></div>
<p>这样，文章就能成功加密了。</p>
<h1 id="增加ai总结功能"><a class="anchor" href="#增加ai总结功能">#</a> 增加 AI 总结功能</h1>
<p>在主题里，虽然已经有 AI 总结的配置接口，但是有些不足：例如缺少对长文章的处理，对于较长的文章，若直接输入 ai 可能宕机；另外就是接口目前只兼容 OPENAI，可以进行扩展。<br>
于是目前改进的方案就是：增加对长文章的处理。(接口方面需要再说，目前采用的是 Kimi 的接口，可以兼容。)</p>
<p>整体架构：</p>
<ol>
<li>提取与预处理：读取 Markdown 原文、替换变量、解析成纯文本。</li>
<li>缓存管理：利用本地 JSON 文件（summary.json）存储摘要和对应的文本哈希，避免重复调用接口。</li>
<li>长文处理：对于超过一定字符数的内容，采用分块策略，分别生成摘要后综合成最终摘要。</li>
<li>文本差异检测：对比缓存中的原始文本与当前文本，判断是否有大段增删变化，从而决定是否需要更新摘要。</li>
<li>API 调用：通过同步调用 curl 命令与 AI 模型接口进行交互，生成摘要并重试保证稳定性。</li>
<li>Hexo Helper 注册：将生成摘要的逻辑封装成 Hexo Helper 供模板调用。</li>
</ol>
<h2 id="提取与预处理文本"><a class="anchor" href="#提取与预处理文本">#</a> 提取与预处理文本</h2>
<ol>
<li>读取 Markdown 原文</li>
<li>变量替换：函数  <code>replacePlaceholders</code>  采用正则表达式将文本中的 ${变量} 替换为文章数据中对应的值。</li>
<li>Markdown 转 HTML：利用 markdown-it 将 Markdown 渲染为 HTML，再借助 cheerio 加载 HTML 进行 DOM 操作。</li>
<li>提取正文：遍历 HTML 中的段落、列表、标题（h1–h6）等元素，过滤掉代码块（ <code>&lt;pre&gt;</code>  标签），提取纯文本内容。标题部分会附带 Markdown 格式的井号（#）前缀来保留层级信息。</li>
</ol>
<h2 id="缓存管理"><a class="anchor" href="#缓存管理">#</a> 缓存管理</h2>
<ol>
<li>加载缓存：启动时尝试加载  <code>summary.json</code> ，若不存在则创建新的数据库；缓存数据以文章路径和指定的 dbPath 作为键，存储生成的摘要、原始文本及其哈希值。</li>
<li>文本哈希计算：使用 MD5 对归一化文本（去除多余空白、转小写）进行哈希计算，以便检测文章是否发生变化，从而判断是否需要重新生成摘要。</li>
</ol>
<h2 id="长文章处理"><a class="anchor" href="#长文章处理">#</a> 长文章处理</h2>
<p>对于内容较长（超过 4000 字符）的文章，代码采用智能分块处理：</p>
<ol>
<li>章节划分：使用正则表达式依据 Markdown 标题（#）进行章节划分，确保各分块基于 “精准章节”。</li>
<li>动态合并：按照设定的最大分块大小（4000 字符），动态合并相邻章节。
<ul>
<li>场景 1：如果单个章节超过限制，则调用 splitOversizedSection 函数，按段落再次细分（每个子块不少于 2000 字）。</li>
<li>场景 2：普通章节直接累积，直到接近上限，再生成一个分块。</li>
</ul>
</li>
<li>旧方案对比：注释中展示的旧方案是先按 \n 与 # 分割后再进行简单合并，没有考虑章节内过长的情况，逻辑相对简单；而当前方案通过 “精准章节划分” 与 “动态分块合并” 相结合，更加灵活且能处理超大章节。</li>
</ol>
<h2 id="ai-摘要生成策略"><a class="anchor" href="#ai-摘要生成策略">#</a> AI 摘要生成策略</h2>
<p>摘要生成逻辑：函数 generateSummaryForContent 根据文章长度判断：</p>
<ul>
<li>短文直接生成：如果文章内容在 4000 字以内，直接拼接提示词与内容调用 generateSummarySync 生成摘要。</li>
<li>长文分块生成：若文章过长，则先将文章分块。对每个块使用 CHUNK_PROMPT（要求生成 180 字以内摘要）调用接口生成小摘要，最后将所有小摘要合并后通过 FINAL_PROMPT（要求 300 字以内的最终摘要）生成综合摘要。</li>
</ul>
<h2 id="api-调用与重试机制"><a class="anchor" href="#api-调用与重试机制">#</a> API 调用与重试机制</h2>
<ul>
<li>调用方式：利用 Node.js 内置的 child_process.spawnSync 同步调用 curl 命令，构造 JSON 请求体（包含模型、消息、温度参数等）提交给配置好的 AI 接口。</li>
<li>错误处理：在 API 调用时设置多次重试（最多 5 次），每次失败后根据配置的参数采用不同的初始等待时间，并进行指数退避（逐步增加等待时间）。<br>
数据清洗：在发送请求前，对文本中的反斜杠和引号进行转义，保证 JSON 请求体格式正确。</li>
</ul>
<h2 id="摘要生成"><a class="anchor" href="#摘要生成">#</a> 摘要生成</h2>
<ol>
<li>无缓存记录 或 缓存记录中未保存原始文本时，直接调用  <code>generateSummaryForContent</code>  对全文进行摘要生成。</li>
<li>已经有缓存记录，且内容没有变化时，直接使用已有的缓存。</li>
<li>已经有缓存记录，但内容发生变化时：</li>
</ol>
<ul>
<li>文本差异比较：使用  <code>getParagraphDiffs</code> （基于 Diff.diffWords）比较缓存中的原文与当前内容，分别提取新增和删除的文本。利用  <code>isContinuous</code>  函数遍历段落，累计连续段落的长度，判断累计值是否超过阈值，以判断内容是否发生了大幅度变化。（注：即使新增内容总字数超过阈值，但如果分散在多个短段落（&lt;50 字）中，仍会返回 false）<br>
并且使用双重判断条件：同时检查总字数阈值和段落连续性，避免误判分散修改，如："if (deletionDelta&gt;= threshold &amp;&amp; isContinuous (diff.removed, threshold))"</li>
<li>连续删除超过阈值：构造提示，让 AI 根据删除的内容调整原摘要，确保摘要反映减少的内容。</li>
<li>连续新增超过阈值：构造提示，让 AI 补充新增内容到原摘要中。</li>
<li>变化不显著：直接返回缓存中的摘要。</li>
<li>最后对缓存内容进行更新，写入 <code>summary.json</code> 。</li>
</ul>
<h2 id="hexo-helper-注册"><a class="anchor" href="#hexo-helper-注册">#</a> Hexo Helper 注册</h2>
<ul>
<li>get_summary：注册了一个 Hexo Helper，接收当前文章对象，调用  <code>getContent</code>  获取正文，再调用  <code>postMessage</code>  完成摘要生成。返回的摘要会在博客模板中显示。</li>
<li>get_introduce：另外注册了一个 Helper 用于返回配置中定义的摘要介绍信息。</li>
</ul>
<h2 id="代码修改"><a class="anchor" href="#代码修改">#</a> 代码修改</h2>
<p>修改 <code>themes\shokaX\scripts\helpers\summary_ai.js</code>  代码如下：</p>
<div class="tab" data-id="id7" data-title="new1">
<figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"crypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">{</span> spawnSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"child_process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">const</span> Diff <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'diff'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">const</span> dbFile <span class="token operator">=</span> <span class="token string">"summary.json"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">let</span> globalSummaryCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// ** 加载 summary.json**</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  globalSummaryCache <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">"utf-8"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[Init] 未找到 summary.json，将创建新的数据库"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment">// ** 提示词工程配置 **</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token keyword">const</span> <span class="token constant">CHUNK_PROMPT</span> <span class="token operator">=</span> <span class="token string">"请为以下文章内容生成一个简明且全面的摘要，要求涵盖文章主要观点，禁用Markdown，字数严格控制在180字以内：\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">const</span> <span class="token constant">FINAL_PROMPT</span> <span class="token operator">=</span> <span class="token string">"请综合以下各部分摘要，生成一份完整、逻辑连贯的文章概述。要求在保留各部分关键信息的基础上形成统一整体，禁用Markdown，且严格控制字数在300字以内：\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment">// ** 计算文本哈希（改进：归一化文本以忽略格式细微差异）**</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">function</span> <span class="token function">computeHash</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token keyword">const</span> normalizedText <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"md5"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>normalizedText<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Hash] 计算归一化后哈希: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">return</span> hash<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment">// ** 替换 Markdown 变量 **</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token keyword">function</span> <span class="token function">replacePlaceholders</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$\{(\w+)\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="34"></td><td><pre> * 直接处理 raw Markdown 文本，提取实际内容：</pre></td></tr><tr><td data-num="35"></td><td><pre> * 1. 移除代码块和行内代码（保留代码内容时去除反引号）</pre></td></tr><tr><td data-num="36"></td><td><pre> * 2. 将 Markdown 图片（ ![alt](url) ）替换为 alt 文本，</pre></td></tr><tr><td data-num="37"></td><td><pre> *    同时处理 HTML 格式图片（&lt;img ...&gt;），提取 alt 或 title 属性</pre></td></tr><tr><td data-num="38"></td><td><pre> * 3. 将链接 [text](url) 替换为纯文本 text</pre></td></tr><tr><td data-num="39"></td><td><pre> * 4. 去除加粗、斜体等标记，但保留行首的 # 号（用于章节划分）</pre></td></tr><tr><td data-num="40"></td><td><pre> * 5. 将单独一行的水平分割线（如 ---、***、___）替换为占位符</pre></td></tr><tr><td data-num="41"></td><td><pre> * 6. 处理引用行（移除行首的 &gt; 号）</pre></td></tr><tr><td data-num="42"></td><td><pre> * 7. 对每一行做 trim 处理，保留段落间换行（不再完全去除行内空格，以便后续 diff 调用专门处理空白字符）</pre></td></tr><tr><td data-num="43"></td><td><pre> */</pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token keyword">function</span> <span class="token function">processContent</span><span class="token punctuation">(</span><span class="token parameter">markdownContent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="45"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[Markdown] 开始解析正文（直接处理 raw Markdown）..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>  <span class="token keyword">let</span> content <span class="token operator">=</span> markdownContent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token comment">// 1. 处理代码块，使用状态机确保成对匹配，防止代码块内有 ``` 造成误匹配</span></pre></td></tr><tr><td data-num="50"></td><td><pre>  <span class="token keyword">let</span> inCodeBlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">let</span> lines <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  <span class="token keyword">let</span> processedLines <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  </pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> line <span class="token keyword">of</span> lines<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^```</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="56"></td><td><pre>      inCodeBlock <span class="token operator">=</span> <span class="token operator">!</span>inCodeBlock<span class="token punctuation">;</span> <span class="token comment">// 切换代码块状态</span></pre></td></tr><tr><td data-num="57"></td><td><pre>      <span class="token keyword">continue</span><span class="token punctuation">;</span> <span class="token comment">// 跳过代码块内容</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inCodeBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      processedLines<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="62"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>  content <span class="token operator">=</span> processedLines<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token comment">// 2. 处理行内代码，将 `code` 替换为 code 本身</span></pre></td></tr><tr><td data-num="67"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">`([^`]+)`</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token comment">// 3. 处理 Markdown 图片： ![alt](url) 替换为 alt 文本</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">!\[([^\]]*)\]\([^)]*\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre></pre></td></tr><tr><td data-num="72"></td><td><pre>  <span class="token comment">// 4. 处理 HTML 图片标签：提取 alt 属性，如无 alt 则使用 title 属性</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;img\s+[^&gt;]*&gt;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gi</span></span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token keyword">let</span> altMatch <span class="token operator">=</span> match<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">alt\s*=\s*"(.*?)"</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>altMatch <span class="token operator">&amp;&amp;</span> altMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> altMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token keyword">let</span> titleMatch <span class="token operator">=</span> match<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">title\s*=\s*"(.*?)"</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>titleMatch <span class="token operator">&amp;&amp;</span> titleMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> titleMatch<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token comment">// 5. 处理链接： [text](url) 替换为 text</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\[([^\]]+)\]\([^)]*\)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>  <span class="token comment">// 6. 去除加粗和斜体标记，但保留内容（注意不要去除行首的 '#'）</span></pre></td></tr><tr><td data-num="85"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\*\*|__)(.*?)\1</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(\*|_)(.*?)\1</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'$2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>  <span class="token comment">// 7. 处理水平分割线：单独一行的 ---、*** 或 ___ 替换为占位符（这里用 "..." 表示）</span></pre></td></tr><tr><td data-num="89"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(?:-{3,}|[*_]{3,})\s*$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">,</span> <span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token comment">// 8. 处理引用：去除行首的 &gt; 符号及后面的空格</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^&gt;\s?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">gm</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>  <span class="token comment">// 9. 对每一行做 trim 处理，保留行内空格（这样行首的 '#' 可被保留），并保留换行符用于段落分隔</span></pre></td></tr><tr><td data-num="95"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">line</span> <span class="token operator">=&gt;</span> line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre></pre></td></tr><tr><td data-num="97"></td><td><pre>  <span class="token comment">// 10. 如果需要将多余的连续空行压缩为最多两个（可选）</span></pre></td></tr><tr><td data-num="98"></td><td><pre>  content <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\n{3,}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'\n\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Markdown] 解析完成，正文长度: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字符</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>  <span class="token keyword">return</span> content<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre><span class="token comment">// ** 获取文章正文 **</span></pre></td></tr><tr><td data-num="105"></td><td><pre><span class="token keyword">function</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token keyword">let</span> raw <span class="token operator">=</span> post<span class="token operator">?.</span>raw <span class="token operator">??</span> post<span class="token operator">?.</span>_content <span class="token operator">??</span> post<span class="token punctuation">.</span>content<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  raw <span class="token operator">=</span> <span class="token function">replacePlaceholders</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">processContent</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="109"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre><span class="token comment">// ** 计算文本差异，返回连续的差异块 **</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token keyword">function</span> <span class="token function">getDiff</span><span class="token punctuation">(</span><span class="token parameter">oldText<span class="token punctuation">,</span> newText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="113"></td><td><pre>  <span class="token comment">// 如果其中有一个为空，则返回空差异</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldText <span class="token operator">||</span> <span class="token operator">!</span>newText<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="115"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">oldBlock</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token literal-property property">newBlock</span><span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token keyword">let</span> prefix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token keyword">const</span> minLength <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>oldText<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newText<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>prefix <span class="token operator">&lt;</span> minLength <span class="token operator">&amp;&amp;</span> oldText<span class="token punctuation">[</span>prefix<span class="token punctuation">]</span> <span class="token operator">===</span> newText<span class="token punctuation">[</span>prefix<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    prefix<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="122"></td><td><pre>  <span class="token keyword">let</span> oldSuffix <span class="token operator">=</span> oldText<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>  <span class="token keyword">let</span> newSuffix <span class="token operator">=</span> newText<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldSuffix <span class="token operator">&gt;=</span> prefix <span class="token operator">&amp;&amp;</span> newSuffix <span class="token operator">&gt;=</span> prefix <span class="token operator">&amp;&amp;</span> oldText<span class="token punctuation">[</span>oldSuffix<span class="token punctuation">]</span> <span class="token operator">===</span> newText<span class="token punctuation">[</span>newSuffix<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    oldSuffix<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>    newSuffix<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="128"></td><td><pre>  <span class="token keyword">const</span> oldBlock <span class="token operator">=</span> oldText<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> oldSuffix <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>  <span class="token keyword">const</span> newBlock <span class="token operator">=</span> newText<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> newSuffix <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token keyword">return</span> <span class="token punctuation">{</span> oldBlock<span class="token punctuation">,</span> newBlock <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token keyword">function</span> <span class="token function">getParagraphDiffs</span><span class="token punctuation">(</span><span class="token parameter">oldText<span class="token punctuation">,</span> newText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="134"></td><td><pre>  <span class="token keyword">const</span> paragraphs <span class="token operator">=</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="135"></td><td><pre>    <span class="token literal-property property">added</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="136"></td><td><pre>    <span class="token literal-property property">removed</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  </pre></td></tr><tr><td data-num="139"></td><td><pre>  <span class="token comment">// 按段落分割（假设段落由两个换行符分隔）</span></pre></td></tr><tr><td data-num="140"></td><td><pre>  <span class="token keyword">const</span> diff <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">diffWords</span><span class="token punctuation">(</span>oldText<span class="token punctuation">,</span> newText<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>  </pre></td></tr><tr><td data-num="142"></td><td><pre>  diff<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">part</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="143"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>added<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="144"></td><td><pre>      paragraphs<span class="token punctuation">.</span>added<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="146"></td><td><pre>      paragraphs<span class="token punctuation">.</span>removed<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre></pre></td></tr><tr><td data-num="150"></td><td><pre>  <span class="token comment">// 定义处理函数：保留换行符，去除其他空白字符</span></pre></td></tr><tr><td data-num="151"></td><td><pre>  <span class="token keyword">const</span> <span class="token function-variable function">processText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token comment">// [^\S\n] 匹配所有空白字符，但排除换行符</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^\S\n]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre></pre></td></tr><tr><td data-num="156"></td><td><pre>  <span class="token keyword">return</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="157"></td><td><pre>    <span class="token literal-property property">added</span><span class="token operator">:</span> <span class="token function">processText</span><span class="token punctuation">(</span>paragraphs<span class="token punctuation">.</span>added<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="158"></td><td><pre>    <span class="token literal-property property">removed</span><span class="token operator">:</span> <span class="token function">processText</span><span class="token punctuation">(</span>paragraphs<span class="token punctuation">.</span>removed<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="159"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="161"></td><td><pre><span class="token keyword">function</span> <span class="token function">isContinuous</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> threshold</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="162"></td><td><pre>  <span class="token comment">// 按段落分割（兼容多种换行符）</span></pre></td></tr><tr><td data-num="163"></td><td><pre>  <span class="token keyword">const</span> paragraphs <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?:\n\s*){2,}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>  </pre></td></tr><tr><td data-num="165"></td><td><pre>  <span class="token comment">// 统计连续段落总长度</span></pre></td></tr><tr><td data-num="166"></td><td><pre>  <span class="token keyword">let</span> totalLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> p <span class="token keyword">of</span> paragraphs<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token keyword">const</span> cleanParagraph <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>    totalLength <span class="token operator">+=</span> cleanParagraph<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>    </pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token comment">// 发现连续段落总长度超过阈值</span></pre></td></tr><tr><td data-num="172"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalLength <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>    </pre></td></tr><tr><td data-num="174"></td><td><pre>    <span class="token comment">// 如果遇到短段落（&lt;50 字），重置计数器（视为不连续）</span></pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanParagraph<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="176"></td><td><pre>      totalLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="178"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="179"></td><td><pre>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token keyword">function</span> <span class="token function">processLongContent</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="182"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 启动智能分块处理流程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="183"></td><td><pre></pre></td></tr><tr><td data-num="184"></td><td><pre>  <span class="token keyword">const</span> <span class="token constant">MAX_CHUNK_SIZE</span> <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>  <span class="token keyword">const</span> <span class="token constant">SECTION_REGEX</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\n(?=#{1,6}\s)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>  <span class="token keyword">let</span> sections <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token constant">SECTION_REGEX</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>  </pre></td></tr><tr><td data-num="188"></td><td><pre>  <span class="token comment">// 识别非标题段落</span></pre></td></tr><tr><td data-num="189"></td><td><pre>  <span class="token keyword">const</span> refinedSections <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>  <span class="token keyword">let</span> tempParagraph <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre></pre></td></tr><tr><td data-num="192"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> section <span class="token keyword">of</span> sections<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="193"></td><td><pre>    <span class="token keyword">const</span> firstLine <span class="token operator">=</span> section<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="194"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^#{1,6}\s</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>firstLine<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="195"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>tempParagraph<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="196"></td><td><pre>        refinedSections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">splitOversizedSection</span><span class="token punctuation">(</span>tempParagraph<span class="token punctuation">,</span> <span class="token constant">MAX_CHUNK_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>        tempParagraph <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="199"></td><td><pre>      refinedSections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>section<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="201"></td><td><pre>      tempParagraph <span class="token operator">+=</span> tempParagraph <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>section<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> section<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="202"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="203"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="204"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>tempParagraph<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="205"></td><td><pre>    refinedSections<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">splitOversizedSection</span><span class="token punctuation">(</span>tempParagraph<span class="token punctuation">,</span> <span class="token constant">MAX_CHUNK_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="206"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="207"></td><td><pre></pre></td></tr><tr><td data-num="208"></td><td><pre>  <span class="token comment">// 分块合并</span></pre></td></tr><tr><td data-num="209"></td><td><pre>  <span class="token keyword">const</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>  <span class="token keyword">let</span> currentChunk <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre></pre></td></tr><tr><td data-num="212"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> section <span class="token keyword">of</span> refinedSections<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="213"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>section<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token constant">MAX_CHUNK_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="214"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span> chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>      currentChunk <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="216"></td><td><pre>      chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token function">splitOversizedSection</span><span class="token punctuation">(</span>section<span class="token punctuation">,</span> <span class="token constant">MAX_CHUNK_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="217"></td><td><pre>      <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="218"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="219"></td><td><pre></pre></td></tr><tr><td data-num="220"></td><td><pre>    <span class="token keyword">const</span> projectedLength <span class="token operator">=</span> currentChunk<span class="token punctuation">.</span>length <span class="token operator">+</span> section<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>projectedLength <span class="token operator">&lt;=</span> <span class="token constant">MAX_CHUNK_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="222"></td><td><pre>      currentChunk <span class="token operator">+=</span> currentChunk <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>section<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> section<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="224"></td><td><pre>      chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="225"></td><td><pre>      currentChunk <span class="token operator">=</span> section<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="226"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="227"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="228"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span> chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="229"></td><td><pre></pre></td></tr><tr><td data-num="230"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 最终分块数: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunks<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre>  <span class="token keyword">return</span> chunks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="232"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="233"></td><td><pre></pre></td></tr><tr><td data-num="234"></td><td><pre><span class="token comment">// 超长章节分割策略</span></pre></td></tr><tr><td data-num="235"></td><td><pre><span class="token keyword">function</span> <span class="token function">splitOversizedSection</span><span class="token punctuation">(</span><span class="token parameter">section<span class="token punctuation">,</span> maxSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="236"></td><td><pre>  <span class="token keyword">const</span> <span class="token constant">MIN_SPLIT_SIZE</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token comment">// 最小分割单元</span></pre></td></tr><tr><td data-num="237"></td><td><pre>  <span class="token keyword">const</span> subChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="238"></td><td><pre>  <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="239"></td><td><pre>  </pre></td></tr><tr><td data-num="240"></td><td><pre>  <span class="token comment">// 按段落进行分割</span></pre></td></tr><tr><td data-num="241"></td><td><pre>  <span class="token keyword">const</span> paragraphs <span class="token operator">=</span> section<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="242"></td><td><pre>  </pre></td></tr><tr><td data-num="243"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> para <span class="token keyword">of</span> paragraphs<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="244"></td><td><pre>    <span class="token keyword">const</span> projectedLength <span class="token operator">=</span> buffer<span class="token punctuation">.</span>length <span class="token operator">+</span> para<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="245"></td><td><pre>    </pre></td></tr><tr><td data-num="246"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>projectedLength <span class="token operator">&gt;</span> maxSize <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token constant">MIN_SPLIT_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="247"></td><td><pre>      subChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="248"></td><td><pre>      buffer <span class="token operator">=</span> para<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="249"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="250"></td><td><pre>      buffer <span class="token operator">+=</span> buffer <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>para<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> para<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="251"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="252"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="253"></td><td><pre>  </pre></td></tr><tr><td data-num="254"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> subChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>  </pre></td></tr><tr><td data-num="256"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Split] 将 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>section<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字符章节分割为 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subChunks<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个子块</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="257"></td><td><pre>  <span class="token keyword">return</span> subChunks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="258"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="259"></td><td><pre></pre></td></tr><tr><td data-num="260"></td><td><pre><span class="token comment">// ** 生成文章摘要（提取公共逻辑）**</span></pre></td></tr><tr><td data-num="261"></td><td><pre><span class="token keyword">function</span> <span class="token function">generateSummaryForContent</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> startMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="262"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">4000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="263"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"[Summary] 文章长度 &lt; 4000 字符，直接生成摘要"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="264"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>startMessage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="265"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="266"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 文章过长，进行分段处理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="267"></td><td><pre>    <span class="token keyword">const</span> chunks <span class="token operator">=</span> <span class="token function">processLongContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="268"></td><td><pre>    <span class="token comment">// let sections = content.split(/\n(?=#)/).filter((s) =&gt; s.trim().length &gt; 0);</span></pre></td></tr><tr><td data-num="269"></td><td><pre>    <span class="token comment">// let chunks = [];</span></pre></td></tr><tr><td data-num="270"></td><td><pre>    <span class="token comment">// let currentChunk = "";</span></pre></td></tr><tr><td data-num="271"></td><td><pre>    <span class="token comment">// for (let section of sections) {</span></pre></td></tr><tr><td data-num="272"></td><td><pre>    <span class="token comment">//   if (currentChunk.length + section.length &lt;= 4000) {</span></pre></td></tr><tr><td data-num="273"></td><td><pre>    <span class="token comment">//     currentChunk += (currentChunk ? "\n" : "") + section;</span></pre></td></tr><tr><td data-num="274"></td><td><pre>    <span class="token comment">//   } else {</span></pre></td></tr><tr><td data-num="275"></td><td><pre>    <span class="token comment">//     chunks.push(currentChunk);</span></pre></td></tr><tr><td data-num="276"></td><td><pre>    <span class="token comment">//     currentChunk = section;</span></pre></td></tr><tr><td data-num="277"></td><td><pre>    <span class="token comment">//   }</span></pre></td></tr><tr><td data-num="278"></td><td><pre>    <span class="token comment">// }</span></pre></td></tr><tr><td data-num="279"></td><td><pre>    <span class="token comment">// if (currentChunk) chunks.push(currentChunk);</span></pre></td></tr><tr><td data-num="280"></td><td><pre>    <span class="token comment">//hexo.log.info (`[Summary] 分成 ${chunks.length} 个部分进行处理`);</span></pre></td></tr><tr><td data-num="281"></td><td><pre>    <span class="token keyword">let</span> chunkSummaries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="282"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="283"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 处理第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunks<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 段</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="284"></td><td><pre>      chunkSummaries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">generateSummarySync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CHUNK_PROMPT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="285"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="286"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 综合所有小摘要，生成最终摘要"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="287"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FINAL_PROMPT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunkSummaries<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="288"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="289"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="290"></td><td><pre></pre></td></tr><tr><td data-num="291"></td><td><pre><span class="token comment">// ** 同步 API 调用 **</span></pre></td></tr><tr><td data-num="292"></td><td><pre><span class="token keyword">function</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span><span class="token parameter">messageContent<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="293"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[API] 发送摘要请求，文本长度: "</span> <span class="token operator">+</span> messageContent<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="294"></td><td><pre>  <span class="token keyword">const</span> requestBody <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="295"></td><td><pre>    <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token string">"moonshot-v1-8k"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="296"></td><td><pre>    <span class="token literal-property property">messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="297"></td><td><pre>      <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="298"></td><td><pre>      <span class="token literal-property property">content</span><span class="token operator">:</span> messageContent</pre></td></tr><tr><td data-num="299"></td><td><pre>        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">"\\\\"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="300"></td><td><pre>        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\"</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">"\\\""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="301"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="302"></td><td><pre>    <span class="token literal-property property">temperature</span><span class="token operator">:</span> <span class="token number">0.7</span></pre></td></tr><tr><td data-num="303"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="304"></td><td><pre>  <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="305"></td><td><pre>    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="306"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="307"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[API] 无效的 JSON 请求体: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="308"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[DEBUG] 问题请求体内容: "</span> <span class="token operator">+</span> requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="309"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"摘要生成失败（请求格式错误）"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="310"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="311"></td><td><pre>  <span class="token keyword">const</span> curlBaseCommand <span class="token operator">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="312"></td><td><pre>    <span class="token string">"curl"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="313"></td><td><pre>    <span class="token string">"-X"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="314"></td><td><pre>    <span class="token string">"-H"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Authorization: Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>apikey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="315"></td><td><pre>    <span class="token string">"-H"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type: application/json"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="316"></td><td><pre>    <span class="token string">"--data-binary"</span><span class="token punctuation">,</span> requestBody<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="317"></td><td><pre>  <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="318"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>proxy <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="319"></td><td><pre>    curlBaseCommand<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"--proxy"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="320"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="321"></td><td><pre>  curlBaseCommand<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>remote<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/v1/chat/completions</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="322"></td><td><pre>  <span class="token keyword">const</span> baseWaitTime <span class="token operator">=</span> config<span class="token punctuation">.</span>pricing <span class="token operator">===</span> <span class="token string">"trial"</span> <span class="token operator">?</span> <span class="token number">10000</span> <span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="323"></td><td><pre>  <span class="token keyword">let</span> attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="324"></td><td><pre>  <span class="token keyword">const</span> maxRetries <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="325"></td><td><pre>  <span class="token keyword">let</span> waitTime <span class="token operator">=</span> baseWaitTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="326"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>attempt <span class="token operator">&lt;</span> maxRetries<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="327"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] 尝试 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>attempt <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 次请求，等待 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>waitTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="328"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>attempt <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="329"></td><td><pre>      <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="330"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&lt;</span> waitTime<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="331"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="332"></td><td><pre>    <span class="token keyword">let</span> response<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="333"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="334"></td><td><pre>      response <span class="token operator">=</span> <span class="token function">spawnSync</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="335"></td><td><pre>        <span class="token string">"curl"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="336"></td><td><pre>        <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="337"></td><td><pre>          <span class="token string">"-X"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="338"></td><td><pre>          <span class="token string">"-H"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Authorization: Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>apikey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="339"></td><td><pre>          <span class="token string">"-H"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type: application/json"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="340"></td><td><pre>          <span class="token string">"--data-binary"</span><span class="token punctuation">,</span> <span class="token string">"@-"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="341"></td><td><pre>          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>remote<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/v1/chat/completions</span><span class="token template-punctuation string">`</span></span></pre></td></tr><tr><td data-num="342"></td><td><pre>        <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="343"></td><td><pre>        <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="344"></td><td><pre>          <span class="token literal-property property">input</span><span class="token operator">:</span> requestBody<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="345"></td><td><pre>          <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">"utf-8"</span></pre></td></tr><tr><td data-num="346"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="347"></td><td><pre>      <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="348"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="349"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[API] curl 执行异常: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="350"></td><td><pre>      <span class="token keyword">return</span> <span class="token string">"摘要生成失败（curl 执行异常）"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="351"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="352"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="353"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] curl 命令执行失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response<span class="token punctuation">.</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="354"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="355"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="356"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>stdout <span class="token operator">||</span> response<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="357"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"空响应"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="358"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="359"></td><td><pre>      <span class="token keyword">let</span> jsonResponse <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="360"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>jsonResponse<span class="token punctuation">.</span>choices <span class="token operator">||</span> jsonResponse<span class="token punctuation">.</span>choices<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="361"></td><td><pre>        hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[API] API 响应无 choices 数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="362"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"API 响应无 choices 数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="363"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="364"></td><td><pre>      <span class="token keyword">let</span> summary <span class="token operator">=</span> jsonResponse<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="365"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] 摘要生成成功，长度: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>summary<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="366"></td><td><pre>      <span class="token keyword">return</span> summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="367"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="368"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] 摘要解析失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="369"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="370"></td><td><pre>    attempt<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="371"></td><td><pre>    waitTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>waitTime <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="372"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="373"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] 经过 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxRetries<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 次尝试后仍然失败</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="374"></td><td><pre>  <span class="token keyword">return</span> <span class="token string">"摘要生成失败"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="375"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="376"></td><td><pre></pre></td></tr><tr><td data-num="377"></td><td><pre><span class="token comment">// ** 摘要处理（同步）**</span></pre></td></tr><tr><td data-num="378"></td><td><pre><span class="token keyword">function</span> <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> content<span class="token punctuation">,</span> dbPath<span class="token punctuation">,</span> startMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="379"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="380"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[Summary] 摘要功能未启用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="381"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="382"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="383"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>globalSummaryCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="384"></td><td><pre>    globalSummaryCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="385"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="386"></td><td><pre>  <span class="token keyword">const</span> newHash <span class="token operator">=</span> <span class="token function">computeHash</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="387"></td><td><pre>  <span class="token keyword">const</span> cached <span class="token operator">=</span> globalSummaryCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="388"></td><td><pre>  <span class="token keyword">let</span> summaryResult <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="389"></td><td><pre>  <span class="token keyword">const</span> threshold <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span> <span class="token comment">// 阈值：500 字</span></pre></td></tr><tr><td data-num="390"></td><td><pre></pre></td></tr><tr><td data-num="391"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">&amp;&amp;</span> cached<span class="token punctuation">.</span>hash <span class="token operator">===</span> newHash<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="392"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Cache] 命中缓存，直接返回摘要"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="393"></td><td><pre>    <span class="token keyword">return</span> cached<span class="token punctuation">.</span>summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="394"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="395"></td><td><pre>  </pre></td></tr><tr><td data-num="396"></td><td><pre>  <span class="token comment">// 如果没有缓存或缓存中未保存原始文本，则直接重新生成全文摘要</span></pre></td></tr><tr><td data-num="397"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached <span class="token operator">||</span> <span class="token operator">!</span>cached<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="398"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 首次生成摘要或缓存中未保存原文本，生成全文摘要..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="399"></td><td><pre>    summaryResult <span class="token operator">=</span> <span class="token function">generateSummaryForContent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> startMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="400"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="401"></td><td><pre>    <span class="token comment">// 进行文本差异比较</span></pre></td></tr><tr><td data-num="402"></td><td><pre>    <span class="token comment">// const diff = getDiff(cached.content, content);</span></pre></td></tr><tr><td data-num="403"></td><td><pre>    <span class="token comment">// const deletionDelta = diff.oldBlock.length - diff.newBlock.length;</span></pre></td></tr><tr><td data-num="404"></td><td><pre>    <span class="token comment">// const additionDelta = diff.newBlock.length - diff.oldBlock.length;</span></pre></td></tr><tr><td data-num="405"></td><td><pre>    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token function">getParagraphDiffs</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span>content<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="406"></td><td><pre>    <span class="token keyword">const</span> deletionDelta <span class="token operator">=</span> diff<span class="token punctuation">.</span>removed<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="407"></td><td><pre>    <span class="token keyword">const</span> additionDelta <span class="token operator">=</span> diff<span class="token punctuation">.</span>added<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="408"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 文本差异: 删除 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>deletionDelta<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字，新增 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>additionDelta<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="409"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>deletionDelta <span class="token operator">&gt;=</span> threshold <span class="token operator">&amp;&amp;</span> <span class="token function">isContinuous</span><span class="token punctuation">(</span>diff<span class="token punctuation">.</span>removed<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="410"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 检测到连续删除超过 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>threshold<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字: 删除了 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>deletionDelta<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="411"></td><td><pre>      <span class="token keyword">const</span> prompt <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请在保留以下原摘要核心观点的基础上，根据下面被删除的文本内容，适当调整摘要，使之反映文章内容减少后的实际情况。请注意摘要中原有的重要信息应尽可能保留，同时体现因内容删减而变化的要点。请严格控制字数在300字以内，禁用Markdown格式，输出最终的文章概述。\n原摘要：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cached<span class="token punctuation">.</span>summary<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n删除的内容：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>diff<span class="token punctuation">.</span>removed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="412"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 删除内容：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>diff<span class="token punctuation">.</span>removed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="413"></td><td><pre>      summaryResult <span class="token operator">=</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="414"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>additionDelta <span class="token operator">&gt;=</span> threshold <span class="token operator">&amp;&amp;</span> <span class="token function">isContinuous</span><span class="token punctuation">(</span>diff<span class="token punctuation">.</span>added<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="415"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 检测到连续新增超过 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>threshold<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字: 新增了 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>additionDelta<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="416"></td><td><pre>      <span class="token keyword">const</span> prompt <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请在保持以下原摘要主要观点不变的前提下，根据下面新增的文本内容，适当补充摘要，确保摘要同时涵盖原有内容和新增信息。请注意不要让新增部分抢占过多篇幅，最终输出的文章概述需符合逻辑连贯、重点突出，且严格控制在300字以内，禁用Markdown格式，输出最终的文章概述。。\n原摘要：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cached<span class="token punctuation">.</span>summary<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n新增的内容：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>diff<span class="token punctuation">.</span>added<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="417"></td><td><pre>      hexo <span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 新增内容：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>diff<span class="token punctuation">.</span>added<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="418"></td><td><pre>      summaryResult <span class="token operator">=</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="419"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="420"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 文本差异未达到阈值，返回原全文摘要"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="421"></td><td><pre>      summaryResult <span class="token operator">=</span> cached<span class="token punctuation">.</span>summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="422"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="423"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="424"></td><td><pre>  </pre></td></tr><tr><td data-num="425"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 摘要生成完成，更新缓存"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="426"></td><td><pre>  globalSummaryCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">summary</span><span class="token operator">:</span> summaryResult<span class="token punctuation">,</span> <span class="token literal-property property">hash</span><span class="token operator">:</span> newHash<span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> content <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="427"></td><td><pre>  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>globalSummaryCache<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="428"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 缓存已更新"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="429"></td><td><pre>  <span class="token keyword">return</span> summaryResult<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="430"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="431"></td><td><pre></pre></td></tr><tr><td data-num="432"></td><td><pre><span class="token comment">// ** 注册 Hexo Helper**</span></pre></td></tr><tr><td data-num="433"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"get_summary"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="434"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">postMessage</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token function">getContent</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">,</span> <span class="token string">"请为下述文章提供一份300字以内的简明摘要，要求中文回答且尽可能简洁："</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="435"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="436"></td><td><pre></pre></td></tr><tr><td data-num="437"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"get_introduce"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="438"></td><td><pre>  <span class="token keyword">return</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>introduce<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="439"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id7" data-title="new2">
<figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:fs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">const</span> crypto <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"crypto"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> cheerio <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"cheerio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">const</span> MarkdownIt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"markdown-it"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">const</span> <span class="token punctuation">{</span> spawnSync <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"child_process"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">const</span> Diff <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'diff'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">const</span> dbFile <span class="token operator">=</span> <span class="token string">"summary.json"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">let</span> globalSummaryCache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment">// ** 加载 summary.json**</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  globalSummaryCache <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">"utf-8"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[Init] 未找到 summary.json，将创建新的数据库"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment">// ** 提示词工程配置 **</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">const</span> <span class="token constant">CHUNK_PROMPT</span> <span class="token operator">=</span> <span class="token string">"请为以下文章内容生成摘要，要求字数严格控制180字以内，禁用Markdown：\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">const</span> <span class="token constant">FINAL_PROMPT</span> <span class="token operator">=</span> <span class="token string">"请综合以下摘要生成最终摘要，要求字数严格控制300字以内，禁用Markdown：\n"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment">// ** 计算文本哈希（改进：归一化文本以忽略格式细微差异）**</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">function</span> <span class="token function">computeHash</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  <span class="token keyword">const</span> normalizedText <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">"md5"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>normalizedText<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">"hex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Hash] 计算归一化后哈希: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">return</span> hash<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment">// ** 替换 Markdown 变量 **</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token keyword">function</span> <span class="token function">replacePlaceholders</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$\{(\w+)\}</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">match<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">// ** 解析 Markdown，提取正文 **</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token keyword">function</span> <span class="token function">processContent</span><span class="token punctuation">(</span><span class="token parameter">markdownContent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="37"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[Markdown] 开始解析正文..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">const</span> md <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MarkdownIt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>  <span class="token keyword">const</span> html <span class="token operator">=</span> md<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>markdownContent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token keyword">const</span> $ <span class="token operator">=</span> cheerio<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"pre"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token keyword">let</span> texts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>  <span class="token function">$</span><span class="token punctuation">(</span><span class="token string">"li, p, h1, h2, h3, h4, h5, h6"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">const</span> tag <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>tagName<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token keyword">const</span> text <span class="token operator">=</span> <span class="token function">$</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>text<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    texts<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tag<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"h"</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token string">"#"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span><span class="token function">parseInt</span><span class="token punctuation">(</span>tag<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>text<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> text<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">const</span> result <span class="token operator">=</span> texts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Markdown] 解析完成，正文长度: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>result<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字符</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>  <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token comment">// ** 获取文章正文 **</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token keyword">function</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="58"></td><td><pre>  <span class="token keyword">let</span> raw <span class="token operator">=</span> post<span class="token operator">?.</span>raw <span class="token operator">??</span> post<span class="token operator">?.</span>_content <span class="token operator">??</span> post<span class="token punctuation">.</span>content<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>  raw <span class="token operator">=</span> <span class="token function">replacePlaceholders</span><span class="token punctuation">(</span>raw<span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">processContent</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token comment">// ** 计算文本差异，返回连续的差异块 **</span></pre></td></tr><tr><td data-num="64"></td><td><pre><span class="token keyword">function</span> <span class="token function">getDiff</span><span class="token punctuation">(</span><span class="token parameter">oldText<span class="token punctuation">,</span> newText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="65"></td><td><pre>  <span class="token comment">// 如果其中有一个为空，则返回空差异</span></pre></td></tr><tr><td data-num="66"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldText <span class="token operator">||</span> <span class="token operator">!</span>newText<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">oldBlock</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token literal-property property">newBlock</span><span class="token operator">:</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="69"></td><td><pre>  <span class="token keyword">let</span> prefix <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>  <span class="token keyword">const</span> minLength <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>oldText<span class="token punctuation">.</span>length<span class="token punctuation">,</span> newText<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>prefix <span class="token operator">&lt;</span> minLength <span class="token operator">&amp;&amp;</span> oldText<span class="token punctuation">[</span>prefix<span class="token punctuation">]</span> <span class="token operator">===</span> newText<span class="token punctuation">[</span>prefix<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="72"></td><td><pre>    prefix<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="74"></td><td><pre>  <span class="token keyword">let</span> oldSuffix <span class="token operator">=</span> oldText<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>  <span class="token keyword">let</span> newSuffix <span class="token operator">=</span> newText<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>oldSuffix <span class="token operator">&gt;=</span> prefix <span class="token operator">&amp;&amp;</span> newSuffix <span class="token operator">&gt;=</span> prefix <span class="token operator">&amp;&amp;</span> oldText<span class="token punctuation">[</span>oldSuffix<span class="token punctuation">]</span> <span class="token operator">===</span> newText<span class="token punctuation">[</span>newSuffix<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    oldSuffix<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    newSuffix<span class="token operator">--</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="80"></td><td><pre>  <span class="token keyword">const</span> oldBlock <span class="token operator">=</span> oldText<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> oldSuffix <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>  <span class="token keyword">const</span> newBlock <span class="token operator">=</span> newText<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> newSuffix <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>  <span class="token keyword">return</span> <span class="token punctuation">{</span> oldBlock<span class="token punctuation">,</span> newBlock <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="84"></td><td><pre></pre></td></tr><tr><td data-num="85"></td><td><pre><span class="token keyword">function</span> <span class="token function">getParagraphDiffs</span><span class="token punctuation">(</span><span class="token parameter">oldText<span class="token punctuation">,</span> newText</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="86"></td><td><pre>  <span class="token keyword">const</span> paragraphs <span class="token operator">=</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token literal-property property">added</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token literal-property property">removed</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="89"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>  </pre></td></tr><tr><td data-num="91"></td><td><pre>  <span class="token comment">// 按段落分割（假设段落由两个换行符分隔）</span></pre></td></tr><tr><td data-num="92"></td><td><pre>  <span class="token keyword">const</span> diff <span class="token operator">=</span> Diff<span class="token punctuation">.</span><span class="token function">diffWords</span><span class="token punctuation">(</span>oldText<span class="token punctuation">,</span> newText<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>  </pre></td></tr><tr><td data-num="94"></td><td><pre>  diff<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">part</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>added<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="96"></td><td><pre>      paragraphs<span class="token punctuation">.</span>added<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>removed<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="98"></td><td><pre>      paragraphs<span class="token punctuation">.</span>removed<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="100"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre></pre></td></tr><tr><td data-num="102"></td><td><pre>  <span class="token comment">// 定义处理函数：保留换行符，去除其他空白字符</span></pre></td></tr><tr><td data-num="103"></td><td><pre>  <span class="token keyword">const</span> <span class="token function-variable function">processText</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token comment">// [^\S\n] 匹配所有空白字符，但排除换行符</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[^\S\n]+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>  </pre></td></tr><tr><td data-num="108"></td><td><pre>  <span class="token keyword">return</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="109"></td><td><pre>    <span class="token literal-property property">added</span><span class="token operator">:</span> paragraphs<span class="token punctuation">.</span>added<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="110"></td><td><pre>    <span class="token literal-property property">removed</span><span class="token operator">:</span> paragraphs<span class="token punctuation">.</span>removed<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="111"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="112"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token keyword">function</span> <span class="token function">isContinuous</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> threshold</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="114"></td><td><pre>  <span class="token comment">// 按段落分割（兼容多种换行符）</span></pre></td></tr><tr><td data-num="115"></td><td><pre>  <span class="token keyword">const</span> paragraphs <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(?:\n\s*){2,}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>  </pre></td></tr><tr><td data-num="117"></td><td><pre>  <span class="token comment">// 统计连续段落总长度</span></pre></td></tr><tr><td data-num="118"></td><td><pre>  <span class="token keyword">let</span> totalLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> p <span class="token keyword">of</span> paragraphs<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token keyword">const</span> cleanParagraph <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\s</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre>    totalLength <span class="token operator">+=</span> cleanParagraph<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>    </pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token comment">// 发现连续段落总长度超过阈值</span></pre></td></tr><tr><td data-num="124"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalLength <span class="token operator">&gt;=</span> threshold<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    </pre></td></tr><tr><td data-num="126"></td><td><pre>    <span class="token comment">// 如果遇到短段落（&lt;50 字），重置计数器（视为不连续）</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>cleanParagraph<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="128"></td><td><pre>      totalLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="130"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="131"></td><td><pre>  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="133"></td><td><pre><span class="token keyword">function</span> <span class="token function">processLongContent</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="134"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 启动智能分块处理流程"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre></pre></td></tr><tr><td data-num="136"></td><td><pre>  <span class="token comment">// 第一阶段：精准章节划分</span></pre></td></tr><tr><td data-num="137"></td><td><pre>  <span class="token keyword">const</span> <span class="token constant">SECTION_REGEX</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\n(?=#{1,6}\s)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>  <span class="token keyword">let</span> sections <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token constant">SECTION_REGEX</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="139"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="140"></td><td><pre>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">s</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="141"></td><td><pre>      <span class="token comment">// 有效性验证：确保是合法标题段落</span></pre></td></tr><tr><td data-num="142"></td><td><pre>      <span class="token keyword">const</span> firstLine <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>      <span class="token keyword">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^#{1,6}\s</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>firstLine<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="144"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="145"></td><td><pre></pre></td></tr><tr><td data-num="146"></td><td><pre>  <span class="token comment">// 第二阶段：动态分块合并</span></pre></td></tr><tr><td data-num="147"></td><td><pre>  <span class="token keyword">const</span> <span class="token constant">MAX_CHUNK_SIZE</span> <span class="token operator">=</span> <span class="token number">4000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>  <span class="token keyword">const</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>  <span class="token keyword">let</span> currentChunk <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>  </pre></td></tr><tr><td data-num="151"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> section <span class="token keyword">of</span> sections<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="152"></td><td><pre>    <span class="token comment">// 场景 1：章节本身超过限制</span></pre></td></tr><tr><td data-num="153"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>section<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token constant">MAX_CHUNK_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="154"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span> chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="155"></td><td><pre>      currentChunk <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>      </pre></td></tr><tr><td data-num="157"></td><td><pre>      <span class="token comment">// 第三阶段：长章节再分割</span></pre></td></tr><tr><td data-num="158"></td><td><pre>      <span class="token keyword">const</span> subChunks <span class="token operator">=</span> <span class="token function">splitOversizedSection</span><span class="token punctuation">(</span>section<span class="token punctuation">,</span> <span class="token constant">MAX_CHUNK_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>      chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>subChunks<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>      <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="162"></td><td><pre></pre></td></tr><tr><td data-num="163"></td><td><pre>    <span class="token comment">// 场景 2：正常合并流程</span></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token keyword">const</span> projectedLength <span class="token operator">=</span> currentChunk<span class="token punctuation">.</span>length <span class="token operator">+</span> section<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// +1 for \n</span></pre></td></tr><tr><td data-num="165"></td><td><pre>    </pre></td></tr><tr><td data-num="166"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>projectedLength <span class="token operator">&lt;=</span> <span class="token constant">MAX_CHUNK_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="167"></td><td><pre>      currentChunk <span class="token operator">+=</span> currentChunk <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>section<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> section<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="169"></td><td><pre>      chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>      currentChunk <span class="token operator">=</span> section<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="172"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="173"></td><td><pre></pre></td></tr><tr><td data-num="174"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span> chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="175"></td><td><pre></pre></td></tr><tr><td data-num="176"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 最终分块数: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunks<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="177"></td><td><pre>  <span class="token keyword">return</span> chunks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="178"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="179"></td><td><pre></pre></td></tr><tr><td data-num="180"></td><td><pre><span class="token comment">// 超长章节分割策略</span></pre></td></tr><tr><td data-num="181"></td><td><pre><span class="token keyword">function</span> <span class="token function">splitOversizedSection</span><span class="token punctuation">(</span><span class="token parameter">section<span class="token punctuation">,</span> maxSize</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="182"></td><td><pre>  <span class="token keyword">const</span> <span class="token constant">MIN_SPLIT_SIZE</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span> <span class="token comment">// 最小分割单元</span></pre></td></tr><tr><td data-num="183"></td><td><pre>  <span class="token keyword">const</span> subChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="184"></td><td><pre>  <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>  </pre></td></tr><tr><td data-num="186"></td><td><pre>  <span class="token comment">// 按段落进行分割</span></pre></td></tr><tr><td data-num="187"></td><td><pre>  <span class="token keyword">const</span> paragraphs <span class="token operator">=</span> section<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>  </pre></td></tr><tr><td data-num="189"></td><td><pre>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> para <span class="token keyword">of</span> paragraphs<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="190"></td><td><pre>    <span class="token keyword">const</span> projectedLength <span class="token operator">=</span> buffer<span class="token punctuation">.</span>length <span class="token operator">+</span> para<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="191"></td><td><pre>    </pre></td></tr><tr><td data-num="192"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>projectedLength <span class="token operator">&gt;</span> maxSize <span class="token operator">&amp;&amp;</span> buffer<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token constant">MIN_SPLIT_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="193"></td><td><pre>      subChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="194"></td><td><pre>      buffer <span class="token operator">=</span> para<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="195"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="196"></td><td><pre>      buffer <span class="token operator">+=</span> buffer <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>para<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> para<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="198"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="199"></td><td><pre>  </pre></td></tr><tr><td data-num="200"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> subChunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="201"></td><td><pre>  </pre></td></tr><tr><td data-num="202"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Split] 将 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>section<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字符章节分割为 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subChunks<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 个子块</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="203"></td><td><pre>  <span class="token keyword">return</span> subChunks<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="204"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="205"></td><td><pre></pre></td></tr><tr><td data-num="206"></td><td><pre><span class="token comment">// ** 生成文章摘要（提取公共逻辑）**</span></pre></td></tr><tr><td data-num="207"></td><td><pre><span class="token keyword">function</span> <span class="token function">generateSummaryForContent</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> startMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="208"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>length <span class="token operator">&lt;=</span> <span class="token number">4000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="209"></td><td><pre>    <span class="token punctuation">(</span><span class="token string">"[Summary] 文章长度 &lt; 4000 字符，直接生成摘要"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>startMessage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="211"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="212"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 文章过长，进行分段处理"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="213"></td><td><pre>    <span class="token keyword">const</span> chunks <span class="token operator">=</span> <span class="token function">processLongContent</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>    <span class="token comment">// let sections = content.split(/\n(?=#)/).filter((s) =&gt; s.trim().length &gt; 0);</span></pre></td></tr><tr><td data-num="215"></td><td><pre>    <span class="token comment">// let chunks = [];</span></pre></td></tr><tr><td data-num="216"></td><td><pre>    <span class="token comment">// let currentChunk = "";</span></pre></td></tr><tr><td data-num="217"></td><td><pre>    <span class="token comment">// for (let section of sections) {</span></pre></td></tr><tr><td data-num="218"></td><td><pre>    <span class="token comment">//   if (currentChunk.length + section.length &lt;= 4000) {</span></pre></td></tr><tr><td data-num="219"></td><td><pre>    <span class="token comment">//     currentChunk += (currentChunk ? "\n" : "") + section;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>    <span class="token comment">//   } else {</span></pre></td></tr><tr><td data-num="221"></td><td><pre>    <span class="token comment">//     chunks.push(currentChunk);</span></pre></td></tr><tr><td data-num="222"></td><td><pre>    <span class="token comment">//     currentChunk = section;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>    <span class="token comment">//   }</span></pre></td></tr><tr><td data-num="224"></td><td><pre>    <span class="token comment">// }</span></pre></td></tr><tr><td data-num="225"></td><td><pre>    <span class="token comment">// if (currentChunk) chunks.push(currentChunk);</span></pre></td></tr><tr><td data-num="226"></td><td><pre>    <span class="token comment">//hexo.log.info (`[Summary] 分成 ${chunks.length} 个部分进行处理`);</span></pre></td></tr><tr><td data-num="227"></td><td><pre>    <span class="token keyword">let</span> chunkSummaries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="228"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> chunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="229"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 处理第 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunks<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 段</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="230"></td><td><pre>      chunkSummaries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">generateSummarySync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">CHUNK_PROMPT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="231"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="232"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 综合所有小摘要，生成最终摘要"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="233"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">FINAL_PROMPT</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>chunkSummaries<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="234"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="235"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="236"></td><td><pre></pre></td></tr><tr><td data-num="237"></td><td><pre><span class="token comment">// ** 同步 API 调用 **</span></pre></td></tr><tr><td data-num="238"></td><td><pre><span class="token keyword">function</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span><span class="token parameter">messageContent<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="239"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[API] 发送摘要请求，文本长度: "</span> <span class="token operator">+</span> messageContent<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="240"></td><td><pre>  <span class="token keyword">const</span> requestBody <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="241"></td><td><pre>    <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token string">"moonshot-v1-8k"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="242"></td><td><pre>    <span class="token literal-property property">messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span></pre></td></tr><tr><td data-num="243"></td><td><pre>      <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="244"></td><td><pre>      <span class="token literal-property property">content</span><span class="token operator">:</span> messageContent</pre></td></tr><tr><td data-num="245"></td><td><pre>        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">"\\\\"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="246"></td><td><pre>        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\"</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">"\\\""</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="247"></td><td><pre>    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="248"></td><td><pre>    <span class="token literal-property property">temperature</span><span class="token operator">:</span> <span class="token number">0.7</span></pre></td></tr><tr><td data-num="249"></td><td><pre>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="250"></td><td><pre>  <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="251"></td><td><pre>    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="252"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="253"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[API] 无效的 JSON 请求体: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="254"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"[DEBUG] 问题请求体内容: "</span> <span class="token operator">+</span> requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="255"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"摘要生成失败（请求格式错误）"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="256"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="257"></td><td><pre>  <span class="token keyword">const</span> curlBaseCommand <span class="token operator">=</span> <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="258"></td><td><pre>    <span class="token string">"curl"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="259"></td><td><pre>    <span class="token string">"-X"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="260"></td><td><pre>    <span class="token string">"-H"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Authorization: Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>apikey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="261"></td><td><pre>    <span class="token string">"-H"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type: application/json"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="262"></td><td><pre>    <span class="token string">"--data-binary"</span><span class="token punctuation">,</span> requestBody<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="263"></td><td><pre>  <span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="264"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>proxy <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="265"></td><td><pre>    curlBaseCommand<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"--proxy"</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span>proxy<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="266"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="267"></td><td><pre>  curlBaseCommand<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>remote<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/v1/chat/completions</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="268"></td><td><pre>  <span class="token keyword">const</span> baseWaitTime <span class="token operator">=</span> config<span class="token punctuation">.</span>pricing <span class="token operator">===</span> <span class="token string">"trial"</span> <span class="token operator">?</span> <span class="token number">10000</span> <span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="269"></td><td><pre>  <span class="token keyword">let</span> attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="270"></td><td><pre>  <span class="token keyword">const</span> maxRetries <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="271"></td><td><pre>  <span class="token keyword">let</span> waitTime <span class="token operator">=</span> baseWaitTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="272"></td><td><pre>  <span class="token keyword">while</span> <span class="token punctuation">(</span>attempt <span class="token operator">&lt;</span> maxRetries<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="273"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] 尝试 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>attempt <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 次请求，等待 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>waitTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="274"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>attempt <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="275"></td><td><pre>      <span class="token keyword">const</span> startTime <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="276"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">&lt;</span> waitTime<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="277"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="278"></td><td><pre>    <span class="token keyword">let</span> response<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="279"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="280"></td><td><pre>      response <span class="token operator">=</span> <span class="token function">spawnSync</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="281"></td><td><pre>        <span class="token string">"curl"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="282"></td><td><pre>        <span class="token punctuation">[</span></pre></td></tr><tr><td data-num="283"></td><td><pre>          <span class="token string">"-X"</span><span class="token punctuation">,</span> <span class="token string">"POST"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="284"></td><td><pre>          <span class="token string">"-H"</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Authorization: Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>apikey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="285"></td><td><pre>          <span class="token string">"-H"</span><span class="token punctuation">,</span> <span class="token string">"Content-Type: application/json"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="286"></td><td><pre>          <span class="token string">"--data-binary"</span><span class="token punctuation">,</span> <span class="token string">"@-"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="287"></td><td><pre>          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>remote<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/v1/chat/completions</span><span class="token template-punctuation string">`</span></span></pre></td></tr><tr><td data-num="288"></td><td><pre>        <span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="289"></td><td><pre>        <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="290"></td><td><pre>          <span class="token literal-property property">input</span><span class="token operator">:</span> requestBody<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="291"></td><td><pre>          <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">"utf-8"</span></pre></td></tr><tr><td data-num="292"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="293"></td><td><pre>      <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="294"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="295"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[API] curl 执行异常: "</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="296"></td><td><pre>      <span class="token keyword">return</span> <span class="token string">"摘要生成失败（curl 执行异常）"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="297"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="298"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="299"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] curl 命令执行失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>response<span class="token punctuation">.</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="300"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="301"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="302"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>stdout <span class="token operator">||</span> response<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="303"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"空响应"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="304"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="305"></td><td><pre>      <span class="token keyword">let</span> jsonResponse <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>stdout<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="306"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>jsonResponse<span class="token punctuation">.</span>choices <span class="token operator">||</span> jsonResponse<span class="token punctuation">.</span>choices<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="307"></td><td><pre>        hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"[API] API 响应无 choices 数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="308"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"API 响应无 choices 数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="309"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="310"></td><td><pre>      <span class="token keyword">let</span> summary <span class="token operator">=</span> jsonResponse<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="311"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] 摘要生成成功，长度: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>summary<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="312"></td><td><pre>      <span class="token keyword">return</span> summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="313"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="314"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] 摘要解析失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="315"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="316"></td><td><pre>    attempt<span class="token operator">++</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="317"></td><td><pre>    waitTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>waitTime <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="318"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="319"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[API] 经过 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>maxRetries<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 次尝试后仍然失败</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="320"></td><td><pre>  <span class="token keyword">return</span> <span class="token string">"摘要生成失败"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="321"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="322"></td><td><pre></pre></td></tr><tr><td data-num="323"></td><td><pre><span class="token comment">// ** 摘要处理（同步）**</span></pre></td></tr><tr><td data-num="324"></td><td><pre><span class="token keyword">function</span> <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> content<span class="token punctuation">,</span> dbPath<span class="token punctuation">,</span> startMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="325"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="326"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[Summary] 摘要功能未启用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="327"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="328"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="329"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>globalSummaryCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="330"></td><td><pre>    globalSummaryCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="331"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="332"></td><td><pre>  <span class="token keyword">const</span> newHash <span class="token operator">=</span> <span class="token function">computeHash</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="333"></td><td><pre>  <span class="token keyword">const</span> cached <span class="token operator">=</span> globalSummaryCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="334"></td><td><pre>  <span class="token keyword">let</span> summaryResult <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="335"></td><td><pre>  <span class="token keyword">const</span> threshold <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span> <span class="token comment">// 阈值：500 字</span></pre></td></tr><tr><td data-num="336"></td><td><pre></pre></td></tr><tr><td data-num="337"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">&amp;&amp;</span> cached<span class="token punctuation">.</span>hash <span class="token operator">===</span> newHash<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="338"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Cache] 命中缓存，直接返回摘要"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="339"></td><td><pre>    <span class="token keyword">return</span> cached<span class="token punctuation">.</span>summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="340"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="341"></td><td><pre>  </pre></td></tr><tr><td data-num="342"></td><td><pre>  <span class="token comment">// 如果没有缓存或缓存中未保存原始文本，则直接重新生成全文摘要</span></pre></td></tr><tr><td data-num="343"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cached <span class="token operator">||</span> <span class="token operator">!</span>cached<span class="token punctuation">.</span>content<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="344"></td><td><pre>    hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 首次生成摘要或缓存中未保存原文本，生成全文摘要..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="345"></td><td><pre>    summaryResult <span class="token operator">=</span> <span class="token function">generateSummaryForContent</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> startMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="346"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="347"></td><td><pre>    <span class="token comment">// 进行文本差异比较</span></pre></td></tr><tr><td data-num="348"></td><td><pre>    <span class="token comment">// const diff = getDiff(cached.content, content);</span></pre></td></tr><tr><td data-num="349"></td><td><pre>    <span class="token comment">// const deletionDelta = diff.oldBlock.length - diff.newBlock.length;</span></pre></td></tr><tr><td data-num="350"></td><td><pre>    <span class="token comment">// const additionDelta = diff.newBlock.length - diff.oldBlock.length;</span></pre></td></tr><tr><td data-num="351"></td><td><pre>    <span class="token keyword">const</span> diff <span class="token operator">=</span> <span class="token function">getParagraphDiffs</span><span class="token punctuation">(</span>cached<span class="token punctuation">.</span>content<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="352"></td><td><pre>    <span class="token keyword">const</span> deletionDelta <span class="token operator">=</span> diff<span class="token punctuation">.</span>removed<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="353"></td><td><pre>    <span class="token keyword">const</span> additionDelta <span class="token operator">=</span> diff<span class="token punctuation">.</span>added<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="354"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>deletionDelta <span class="token operator">&gt;=</span> threshold <span class="token operator">&amp;&amp;</span> <span class="token function">isContinuous</span><span class="token punctuation">(</span>diff<span class="token punctuation">.</span>removed<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="355"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 检测到连续删除超过 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>threshold<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字: 删除了 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>deletionDelta<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="356"></td><td><pre>      <span class="token keyword">const</span> prompt <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请根据以下删除的文本内容调整原摘要，使摘要反映内容减少的情况，要求中文回答且尽可能简洁，字数请严格控制在300字以内，最终输出本文的概述：\n原摘要：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cached<span class="token punctuation">.</span>summary<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n删除的内容：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>diff<span class="token punctuation">.</span>removed<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="357"></td><td><pre>      summaryResult <span class="token operator">=</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="358"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>additionDelta <span class="token operator">&gt;=</span> threshold <span class="token operator">&amp;&amp;</span> <span class="token function">isContinuous</span><span class="token punctuation">(</span>diff<span class="token punctuation">.</span>added<span class="token punctuation">,</span> threshold<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="359"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 检测到连续新增超过 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>threshold<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字: 新增了 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>additionDelta<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 字</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="360"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[Summary] 新增内容：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>diff<span class="token punctuation">.</span>added<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="361"></td><td><pre>      <span class="token keyword">const</span> prompt <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">请根据以下新增的文本内容调整原摘要，使摘要补充新增内容，要求中文回答且尽可能简洁，字数请严格控制在300字以内，最终输出本文的概述：\n原摘要：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>cached<span class="token punctuation">.</span>summary<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n新增的内容：\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>diff<span class="token punctuation">.</span>added<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="362"></td><td><pre>      summaryResult <span class="token operator">=</span> <span class="token function">generateSummarySync</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="363"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="364"></td><td><pre>      hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 文本差异未达到阈值，返回原全文摘要"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="365"></td><td><pre>      summaryResult <span class="token operator">=</span> cached<span class="token punctuation">.</span>summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="366"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="367"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="368"></td><td><pre>  </pre></td></tr><tr><td data-num="369"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 摘要生成完成，更新缓存"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="370"></td><td><pre>  globalSummaryCache<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">summary</span><span class="token operator">:</span> summaryResult<span class="token punctuation">,</span> <span class="token literal-property property">hash</span><span class="token operator">:</span> newHash<span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> content <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="371"></td><td><pre>  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>dbFile<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>globalSummaryCache<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="372"></td><td><pre>  hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[Summary] 缓存已更新"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="373"></td><td><pre>  <span class="token keyword">return</span> summaryResult<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="374"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="375"></td><td><pre></pre></td></tr><tr><td data-num="376"></td><td><pre><span class="token comment">// ** 注册 Hexo Helper**</span></pre></td></tr><tr><td data-num="377"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"get_summary"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="378"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">postMessage</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token function">getContent</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">,</span> <span class="token string">"请为下述文章提供一份300字以内的简明摘要，要求中文回答且尽可能简洁："</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="379"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="380"></td><td><pre></pre></td></tr><tr><td data-num="381"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"get_introduce"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="382"></td><td><pre>  <span class="token keyword">return</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>introduce<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="383"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id7" data-title="old">
<figure class="highlight javascript"><figcaption data-lang="javascript"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token keyword">var</span> __create <span class="token operator">=</span> Object<span class="token punctuation">.</span>create<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">var</span> __defProp <span class="token operator">=</span> Object<span class="token punctuation">.</span>defineProperty<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">var</span> __getOwnPropDesc <span class="token operator">=</span> Object<span class="token punctuation">.</span>getOwnPropertyDescriptor<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">var</span> __getOwnPropNames <span class="token operator">=</span> Object<span class="token punctuation">.</span>getOwnPropertyNames<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">var</span> __getProtoOf <span class="token operator">=</span> Object<span class="token punctuation">.</span>getPrototypeOf<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">var</span> __hasOwnProp <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">var</span> <span class="token function-variable function">__copyProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> except<span class="token punctuation">,</span> desc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="8"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>from <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> from <span class="token operator">===</span> <span class="token string">"object"</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> from <span class="token operator">===</span> <span class="token string">"function"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> <span class="token function">__getOwnPropNames</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__hasOwnProp</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">!==</span> except<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">__defProp</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> from<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token punctuation">(</span>desc <span class="token operator">=</span> <span class="token function">__getOwnPropDesc</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> desc<span class="token punctuation">.</span>enumerable <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">return</span> to<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">var</span> <span class="token function-variable function">__toESM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">mod<span class="token punctuation">,</span> isNodeMode<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>target <span class="token operator">=</span> mod <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token function">__create</span><span class="token punctuation">(</span><span class="token function">__getProtoOf</span><span class="token punctuation">(</span>mod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">__copyProps</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">// If the importer is in node compatibility mode or this is not an ESM</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">// file that has been converted to a CommonJS file using a Babel-</span></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token comment">// compatible transform (i.e. "__esModule" has not been set), then set</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token comment">// "default" to the CommonJS "module.exports" for node compatibility.</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  isNodeMode <span class="token operator">||</span> <span class="token operator">!</span>mod <span class="token operator">||</span> <span class="token operator">!</span>mod<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> <span class="token function">__defProp</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">value</span><span class="token operator">:</span> mod<span class="token punctuation">,</span> <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">:</span> target<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="21"></td><td><pre>  mod</pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">var</span> import_node_fs <span class="token operator">=</span> <span class="token function">__toESM</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"node:fs"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">function</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token keyword">return</span> post<span class="token operator">?.</span>raw <span class="token operator">??</span> post<span class="token operator">?.</span>_content <span class="token operator">??</span> post<span class="token punctuation">.</span>content<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">let</span> db<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">function</span> <span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> content<span class="token punctuation">,</span> dbPath<span class="token punctuation">,</span> startMessage</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">"summary.json"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    db <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">"summary.json"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">"utf-8"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    db <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token keyword">const</span> config <span class="token operator">=</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> db<span class="token operator">?.</span><span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"undefined"</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> db<span class="token operator">?.</span><span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token operator">?.</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token keyword">return</span> db<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> db<span class="token operator">?.</span><span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        db<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        db<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>mode <span class="token operator">===</span> <span class="token string">"openai"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="46"></td><td><pre>      <span class="token keyword">const</span> <span class="token function-variable function">request</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>remote<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/v1/chat/completions</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="48"></td><td><pre>          <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">"POST"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="49"></td><td><pre>          <span class="token literal-property property">headers</span><span class="token operator">:</span> requestHeaders<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="50"></td><td><pre>          <span class="token literal-property property">body</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>requestBody<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="52"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"ERROR: Failed to get summary from Openai API"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>          <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="55"></td><td><pre>          response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token keyword">const</span> summary <span class="token operator">=</span> data<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="58"></td><td><pre>              db<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span> <span class="token operator">=</span> summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="60"></td><td><pre>              db <span class="token operator">??=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>              db<span class="token punctuation">[</span>path<span class="token punctuation">]</span> <span class="token operator">??=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>              db<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span> <span class="token operator">??=</span> <span class="token string">""</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>              db<span class="token punctuation">[</span>path<span class="token punctuation">]</span><span class="token punctuation">[</span>dbPath<span class="token punctuation">]</span> <span class="token operator">=</span> summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"summary.json"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">"requested.lock"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="67"></td><td><pre>              import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span><span class="token string">"requested.lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>            <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token keyword">return</span> summary<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      <span class="token keyword">const</span> <span class="token function-variable function">checkTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">waitTime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">"request.lock"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="75"></td><td><pre>          <span class="token keyword">if</span> <span class="token punctuation">(</span>import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">"requested.lock"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token function">setTimeout</span><span class="token punctuation">(</span>checkTime<span class="token punctuation">,</span> <span class="token number">1e3</span> <span class="token operator">*</span> waitTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>          <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="79"></td><td><pre>          import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"requested.lock"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>          <span class="token function">setTimeout</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token number">1e3</span> <span class="token operator">*</span> <span class="token number">2.5</span> <span class="token operator">*</span> waitTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>          import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span><span class="token string">"request.lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="83"></td><td><pre>          import_node_fs<span class="token punctuation">.</span>default<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">"request.lock"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>          <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="86"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      <span class="token keyword">const</span> requestHeaders <span class="token operator">=</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token string-property property">"Content-Type"</span><span class="token operator">:</span> <span class="token string">"application/json"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token literal-property property">Authorization</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Bearer </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>openai<span class="token punctuation">.</span>apikey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span></pre></td></tr><tr><td data-num="90"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>      <span class="token keyword">const</span> requestBody <span class="token operator">=</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token literal-property property">model</span><span class="token operator">:</span> <span class="token string">"gpt-3.5-turbo"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        <span class="token literal-property property">messages</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">role</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>startMessage<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>content<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token literal-property property">temperature</span><span class="token operator">:</span> <span class="token number">0.7</span></pre></td></tr><tr><td data-num="95"></td><td><pre>      <span class="token punctuation">}</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span>pricing <span class="token operator">===</span> <span class="token string">"trial"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="97"></td><td><pre>        hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Requesting OpenAI API... (3 RPM mode)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>        hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"It may take 20 minutes or more (depending on the number of articles, each one takes 25 seconds)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        <span class="token function">checkTime</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        hexo<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Requesting OpenAI API... (60 RPM mode)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>        <span class="token function">checkTime</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>      <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="106"></td><td><pre>  <span class="token punctuation">}</span></pre></td></tr><tr><td data-num="107"></td><td><pre><span class="token punctuation">}</span></pre></td></tr><tr><td data-num="108"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"get_summary"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="109"></td><td><pre>  <span class="token keyword">return</span> <span class="token function">postMessage</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token function">getContent</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">,</span> <span class="token string">"\u8BF7\u4E3A\u4E0B\u8FF0\u6587\u7AE0\u63D0\u4F9B\u4E00\u4EFD200\u5B57\u4EE5\u5185\u7684\u6982\u62EC\uFF0C\u4F7F\u7528\u4E2D\u6587\u56DE\u7B54\u4E14\u5C3D\u53EF\u80FD\u7B80\u6D01: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>hexo<span class="token punctuation">.</span>extend<span class="token punctuation">.</span>helper<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">"get_introduce"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></pre></td></tr><tr><td data-num="112"></td><td><pre>  <span class="token keyword">return</span> hexo<span class="token punctuation">.</span>theme<span class="token punctuation">.</span>config<span class="token punctuation">.</span>summary<span class="token punctuation">.</span>introduce<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="113"></td><td><pre><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></tbody></table></figure></div>
<p>对于 <code>themes\shokaX\layout\_partials\post\post.pug</code>  的代码，只是稍微修改，让 "自我介绍" 先显示。</p>
<div class="tab" data-id="id8" data-title="new">
<figure class="highlight pug"><figcaption data-lang="pug"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"tab active"</span> data<span class="token operator">-</span>id<span class="token operator">=</span><span class="token string">"summary"</span> data<span class="token operator">-</span>title<span class="token operator">=</span><span class="token string">"自我介绍"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>                    <span class="token tag">p</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        <span class="token punctuation">!=</span><span class="token code"> <span class="token function">get_introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"tab"</span> data<span class="token operator">-</span>id<span class="token operator">=</span><span class="token string">"summary"</span> data<span class="token operator">-</span>title<span class="token operator">=</span><span class="token string">"文章概括"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>                    <span class="token tag">p</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                        <span class="token punctuation">!=</span><span class="token code"> <span class="token function">get_summary</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span></span></pre></td></tr></tbody></table></figure></div>
<div class="tab" data-id="id8" data-title="old">
<figure class="highlight pug"><figcaption data-lang="pug"></figcaption><table><tbody><tr><td data-num="1"></td><td><pre><span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"tab"</span> data<span class="token operator">-</span>id<span class="token operator">=</span><span class="token string">"summary"</span> data<span class="token operator">-</span>title<span class="token operator">=</span><span class="token string">"自我介绍"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>                    <span class="token tag">p</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                        <span class="token punctuation">!=</span><span class="token code"> <span class="token function">get_introduce</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>                <span class="token tag">div<span class="token attributes"><span class="token punctuation">(</span><span class="token attr-name">class</span><span class="token punctuation">=</span><span class="token attr-value"><span class="token string">"tab active"</span> data<span class="token operator">-</span>id<span class="token operator">=</span><span class="token string">"summary"</span> data<span class="token operator">-</span>title<span class="token operator">=</span><span class="token string">"文章概括"</span></span><span class="token punctuation">)</span></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>                    <span class="token tag">p</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                        <span class="token punctuation">!=</span><span class="token code"> <span class="token function">get_summary</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span></span></pre></td></tr></tbody></table></figure></div>
<p>new1 和 new2 代码的不同在于，new1 不再将 Markdown 处理为 html 再提取文本，而是直接对 Markdown 原内容进行各种处理，防止了提取 html 文本会各种意想不到的标签问题。并且优化 <code>processLongContent</code>  函数，防止文章没有使用 <code>#</code> 没有分章节时的问题，现在可以处理没有章节的纯段落文章。</p>
<div class="tags"><a href="/miyano/tags/Blog/" rel="tag"><i class="ic i-tag"></i>Blog</a><a href="/miyano/tags/Hexo/" rel="tag"><i class="ic i-tag"></i>Hexo</a><a href="/miyano/tags/shokaX/" rel="tag"><i class="ic i-tag"></i>shokaX</a></div></div><footer><div class="meta"><span class="icon"><i class="ic i-eye"></i></span><span>此文章已被阅读次数:</span><span class="waline-pageview-count" id="twikoo_visitors" data-path="/Playful-Exploration/shokaX主题笔记/">正在加载...</span><span class="item"><span class="icon"><i class="ic i-calendar-check"></i></span><span class="text">更新于</span><time title="修改时间：2025-03-04 16:17:40" itemprop="dateModified" datetime="2025-03-04T16:17:40+08:00">2025-03-04</time></span></div><div id="copyright"><ul><li class="author"><strong>本文作者：</strong>Rei<i class="ic i-at"><em>@</em></i>自分の為に楽しめ世界</li><li class="link"><strong>本文链接：</strong><a href="https://ei4869.github.io/miyano/Playful-Exploration/shokaX%E4%B8%BB%E9%A2%98%E7%AC%94%E8%AE%B0/" title="shokaX主题-笔记">https://ei4869.github.io/miyano/Playful-Exploration/shokaX主题笔记/</a></li><li class="license"><strong>版权声明：</strong>本站所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/miyano/Scientific-Notes/Literature-Translation/2024-12-09-%E6%96%87%E7%8C%AE%E7%BF%BB%E8%AF%91-%E4%B8%83/" rel="prev" itemprop="url" data-background-image="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_24.webp" title="文献翻译(七)"><span class="type">上一篇</span><span class="category"><i class="ic i-flag"></i>文献翻译</span><h3>文献翻译(七)</h3></a></div><div class="item right"><a href="/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%B8%80)/" rel="next" itemprop="url" data-background-image="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/kon_25.webp" title="Escu:de汉化(一)——GBK编码"><span class="type">下一篇</span><span class="category"><i class="ic i-flag"></i>引擎汉化</span><h3>Escu:de汉化(一)——GBK编码</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><div class="toc-article" id="toc-div"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text"> 安装过程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">2.</span> <span class="toc-text"> 自动部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E7%BD%91%E7%AB%99%E8%BF%90%E8%A1%8C%E6%97%B6%E9%97%B4"><span class="toc-number">3.</span> <span class="toc-text"> 统计网站运行时间</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9B%B8%E5%86%8C%E5%8A%9F%E8%83%BD"><span class="toc-number">4.</span> <span class="toc-text"> 实现相册功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%86%8C%E4%B8%BB%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE"><span class="toc-number">4.1.</span> <span class="toc-text"> 相册主页面配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%B8%E5%86%8C%E5%AD%90%E9%A1%B5%E9%9D%A2%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.</span> <span class="toc-text"> 相册子页面配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B5%E9%9D%A2%E6%A0%87%E9%A2%98%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">5.</span> <span class="toc-text"> 页面标题自定义</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%AF%8F%E5%A4%A9%E9%9A%8F%E6%9C%BA%E4%B8%BB%E9%A2%98%E5%9B%BE%E7%89%87"><span class="toc-number">6.</span> <span class="toc-text"> 每天随机主题图片</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A2%9E%E6%94%B9%E4%B8%80%E4%BA%9B%E5%8F%82%E6%95%B0"><span class="toc-number">7.</span> <span class="toc-text"> 增改一些参数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4%E5%A4%B4%E5%9B%BE%E6%A8%A1%E7%B3%8A"><span class="toc-number">8.</span> <span class="toc-text"> 移除头图模糊</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%A4%B4%E5%9B%BE%E6%A8%B1%E8%8A%B1%E7%89%B9%E6%95%88"><span class="toc-number">9.</span> <span class="toc-text"> 增加头图樱花特效</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%9F%B3%E4%B9%90%E5%88%97%E8%A1%A8"><span class="toc-number">10.</span> <span class="toc-text"> 设置音乐列表</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%BF%BD%E7%95%AA%E9%A1%B5%E9%9D%A2"><span class="toc-number">11.</span> <span class="toc-text"> 设置追番页面</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E5%9B%BE%E7%89%87%E7%AE%A1%E7%90%86"><span class="toc-number">12.</span> <span class="toc-text"> 文章图片管理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%8A%80%E5%B7%A7"><span class="toc-number">13.</span> <span class="toc-text"> 调试技巧</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%97%E4%BD%93"><span class="toc-number">14.</span> <span class="toc-text"> 自定义字体</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%B9%E8%BF%9B%E6%90%9C%E7%B4%A2%E6%A0%8F"><span class="toc-number">15.</span> <span class="toc-text"> 改进搜索栏</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#fancybox%E4%BC%98%E5%8C%96"><span class="toc-number">16.</span> <span class="toc-text"> fancybox 优化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E5%8F%98%E9%87%8F%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="toc-number">16.1.</span> <span class="toc-text"> 增加变量的设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%B9%E8%BF%9Bfancyboxts"><span class="toc-number">16.2.</span> <span class="toc-text"> 改进 fancybox.ts</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%9D%97%E5%92%8Ctab%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98"><span class="toc-number">17.</span> <span class="toc-text"> 代码块和 tab 冲突问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E6%96%87%E7%AB%A0%E5%8A%A0%E5%AF%86%E6%8F%92%E4%BB%B6"><span class="toc-number">18.</span> <span class="toc-text"> 增加文章加密插件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0ai%E6%80%BB%E7%BB%93%E5%8A%9F%E8%83%BD"><span class="toc-number">19.</span> <span class="toc-text"> 增加 AI 总结功能</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8F%90%E5%8F%96%E4%B8%8E%E9%A2%84%E5%A4%84%E7%90%86%E6%96%87%E6%9C%AC"><span class="toc-number">19.1.</span> <span class="toc-text"> 提取与预处理文本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%AE%A1%E7%90%86"><span class="toc-number">19.2.</span> <span class="toc-text"> 缓存管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%95%BF%E6%96%87%E7%AB%A0%E5%A4%84%E7%90%86"><span class="toc-number">19.3.</span> <span class="toc-text"> 长文章处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ai-%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90%E7%AD%96%E7%95%A5"><span class="toc-number">19.4.</span> <span class="toc-text"> AI 摘要生成策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#api-%E8%B0%83%E7%94%A8%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">19.5.</span> <span class="toc-text"> API 调用与重试机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81%E7%94%9F%E6%88%90"><span class="toc-number">19.6.</span> <span class="toc-text"> 摘要生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hexo-helper-%E6%B3%A8%E5%86%8C"><span class="toc-number">19.7.</span> <span class="toc-text"> Hexo Helper 注册</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E4%BF%AE%E6%94%B9"><span class="toc-number">19.8.</span> <span class="toc-text"> 代码修改</span></a></li></ol></li></ol></div></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/miyano/Playful-Exploration/Butterfly%E4%B8%BB%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="bookmark" title="Butterfly主题笔记">Butterfly主题笔记</a></li><li><a href="/miyano/Playful-Exploration/2024-12-05-2dfan%E8%87%AA%E5%8A%A8%E7%AD%BE%E5%88%B0/" rel="bookmark" title="2dfan自动签到">2dfan自动签到</a></li><li class="active"><a href="/miyano/Playful-Exploration/shokaX%E4%B8%BB%E9%A2%98%E7%AC%94%E8%AE%B0/" rel="bookmark" title="shokaX主题-笔记">shokaX主题-笔记</a></li><li><a href="/miyano/Playful-Exploration/shokaX-%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA%E5%8F%8A%E6%9B%B4%E6%8D%A2/" rel="bookmark" title="shokaX-图床搭建及更换">shokaX-图床搭建及更换</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><img class="image" loading="lazy" decoding="async" itemprop="image" alt="Rei" src="https://miyano.oss-cn-wuhan-lr.aliyuncs.com/img/ai-icon.webp"><p class="name" itemprop="name">Rei</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/miyano/archives/"><span class="count">43</span><span class="name">文章</span></a></div><div class="item categories"><a href="/miyano/categories/"><span class="count">10</span><span class="name">分类</span></a></div><div class="item tags"><a href="/miyano/tags/"><span class="count">9</span><span class="name">标签</span></a></div></nav><div class="social"><a target="_blank" rel="noopener" href="https://github.com/ei4869" class="item github" title="https://github.com/ei4869"><i class="ic i-github"></i></a><a href="mailto:ai4869@gmail.com" class="item email" title="mailto:ai4869@gmail.com"><i class="ic i-envelope"></i></a></div><div class="menu"><li class="item"><a href="/miyano/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/miyano/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/miyano/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/miyano/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item dropdown"><a href="#" onclick="return false;"><i class="ic i-baibaoxiang"></i>宝箱</a><ul class="submenu"><li class="item"><a href="/miyano/gallery/" rel="section"><i class="ic i-xiangce"></i>相册</a></li><li class="item"><a href="/miyano/anime/" rel="section"><i class="ic i-pc-dongman"></i>追番</a></li></ul></li><li class="item"><a href="/miyano/about/" rel="section"><i class="ic i-user"></i>关于</a></li></div></div></div></div><ul id="quick"><li class="prev pjax"><a href="/miyano/Engine-Translation/Gal%E6%B1%89%E5%8C%96-Escude(%E4%B8%80)/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/miyano/Scientific-Notes/Literature-Translation/2024-12-09-%E6%96%87%E7%8C%AE%E7%BF%BB%E8%AF%91-%E4%B8%83/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Scientific-Notes/" title="分类于科研笔记">科研笔记</a><i class="ic i-angle-right"></i><a href="/miyano/categories/Scientific-Notes/Opening-Report/" title="分类于开题报告">开题报告</a></div><span><a href="/miyano/Scientific-Notes/Opening-Report/%E5%BC%80%E9%A2%98%E6%8A%A5%E5%91%8A-%E5%8F%82%E8%80%83%E8%AE%BA%E6%96%87(%E4%B8%89)/">开题报告-参考论文(三)</a></span></li><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Course-Study/" title="分类于课程学习">课程学习</a><i class="ic i-angle-right"></i><a href="/miyano/categories/Course-Study/FPGA/" title="分类于FPGA">FPGA</a></div><span><a href="/miyano/Course-Study/FPGA/FPGA%E5%AD%A6%E4%B9%A0(%E4%B8%89)-%E6%B5%81%E6%B0%B4%E7%81%AF%E8%AE%BE%E8%AE%A1/">FPGA学习(三)-流水灯设计</a></span></li><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Playful-Exploration/" title="分类于整活探索">整活探索</a></div><span><a href="/miyano/Playful-Exploration/Butterfly%E4%B8%BB%E9%A2%98%E7%AC%94%E8%AE%B0/">Butterfly主题笔记</a></span></li><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Course-Study/" title="分类于课程学习">课程学习</a><i class="ic i-angle-right"></i><a href="/miyano/categories/Course-Study/FPGA/" title="分类于FPGA">FPGA</a></div><span><a href="/miyano/Course-Study/FPGA/FPGA%E5%AD%A6%E4%B9%A0(%E4%B8%80)-%E5%85%88%E5%AF%BC%E7%9F%A5%E8%AF%86/">FPGA学习(一)-先导知识</a></span></li><li class="item"><div class="breadcrumb"><a href="/miyano/categories/Course-Study/" title="分类于课程学习">课程学习</a><i class="ic i-angle-right"></i><a href="/miyano/categories/Course-Study/Japanese/" title="分类于日语">日语</a></div><span><a href="/miyano/Course-Study/Japanese/%E5%88%9D%E7%BA%A7%E4%B8%8A-%E7%AC%AC3%E5%8D%95%E5%85%83/">单元三——小李在箱根</a></span></li></ul></div><div class="rpost pjax"><h2>最新评论</h2><ul class="leancloud-recent-comment" id="new-comment"></ul></div></div><div style="width: 100%; text-align: center;"><span id="time">此站已存活 0 天 0 小时 0 分 0 秒</span></div><script src="/miyano/js/create-time.js" defer="defer"></script><div class="status"><div class="copyright">© 2024 -<span itemprop="copyrightYear">2025</span><span class="with-love"><i class="ic i-sakura rotate"></i></span><span class="author" itemprop="copyrightHolder">Rei @ Rei の 手帳</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i></span><span title="站点总字数">598k 字</span><span class="post-meta-divider"> | </span><span class="post-meta-item-icon"><i class="ic i-coffee"></i></span><span title="站点阅读时长">9h4min</span></div><div class="powered-by">基于 <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> &amp; Theme.<a target="_blank" rel="noopener" href="https://github.com/theme-shoka-x/hexo-theme-shokaX/">ShokaX</a></div></div></div></footer></div><script data-config="" type="text/javascript">var LOCAL = {
    ispost: true,
        path: `Playful-Exploration/shokaX主题笔记/`,
        favicon: {
        show: `（●´3｀●）萌え萌えキュン`,
        hide: `(´Д｀)大変だ！`
    },
    search: {
        placeholder: "文章搜索",
        empty: "关于 「 ${query} 」，什么也没搜到",
        stats: "${time} ms 内找到 ${hits} 条结果"
    },
    copy_tex: false,
    katex: false,
    mermaid: false,
    audio: undefined,
    fancybox: true,
    justifiedGallery: true,
    jquery: true,
    nocopy: false,
    outime: true,
    template: `<div class="note warning"><p><span class="label warning">文章时效性提示</span><br>这是一篇发布于 {{publish}} 天前，最后一次更新在 {{updated}} 天前的文章，部分信息可能已经发生改变，请注意甄别。</p></div>`,
    quiz: {
        choice: `单选题`,
        multiple: `多选题`,
        true_false: `判断题`,
        essay: `问答题`,
        gap_fill: `填空题`,
        mistake: `错题备注`
    },
    ignores: [
        (uri) => uri.includes('#'),
        (uri) => new RegExp(LOCAL.path + '$').test(uri),
            []
    ]
};
</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-4H41ZSPP7G"></script><script data-pjax="data-pjax">window.dataLayer = window.dataLayer || [];
function gtag() {
    dataLayer.push(arguments);
}
gtag('js', new Date());
gtag('config', 'G-4H41ZSPP7G');</script><script src="https://s4.zstatic.net/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous" fetchpriority="high"></script><script src="https://s4.zstatic.net/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous" fetchpriority="high"></script><script src="/miyano/js/siteInit.js?v=0.4.17" type="module" fetchpriority="high" defer=""></script></body></html>